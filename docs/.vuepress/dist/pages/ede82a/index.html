<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C Sockets 编程 | Northboat</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.youngkbt.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <meta name="description" content="My Wiki">
    <meta name="keywords" content="Northboat, ComputerScience, DevOps, CyberSecurity">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.39b691be.css" as="style"><link rel="preload" href="/assets/js/app.7c57c868.js" as="script"><link rel="preload" href="/assets/js/3.e0c187c4.js" as="script"><link rel="preload" href="/assets/js/40.f0fb9086.js" as="script"><link rel="preload" href="/assets/js/84.9cf896f3.js" as="script"><link rel="prefetch" href="/assets/js/10.8b446fb8.js"><link rel="prefetch" href="/assets/js/100.9d428dc9.js"><link rel="prefetch" href="/assets/js/101.f26a212a.js"><link rel="prefetch" href="/assets/js/102.fc27f167.js"><link rel="prefetch" href="/assets/js/103.b0ca1e97.js"><link rel="prefetch" href="/assets/js/104.0f05380b.js"><link rel="prefetch" href="/assets/js/105.7b473a42.js"><link rel="prefetch" href="/assets/js/106.8455baab.js"><link rel="prefetch" href="/assets/js/107.f19977e1.js"><link rel="prefetch" href="/assets/js/108.c7190cd1.js"><link rel="prefetch" href="/assets/js/109.794bfaa7.js"><link rel="prefetch" href="/assets/js/11.db06f384.js"><link rel="prefetch" href="/assets/js/110.ffca72bb.js"><link rel="prefetch" href="/assets/js/111.8841c4bd.js"><link rel="prefetch" href="/assets/js/112.46561130.js"><link rel="prefetch" href="/assets/js/113.9d76a7cd.js"><link rel="prefetch" href="/assets/js/114.9c180cbe.js"><link rel="prefetch" href="/assets/js/115.ceae3a20.js"><link rel="prefetch" href="/assets/js/116.dd003d05.js"><link rel="prefetch" href="/assets/js/117.435af9b7.js"><link rel="prefetch" href="/assets/js/118.c42cd305.js"><link rel="prefetch" href="/assets/js/119.c757c23e.js"><link rel="prefetch" href="/assets/js/12.f902f760.js"><link rel="prefetch" href="/assets/js/120.bfd3b1b1.js"><link rel="prefetch" href="/assets/js/121.b3ecc9c0.js"><link rel="prefetch" href="/assets/js/122.8a4fee6c.js"><link rel="prefetch" href="/assets/js/123.df801efc.js"><link rel="prefetch" href="/assets/js/124.aced7a00.js"><link rel="prefetch" href="/assets/js/125.2d4b6d49.js"><link rel="prefetch" href="/assets/js/126.9c05d2d0.js"><link rel="prefetch" href="/assets/js/127.5cef6476.js"><link rel="prefetch" href="/assets/js/128.36053955.js"><link rel="prefetch" href="/assets/js/129.f5b5a3fe.js"><link rel="prefetch" href="/assets/js/13.accb642f.js"><link rel="prefetch" href="/assets/js/130.adcd0db6.js"><link rel="prefetch" href="/assets/js/131.9fc4f6cf.js"><link rel="prefetch" href="/assets/js/132.83bcd680.js"><link rel="prefetch" href="/assets/js/133.c4b183ca.js"><link rel="prefetch" href="/assets/js/134.42bb1ffb.js"><link rel="prefetch" href="/assets/js/135.f3966117.js"><link rel="prefetch" href="/assets/js/136.3e7fb66a.js"><link rel="prefetch" href="/assets/js/137.ed2514d9.js"><link rel="prefetch" href="/assets/js/138.e3810681.js"><link rel="prefetch" href="/assets/js/139.9e0f3e5b.js"><link rel="prefetch" href="/assets/js/14.c5f93160.js"><link rel="prefetch" href="/assets/js/140.2fe1b704.js"><link rel="prefetch" href="/assets/js/141.cd56aca7.js"><link rel="prefetch" href="/assets/js/142.311d69d6.js"><link rel="prefetch" href="/assets/js/143.f324b9ef.js"><link rel="prefetch" href="/assets/js/144.3d02bef9.js"><link rel="prefetch" href="/assets/js/145.57c15072.js"><link rel="prefetch" href="/assets/js/146.4be9fcd0.js"><link rel="prefetch" href="/assets/js/147.b511bb37.js"><link rel="prefetch" href="/assets/js/148.7b75149c.js"><link rel="prefetch" href="/assets/js/149.c119cf6d.js"><link rel="prefetch" href="/assets/js/15.e079046c.js"><link rel="prefetch" href="/assets/js/150.51462000.js"><link rel="prefetch" href="/assets/js/151.d4f9cc91.js"><link rel="prefetch" href="/assets/js/152.ee32104b.js"><link rel="prefetch" href="/assets/js/153.affd69f0.js"><link rel="prefetch" href="/assets/js/154.ae2a4226.js"><link rel="prefetch" href="/assets/js/155.c03781a6.js"><link rel="prefetch" href="/assets/js/156.f9a08eb0.js"><link rel="prefetch" href="/assets/js/157.fd11a2fd.js"><link rel="prefetch" href="/assets/js/158.8e1ce051.js"><link rel="prefetch" href="/assets/js/159.a1305817.js"><link rel="prefetch" href="/assets/js/16.6390e543.js"><link rel="prefetch" href="/assets/js/160.5c28958e.js"><link rel="prefetch" href="/assets/js/161.84686fe9.js"><link rel="prefetch" href="/assets/js/162.28a2072f.js"><link rel="prefetch" href="/assets/js/163.117abe35.js"><link rel="prefetch" href="/assets/js/164.8cc2b9b4.js"><link rel="prefetch" href="/assets/js/165.9a6ea5cc.js"><link rel="prefetch" href="/assets/js/166.3955fc54.js"><link rel="prefetch" href="/assets/js/167.c7218c4f.js"><link rel="prefetch" href="/assets/js/168.271174d5.js"><link rel="prefetch" href="/assets/js/169.a1ac1670.js"><link rel="prefetch" href="/assets/js/17.8ebb173d.js"><link rel="prefetch" href="/assets/js/170.da5147d5.js"><link rel="prefetch" href="/assets/js/171.f9fccc12.js"><link rel="prefetch" href="/assets/js/172.d77f375d.js"><link rel="prefetch" href="/assets/js/173.25f43e90.js"><link rel="prefetch" href="/assets/js/174.bfc6b7e0.js"><link rel="prefetch" href="/assets/js/175.43a7650e.js"><link rel="prefetch" href="/assets/js/176.e48ce552.js"><link rel="prefetch" href="/assets/js/177.e5fd3cd7.js"><link rel="prefetch" href="/assets/js/18.b64c4c5c.js"><link rel="prefetch" href="/assets/js/19.55dc87da.js"><link rel="prefetch" href="/assets/js/2.4eeb132c.js"><link rel="prefetch" href="/assets/js/20.cd755b6c.js"><link rel="prefetch" href="/assets/js/21.94d4481c.js"><link rel="prefetch" href="/assets/js/22.e9dc3796.js"><link rel="prefetch" href="/assets/js/23.bd1f8714.js"><link rel="prefetch" href="/assets/js/24.7b6750a2.js"><link rel="prefetch" href="/assets/js/25.066d11c5.js"><link rel="prefetch" href="/assets/js/26.249cedfe.js"><link rel="prefetch" href="/assets/js/27.ea74c083.js"><link rel="prefetch" href="/assets/js/28.59749eb0.js"><link rel="prefetch" href="/assets/js/29.85ceab8b.js"><link rel="prefetch" href="/assets/js/30.99c05562.js"><link rel="prefetch" href="/assets/js/31.cac4b1ce.js"><link rel="prefetch" href="/assets/js/32.2e2be4b1.js"><link rel="prefetch" href="/assets/js/33.a743588d.js"><link rel="prefetch" href="/assets/js/34.7139dcee.js"><link rel="prefetch" href="/assets/js/35.1d274260.js"><link rel="prefetch" href="/assets/js/36.46d12ee0.js"><link rel="prefetch" href="/assets/js/37.b0238cfc.js"><link rel="prefetch" href="/assets/js/38.c13b9ba5.js"><link rel="prefetch" href="/assets/js/39.ab0caa26.js"><link rel="prefetch" href="/assets/js/4.6e3273d6.js"><link rel="prefetch" href="/assets/js/41.0777b9c7.js"><link rel="prefetch" href="/assets/js/42.bb608400.js"><link rel="prefetch" href="/assets/js/43.3fe39c35.js"><link rel="prefetch" href="/assets/js/44.132f7ba5.js"><link rel="prefetch" href="/assets/js/45.99d6aff6.js"><link rel="prefetch" href="/assets/js/46.a1cbc238.js"><link rel="prefetch" href="/assets/js/47.0ca54e39.js"><link rel="prefetch" href="/assets/js/48.b84b247d.js"><link rel="prefetch" href="/assets/js/49.5ff8cdb5.js"><link rel="prefetch" href="/assets/js/5.0b35d4d2.js"><link rel="prefetch" href="/assets/js/50.98c0b12d.js"><link rel="prefetch" href="/assets/js/51.884571c0.js"><link rel="prefetch" href="/assets/js/52.e3d8fa57.js"><link rel="prefetch" href="/assets/js/53.60eb6a0e.js"><link rel="prefetch" href="/assets/js/54.d69be2f8.js"><link rel="prefetch" href="/assets/js/55.38842f6a.js"><link rel="prefetch" href="/assets/js/56.5fdf5a13.js"><link rel="prefetch" href="/assets/js/57.07e189aa.js"><link rel="prefetch" href="/assets/js/58.f7abe603.js"><link rel="prefetch" href="/assets/js/59.5a6816ba.js"><link rel="prefetch" href="/assets/js/6.d18fd2c3.js"><link rel="prefetch" href="/assets/js/60.62f4f38a.js"><link rel="prefetch" href="/assets/js/61.38501521.js"><link rel="prefetch" href="/assets/js/62.5177da26.js"><link rel="prefetch" href="/assets/js/63.46f817a7.js"><link rel="prefetch" href="/assets/js/64.97a28560.js"><link rel="prefetch" href="/assets/js/65.ee611b31.js"><link rel="prefetch" href="/assets/js/66.0f69b459.js"><link rel="prefetch" href="/assets/js/67.410494a2.js"><link rel="prefetch" href="/assets/js/68.8f136f88.js"><link rel="prefetch" href="/assets/js/69.aa93a998.js"><link rel="prefetch" href="/assets/js/7.2f5c089e.js"><link rel="prefetch" href="/assets/js/70.f19c22ce.js"><link rel="prefetch" href="/assets/js/71.bad23b3f.js"><link rel="prefetch" href="/assets/js/72.e56642e2.js"><link rel="prefetch" href="/assets/js/73.95716e3c.js"><link rel="prefetch" href="/assets/js/74.7ba73646.js"><link rel="prefetch" href="/assets/js/75.761fda59.js"><link rel="prefetch" href="/assets/js/76.8891e6df.js"><link rel="prefetch" href="/assets/js/77.2afc8ea1.js"><link rel="prefetch" href="/assets/js/78.5325feba.js"><link rel="prefetch" href="/assets/js/79.a60aab79.js"><link rel="prefetch" href="/assets/js/8.6849a1fe.js"><link rel="prefetch" href="/assets/js/80.86f905f7.js"><link rel="prefetch" href="/assets/js/81.cd2fa884.js"><link rel="prefetch" href="/assets/js/82.4d41a346.js"><link rel="prefetch" href="/assets/js/83.b2b35bd6.js"><link rel="prefetch" href="/assets/js/85.5f987424.js"><link rel="prefetch" href="/assets/js/86.5aa28ec2.js"><link rel="prefetch" href="/assets/js/87.461a385b.js"><link rel="prefetch" href="/assets/js/88.c7c1e9c7.js"><link rel="prefetch" href="/assets/js/89.8a2b6a89.js"><link rel="prefetch" href="/assets/js/9.8da42e60.js"><link rel="prefetch" href="/assets/js/90.4d38ecdd.js"><link rel="prefetch" href="/assets/js/91.716956ae.js"><link rel="prefetch" href="/assets/js/92.967a9b40.js"><link rel="prefetch" href="/assets/js/93.db102d93.js"><link rel="prefetch" href="/assets/js/94.f2a90f3b.js"><link rel="prefetch" href="/assets/js/95.1972b8ee.js"><link rel="prefetch" href="/assets/js/96.b80a546c.js"><link rel="prefetch" href="/assets/js/97.3836e0e5.js"><link rel="prefetch" href="/assets/js/98.77f44ee0.js"><link rel="prefetch" href="/assets/js/99.ad60d639.js">
    <link rel="stylesheet" href="/assets/css/0.styles.39b691be.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Northboat" class="logo"> <span class="site-name can-hide">Northboat</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/cs/" class="nav-link">计算机科学与技术</a></div><div class="nav-item"><a href="/dev/" class="nav-link">开发与运维</a></div><div class="nav-item"><a href="/sec/" class="nav-link">网络与信息安全</a></div><div class="nav-item"><a href="/mine/" class="nav-link">我的</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/Northboat" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.png"> <div class="blogger-info"><h3>Northboat</h3> <span>就在坚冰还盖着北海的时候，我看到了怒放的梅花</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/cs/" class="nav-link">计算机科学与技术</a></div><div class="nav-item"><a href="/dev/" class="nav-link">开发与运维</a></div><div class="nav-item"><a href="/sec/" class="nav-link">网络与信息安全</a></div><div class="nav-item"><a href="/mine/" class="nav-link">我的</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/Northboat" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>组成原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>计网与操作系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>计算机网络基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/7aaaab/" class="sidebar-link">计网体系结构和物理层</a></li><li><a href="/pages/87aeeb/" class="sidebar-link">数据链路功能</a></li><li><a href="/pages/96ce78/" class="sidebar-link">局域网和广域网</a></li><li><a href="/pages/68132e/" class="sidebar-link">网络层功能及路由</a></li><li><a href="/pages/8be274/" class="sidebar-link">IP 协议</a></li><li><a href="/pages/9470a3/" class="sidebar-link">传输层和应用层</a></li><li><a href="/pages/ede82a/" aria-current="page" class="active sidebar-link">C Sockets 编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/ede82a/#计算机网络简述" class="sidebar-link">计算机网络简述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#网络、分组和协议" class="sidebar-link">网络、分组和协议</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#地址和域名" class="sidebar-link">地址和域名</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#客户与服务器" class="sidebar-link">客户与服务器</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#套接字" class="sidebar-link">套接字</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ede82a/#tcp-套接字" class="sidebar-link">TCP 套接字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#ipv4-tcp-客户和服务器" class="sidebar-link">IPv4 TCP 客户和服务器</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#ipv6-tcp-客户和服务器" class="sidebar-link">IPv6 TCP 客户和服务器</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ede82a/#域名和协议族" class="sidebar-link">域名和协议族</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#将名称映射到数字" class="sidebar-link">将名称映射到数字</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#通用的-tcp-客户" class="sidebar-link">通用的 TCP 客户</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#通用的-tcp-服务器" class="sidebar-link">通用的 TCP 服务器</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#从数字获取名称" class="sidebar-link">从数字获取名称</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ede82a/#udp-套接字" class="sidebar-link">UDP 套接字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#udp-客户" class="sidebar-link">UDP 客户</a></li><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#udp-服务器" class="sidebar-link">UDP 服务器</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ede82a/#发送、接收数据封装" class="sidebar-link">发送、接收数据封装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ede82a/#整数编码" class="sidebar-link">整数编码</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ede82a/#超越基本的套接字编程" class="sidebar-link">超越基本的套接字编程</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>操作系统基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>汇编程序设计与编译原理</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/cs/#计算机科学与技术" data-v-06970110>计算机科学与技术</a></li><li data-v-06970110><a href="/cs/#计网与操作系统" data-v-06970110>计网与操作系统</a></li><li data-v-06970110><a href="/cs/#计算机网络基础" data-v-06970110>计算机网络基础</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/Northboat" target="_blank" title="作者" class="beLink" data-v-06970110>Northboat</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2022-7-21</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">C Sockets 编程<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>《TCP/IP Sockets in C》第二版 from 覃辉</p> <h2 id="计算机网络简述"><a href="#计算机网络简述" class="header-anchor">#</a> 计算机网络简述</h2> <h3 id="网络、分组和协议"><a href="#网络、分组和协议" class="header-anchor">#</a> 网络、分组和协议</h3> <p>网络由主机和路由器构成</p> <ul><li>主机（host），是运行应用程序的计算机，是网络的真正“用户”</li> <li>路由器（router），也成网关（gateway），其职责是将信息从一条通信信道转发到另一条通信信道，通常不会运行应用程序</li> <li>通信信道（communication channel），是把字节序列从主机转送到另一台主机的通道，可以是有线的以太网，也可是无线的 WIFI</li></ul> <p>分组：由程序构造和解释的字节序列（信息），包含用于执行其任务的空值信息和用户数据。路由器使用这些控制信息查明如何转发每个分组</p> <p>协议：关于由通信程序交换的分组及其含义的协定。协议说明如何构造分组、如何解释信息</p> <h3 id="地址和域名"><a href="#地址和域名" class="header-anchor">#</a> 地址和域名</h3> <p>地址：<code>IP:端口</code></p> <p>IP地址：IPv4 / IPv6</p> <p>端口号：1-65535</p> <p>特殊地址</p> <ul><li>本机地址：127.0.0.1 / 0:0:0:0:0:0:0:1</li> <li>特殊用途预留：10开头 / 192.168开头 / 172开头且第二个数字在16-31之间（IPv4）</li></ul> <p>域名：<code>www.baidu.com</code></p> <p>需要明确的是，Internet 协议处理的是地址，而非域名，所以接收到域名时，要首先解析为地址，再进行处理，这个额外步骤是值得的，因为</p> <ul><li>便于记忆</li> <li>提供了某种级别的间接性：如一级域名、二级域名，而不是毫无意义的 IP 地址</li></ul> <p>什么是 URL，与域名的区别是什么？</p> <ul><li>资源定位器：Universal Resource Locator</li> <li>一般来说，域名指的是一个网站的顶级域名，而 URL 指向某个网站或网页的地址</li> <li>URL 中总是包含域名</li></ul> <p>如何解析域名？</p> <ul><li>DNS：Domain Name System</li> <li>本地配置数据库</li></ul> <h3 id="客户与服务器"><a href="#客户与服务器" class="header-anchor">#</a> 客户与服务器</h3> <p>就像打电话。客户程序发起通信，服务器程序被动等待，然后相应它的客户，二者共同构成应用程序</p> <p>使用 Sockets API 与其对应方建立通信的的一般形式决定该程序是充当客户还是服务器</p> <p>二者的区别还是很明显的，如打电话的一方（客户）需要知道被打电话一方（服务器）的手机号（地址），而被打电话的一方不需要，但在通信建立后，如果需要，也可以获取打电话一方的手机号。需要注意的是，一旦连接建立，服务器和客户之间的区别的就消失了</p> <ul><li>总结来说，客户与服务器的区别只在于谁建立初始连接和谁等待连接</li></ul> <p>服务器的端口分配遵循 IANA 的分配方式（Internet Assigned Number Authority，Internet编号授权委员会），如 80 分给 HTTP，443 分给 HTTPS，应答协议端口 7</p> <h3 id="套接字"><a href="#套接字" class="header-anchor">#</a> 套接字</h3> <p>套接字即 Sockets，应用程序通过它发送和接收数据，它允许应用程序插入到网络中并与插入到同一个网络的其他应用程序进行通信</p> <p>套接字是一个抽象层，是一组 API，应用程序通过这组 API 在计算机端口上进行一系列数据交换</p> <ul><li>需要注意的是，一个应用程序可以连接多个套接字，多个应用程序也可以连接同一个套接字（很少但存在），即同时有一对一、一对多、多对一的连接模式存在</li></ul> <p>其过程基本为，机 A 通过套接字程序将信息写入套接字服务器 W，机 B 从套接字服务器 W 获取机 A 写入的数据</p> <p>协议：TCP/IP 协议族</p> <p>套接字类型：流套接字（stream socket）/ 数据报套接字（datagram socket），分别对应 TCP 和 UDP 协议</p> <h2 id="tcp-套接字"><a href="#tcp-套接字" class="header-anchor">#</a> TCP 套接字</h2> <h3 id="ipv4-tcp-客户和服务器"><a href="#ipv4-tcp-客户和服务器" class="header-anchor">#</a> IPv4 TCP 客户和服务器</h3> <p>IPv4 TCP 客户</p> <p>Practical.h</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;DieWithMessage.c&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;SocketAddrUtility.c&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;TCPServerUtility.c&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;TCPClientUtility.c&quot;</span></span>
</code></pre></div><p>DieWithMessage.c</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>detail<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;: &quot;</span><span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>detail<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TCPEchoClient4.c</p> <ul><li>使用函数 socket() 创建套接字，创建用于 IPv4 的基于流（stream）的 TCP 协议的套接字，即客户，其返回值为一个整数，可以视作该 socket 的编号（端口号）</li> <li>sockaddr_in 结构体用于存放服务器地址，并进行填充，即设置地址族、Internet 地址和端口号
<ul><li>sin_family 设置地址族</li> <li>inet_pton() 函数用于设置 Internet IP 地址的字符串，如 127.0.0.1，设置的值为 servAddr.sin_addr.s_addr，该函数需要指定协议族</li> <li>htons() 设置端口号，这里对端口号进行了二进制格式化处理</li></ul></li> <li>通过 connect() 函数建立第一步创建的 sock 和第二步设置的服务器地址之间的连接（三次握手）</li> <li>建立连接后，使用 send() 函数向服务器发送字符串，需要指明字符串和其起始位置，若成功将返回发送数据长度</li> <li>使用 recv() 函数接收服务器应答，需要传入 socket，一个用于接收字符串的 char 型数组 buffer，以及字符串的起始位置<code>[0, buffer.length)</code> <ul><li>注意这里用一个 while 循环接收数据直到整个字符串返回，这是因为 TCP 是字节流协议，服务器的 send() 的字节可能不会因为本地的一次 recv() 而全部返回，所以需要反复接收</li></ul></li> <li>使用 close() 函数销毁 socket，这个函数在包 unistd.h 中</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Practical.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// printf(&quot;hahaha&quot;); </span>
    <span class="token comment">// argc = 3;</span>
    <span class="token comment">// argv[1] = &quot;127.0.0.1&quot;;</span>
    <span class="token comment">// argv[2] = &quot;hello&quot;;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">3</span> <span class="token operator">||</span> argc<span class="token operator">&gt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Server Address&gt; &lt;Echo Word&gt; [&lt;Server Port&gt;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>servIP <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>echoString <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// cout &lt;&lt; servIP &lt;&lt; endl &lt;&lt; echoString &lt;&lt; endl;</span>

    <span class="token class-name">in_port_t</span> servPort <span class="token operator">=</span> <span class="token punctuation">(</span>argc<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token comment">// cout &lt;&lt; servPort;</span>
    
    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servAddr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>

    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> servIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;inet_pton() failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;invalid address string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;inet_pton() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    servAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>servPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;connect() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">size_t</span> echoStringLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>echoString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ssize_t</span> numBytes <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> echoString<span class="token punctuation">,</span> echoStringLen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;send unexpedted number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> totalBytesRcvd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;Received: &quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>totalBytesRcvd <span class="token operator">&lt;</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// printf(&quot;hahaha&quot;);</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
        numBytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUFSIZ<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;connection closed prematurely&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        totalBytesRcvd <span class="token operator">+=</span> numBytes<span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>numBytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在运行时传入参数 IP 、数据以及端口，如</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./TCPEchoClient4 <span class="token number">127.0</span>.0.1 <span class="token string">&quot;Hello&quot;</span> <span class="token number">10086</span>
</code></pre></div><p>IPv4 TCP 服务器</p> <p>TCPServerUtility.c：处理服务器接收到的数据</p> <ul><li>传入的 clntSocket 为客户 socket 的编号</li> <li>buffer 字符数组用以缓冲接收客户发送的信息</li> <li>使用 recv() 函数接收一次客户数据，若接收数据字节不为空，进入循环</li> <li>在循环中，交替进行 send 和 recv 的操作，即发回客户传入的信息，同时接收客户的信息，直到客户传入的字节流为空
<ul><li>需要注意的是，不管是 send 还是 recv 操作，只需要一个 socket 就能进行，这是因为客户的 socket 已经和服务端的 socket 进行过连接，即 connect，这条信道是唯一的，而发送和接收的主体为当前执行代码的机器</li> <li>这也进一步印证了，当通信建立之后，客户和服务器的区分将变得模糊</li></ul></li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">//close</span></span>

<span class="token keyword">void</span> <span class="token function">HandleTCPClient</span><span class="token punctuation">(</span><span class="token keyword">int</span> clntSocket<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token class-name">ssize_t</span> numBytesRcvd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>clntSocket<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesRcvd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>numBytesRcvd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ssize_t</span> numBytesSent <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>clntSocket<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> numBytesRcvd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesSent <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesRcvd <span class="token operator">!=</span> numBytesSent<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sent unexpected number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        numBytesRcvd <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>clntSocket<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesRcvd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>clntSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TCPEchoServer4.c</p> <ul><li><p>通过传入的端口参数使用 socket() 创建一个套接字作为服务端口</p></li> <li><p>填充第一步创建的端点接口</p> <ul><li>地址族</li> <li>地址（IP），直接设置 servAddr.sin_addr.s_addr = htonl(INADDR_ANY)，因为我们不关心服务器的 IP 地址，所以直接设置其为地址通配符 inaddr any</li> <li>端口，htons() 设置传入的端口参数</li></ul></li> <li><p>使用 bind() 函数绑定第一步创建的套接字和第二步创建的端点接口，即指定该端点为服务器的 socket</p></li> <li><p>调用 listen() 函数对服务端端口 socket 进行监听，可设置最大连接数 maxpending</p></li> <li><p>在反复处理进入的连接</p> <ul><li><p>sockaddr_in 结构体 clntAddr 用于储存客户 socket 地址</p></li> <li><p>accept() 函数接收客户 socket，第一个参数为接收连接的 socket，第二个参数为 sockaddr_in 用于储存进入的 socket 地址，第三个参数为进入的 socket 地址长度</p> <p>accept() 一旦成功，clntAddr 中将包含客户的 Internet 地址和端口，并将地址长度写入 accept 的第三个参数</p></li> <li><p>使用 inet_ntop 和 ntohs 处理客户地址、端口的二进制码，转化为点分四组格式的字符串，用以输出</p> <p>这种转化和 inet_pton / htons 是相反的</p></li></ul></li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Practical.h&quot;</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> MAXPENDING <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Server Port&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">in_port_t</span> servPort <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> servSock<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>servSock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servAddr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>servPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;bind() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> MAXPENDING<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;listen() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// while(1)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clntAddr<span class="token punctuation">;</span>
        <span class="token class-name">socklen_t</span> clntAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> clntSock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span>  <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>clntSock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;accept() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">char</span> clntName<span class="token punctuation">[</span>INET_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> clntName<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Handling client %s:%d\n&quot;</span><span class="token punctuation">,</span> clntName<span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to get client address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">HandleTCPClient</span><span class="token punctuation">(</span>clntSock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>指定端口运行 Server</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./TCPEchoServer4 <span class="token number">10086</span>
</code></pre></div><h3 id="ipv6-tcp-客户和服务器"><a href="#ipv6-tcp-客户和服务器" class="header-anchor">#</a> IPv6 TCP 客户和服务器</h3> <p>IPv6 TCP 客户</p> <p>TCPEchoClient6.c</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Practical.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// printf(&quot;hahaha&quot;); </span>
    <span class="token comment">// argc = 3;</span>
    <span class="token comment">// argv[1] = &quot;127.0.0.1&quot;;</span>
    <span class="token comment">// argv[2] = &quot;hello&quot;;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">3</span> <span class="token operator">||</span> argc<span class="token operator">&gt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Server Address&gt; &lt;Echo Word&gt; [&lt;Server Port&gt;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>servIP <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>echoString <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// cout &lt;&lt; servIP &lt;&lt; endl &lt;&lt; echoString &lt;&lt; endl;</span>

    <span class="token class-name">in_port_t</span> servPort <span class="token operator">=</span> <span class="token punctuation">(</span>argc<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token comment">// cout &lt;&lt; servPort;</span>
    
    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> servAddr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span>

    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> servIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;inet_pton() failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;invalid address string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;inet_pton() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    servAddr<span class="token punctuation">.</span>sin6_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>servPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;connect() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">size_t</span> echoStringLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>echoString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ssize_t</span> numBytes <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> echoString<span class="token punctuation">,</span> echoStringLen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;send unexpedted number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> totalBytesRcvd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;Received: &quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>totalBytesRcvd <span class="token operator">&lt;</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// printf(&quot;hahaha&quot;);</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
        numBytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUFSIZ<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;connection closed prematurely&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        totalBytesRcvd <span class="token operator">+=</span> numBytes<span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>numBytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改的地方：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> servAddr<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
servAddr<span class="token punctuation">.</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span>
<span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> servIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
servAddr<span class="token punctuation">.</span>sin6_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>servPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 八个数</span>
./TCPEchoClient6 <span class="token number">0</span>:0:0:0:0:0:0:1 <span class="token string">&quot;hello&quot;</span> <span class="token number">9999</span>
</code></pre></div><p>IPv6 TCP 服务器</p> <p>TCPEchoServer4.c</p> <ul><li>bind() failed: Address family not supported by protocol</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Practical.h&quot;</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> MAXPENDING <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Server Port&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">in_port_t</span> servPort <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> servSock<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>servSock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> servAddr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin6_addr <span class="token operator">=</span> in6addr_any<span class="token punctuation">;</span>
    servAddr<span class="token punctuation">.</span>sin6_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>servPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;bind() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> MAXPENDING<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;listen() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// while(1)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> clntAddr<span class="token punctuation">;</span>
        <span class="token class-name">socklen_t</span> clntAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> clntSock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span>  <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>clntSock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;accept() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">char</span> clntName<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">,</span> clntName<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Handling client %s:%d\n&quot;</span><span class="token punctuation">,</span> clntName<span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">.</span>sin6_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to get client address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">HandleTCPClient</span><span class="token punctuation">(</span>clntSock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和 TCPEchoServer4 很像，修改的地方有</p> <p>serverSocket 要指定使用 IPv6 地址</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> servSock<span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>servSock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>servAddr 的构造，使用 IPv6 协议族</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> servAddr<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
servAddr<span class="token punctuation">.</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span>
servAddr<span class="token punctuation">.</span>sin6_addr <span class="token operator">=</span> in6addr_any<span class="token punctuation">;</span>
servAddr<span class="token punctuation">.</span>sin6_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>servPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>同理，接收到的 socket 地址传参也要相应改变</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> clntAddr<span class="token punctuation">;</span>
    <span class="token comment">//...</span>
	<span class="token keyword">char</span> clntName<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">,</span> clntName<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Handling client %s:%d\n&quot;</span><span class="token punctuation">,</span> clntName<span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">.</span>sin6_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to get client address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
</code></pre></div><p>这里的端口仍为十进制，懂？只有 IP 地址区分 IPv4 和IPv6，端口仍是1-65535</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./TCPEchoServer6 <span class="token number">9999</span>
</code></pre></div><h2 id="域名和协议族"><a href="#域名和协议族" class="header-anchor">#</a> 域名和协议族</h2> <h3 id="将名称映射到数字"><a href="#将名称映射到数字" class="header-anchor">#</a> 将名称映射到数字</h3> <p>addrinfo 的结构如下</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ai_flags<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_family<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_socktype<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_protocol<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> ai_addrlen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span> ai_addr<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>AddressUtility.c</p> <ul><li><p>打印地址信息结构体 socketaddr</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>
<span class="token punctuation">{</span>
  <span class="token function">__SOCKADDR_COMMON</span> <span class="token punctuation">(</span>sa_<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* Common data: address family and length.  */</span>
  <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* Address data.  */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name function">__SOCKADDR_COMMON</span><span class="token expression"><span class="token punctuation">(</span>sa_prefix<span class="token punctuation">)</span> <span class="token class-name">sa_family_t</span> sa_prefix</span><span class="token punctuation">##</span><span class="token expression">family</span></span>
</code></pre></div></li> <li><p>将根据 socketaddr.sa_family 判断是 IPv4/IPv6，并作出不同处理，给空指针 numericAddress 赋予不同类型的值</p></li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">PrintSocketAddress</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>address<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> stream <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>numericAddress<span class="token punctuation">;</span>
    <span class="token keyword">char</span> addrBuffer<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">in_port_t</span> port<span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>address<span class="token operator">-&gt;</span>sa_family<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> AF_INET<span class="token operator">:</span>
            numericAddress <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span> address<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">;</span>
            port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span> address<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AF_INET6<span class="token operator">:</span>
            numericAddress <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span> address<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">;</span>
            port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span> address<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> sin6_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;[unknown type]&quot;</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>address<span class="token operator">-&gt;</span>sa_family<span class="token punctuation">,</span> numericAddress<span class="token punctuation">,</span> addrBuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;[invalid address]&quot;</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> addrBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>port <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token string">&quot;-%u&quot;</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>GetAddrInfo.c</p> <ul><li>其实很简单，就是调用 netdb 库中 getaddrInfo() 函数获取<code>IP/域名+端口/服务</code>信息，传入参数依次为 IP/域名、端口/服务、用于储存当前信息的结构体 addrinfo、用于储存所有信息的链表 addrinfo</li> <li>PrintSocketAddress() 用以打印获取到的地址信息</li></ul> <div class="language-c extra-class"><pre class="language-c"><code>include <span class="token operator">&lt;</span>netdb<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../util/Practical.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">// 检查参数长度</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Address/Name&gt; &lt;Port/Service&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>addrString <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>portString <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> addrCriteria<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrCriteria<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span>
    <span class="token comment">// printf(&quot;hahaha\n&quot;);</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>addrList<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>addrString<span class="token punctuation">,</span> portString<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;getaddrinfo() failed&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rtnVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>addr<span class="token operator">=</span>addrList<span class="token punctuation">;</span> addr<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> addr<span class="token operator">=</span>addr<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">PrintSocketAddress</span><span class="token punctuation">(</span>addr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>addrList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>./GetAddrInfo <span class="token number">127.0</span>.0.1 <span class="token function">time</span>
<span class="token number">127.0</span>.0.1-37

./GetAddrInfo www.baidu.com <span class="token function">time</span>
<span class="token number">183.232</span>.231.174-37
<span class="token number">183.232</span>.231.172-37

./GetAddrInfo www.bilibili.com <span class="token function">time</span>
<span class="token number">117.169</span>.96.198-37
<span class="token number">117.169</span>.96.199-37
<span class="token number">111.48</span>.57.44-37
<span class="token number">111.48</span>.57.46-37
<span class="token number">111.48</span>.57.45-37
<span class="token number">117.169</span>.96.200-37
<span class="token number">2409</span>:8c38:c40:100::243-37
<span class="token number">2409</span>:8c38:c40:100::242-37
<span class="token number">2409</span>:8c4c:c00:9::23-37
<span class="token number">2409</span>:8c4c:c00:9::22-37
<span class="token number">2409</span>:8c4c:c00:9::24-37
<span class="token number">2409</span>:8c38:c40:100::241-37
</code></pre></div><h3 id="通用的-tcp-客户"><a href="#通用的-tcp-客户" class="header-anchor">#</a> 通用的 TCP 客户</h3> <p>通用指地址通用，什么是地址通用？如以上的 PrintSocketAddress() 函数就是一个 IPv4 和 IPv6 通用的代码，他会根据进入 socketaddr 的协议族判断其地址类型并作出相应反应</p> <p>接下来，我们将重写 TCP 协议下的 Socket 客户和服务器，使之地址通用，拥有自选共能</p> <p>TCPClientUtility.c</p> <ul><li>实现 SetupTCPClientSocket 方法，传入主机名（IP/域名）和服务（服务名/端口号），与之建立连接，返回建立好的 socket 套接字编号</li> <li>这里会持续搜索服务器端口直到建立连接或全部搜索完，失败将返回 -1</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">SetupTCPClientSocket</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> addrCriteria<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrCriteria<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servAddr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;getaddrinfo() failed&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rtnVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>addr <span class="token operator">=</span> servAddr<span class="token punctuation">;</span> addr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> addr <span class="token operator">=</span> addr<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span><span class="token punctuation">{</span>
        sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>addr<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> addr<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> addr<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// connet 返回 0 表示 socket 创建成功，返回 socket 编码</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> addr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> addr<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TCPEchoClient.c</p> <ul><li>与特定客户中建立 socket 的方法不一样，其余完全保持一致</li> <li>在原先的 TCPEchoClient4.c 中，是先建立一个空的 socket，然后填充服务器信息，最后使用 connect 函数对 socket 和服务器进行连接</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../util/Practical.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">3</span> <span class="token operator">||</span> argc<span class="token operator">&gt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Server Address&gt; &lt;Echo Word&gt; [&lt;Server Port&gt;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>server <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>echoString <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// cout &lt;&lt; servIP &lt;&lt; endl &lt;&lt; echoString &lt;&lt; endl;</span>

    <span class="token comment">// echo 应答程序的端口默认为7</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        service <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        service <span class="token operator">=</span> <span class="token string">&quot;echo&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">SetupTCPClientSocket</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;SetupTCPClientSocket() failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unable to connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token class-name">size_t</span> echoStringLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>echoString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> numBytes <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> echoString<span class="token punctuation">,</span> echoStringLen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;send()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;send unexpedted number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> totalBytesRcvd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;Received: &quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>totalBytesRcvd <span class="token operator">&lt;</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// printf(&quot;hahaha&quot;);</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
        numBytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUFSIZ<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recv()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;connection closed prematurely&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        totalBytesRcvd <span class="token operator">+=</span> numBytes<span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>numBytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="通用的-tcp-服务器"><a href="#通用的-tcp-服务器" class="header-anchor">#</a> 通用的 TCP 服务器</h3> <p>在 TCPServerUtility.c 中添加两个函数（原有 HandleTCPClient）</p> <ul><li><p>SetupTCPServerSocket(const char *service) 根据传入的服务或接口建立一个 TCP Socket 服务器并开始监听该端口</p> <p>封装了 socket() bind() listen() 三个步骤</p></li> <li><p>AcceptTCPConnection(int servSock) 在服务端口上接收连接，封装了 accept() 函数</p></li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">//close</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> MAXPENDING <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">SetupTCPServerSocket</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> addrCriteria<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrCriteria<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servAddr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;getaddrinfo() failed&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rtnVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> servSock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>addr <span class="token operator">=</span> servAddr<span class="token punctuation">;</span> addr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> addr <span class="token operator">=</span> addr<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span><span class="token punctuation">{</span>
        servSock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>servAddr<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>servSock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> bindRtn <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> listRtn <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> MAXPENDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bindRtn <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> listRtn <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> localAddr<span class="token punctuation">;</span>
            <span class="token class-name">socklen_t</span> addrSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>localAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getsockname</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>localAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrSize<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;getsockname() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;Binding to &quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">PrintSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>localAddr<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">close</span><span class="token punctuation">(</span>servSock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        servSock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> servSock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">AcceptTCPConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> servSock<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> clntAddr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> clntAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> clntSock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>servSock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>clntSock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;accept() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;Handling client &quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PrintSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> clntSock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TCPEchoServer.c</p> <ul><li>socket() 创建、bind() 绑定、listen() 监听服务器端口</li> <li>accept 接收连接（阻塞）</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../util/Practical.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;&gt;Server Port/Service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>service <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> servSock <span class="token operator">=</span> <span class="token function">SetupTCPServerSocket</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>servSock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;SetupTCPServerSocket() failed&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> clntSock <span class="token operator">=</span> <span class="token function">AcceptTCPConnection</span><span class="token punctuation">(</span>servSock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HandleTCPClient</span><span class="token punctuation">(</span>clntSock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>clntSock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="从数字获取名称"><a href="#从数字获取名称" class="header-anchor">#</a> 从数字获取名称</h3> <p>与 getaddrinfo() 相反，提供有函数 getnameinfo()</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>address<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addressLength<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> nodeLength<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> serviceLength<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
</code></pre></div><h2 id="udp-套接字"><a href="#udp-套接字" class="header-anchor">#</a> UDP 套接字</h2> <p>TCP 像是打电话，在通信前需要连接（三次握手 connect），通信后需要断开连接（四次挥手 close），而 UDP 像是发送邮件，既不需要连接更不需要断开连接，通过 sendto() 函数直接发送到某一个 UDP 服务器/客户，通过 recvfrom() 函数直接接收某一个客户/服务器发送的信息</p> <p>另外，UDP 套接字提供的通信传输是一种尽力而为的服务（点到点），它不保证通过 UDP 套接字发送的信息将会到达目的地，这意味着 UDP 套接字程序需要准备处理消息的丢失和重排</p> <p>网络模型</p> <ul><li>OIS 七层模型</li> <li>TCP/IP 四层模型</li> <li>TCP/IP 五层模型</li></ul> <img src="/assets/img/netmodel.015977ca.png"> <p>OSI 模型与 TCP/IP 模型对照</p> <img src="/assets/img/osimodel.71dd5dfa.png"> <p>点到点、端到端服务：在TCP/IP协议中，数据网络层（网际网层/IP层）及以下提供点到点服务，传输层提供端到端服务。端到端与点到点是针对网络中传输的两端设备间的关系而言的</p> <p>end to end：指的是在数据传输前，经过各种各样的交换设备，在两端设备问建立一条链路，就僚它们是直接相连的一样，链路建立后，发送端就可以发送数据，直至数据发送完毕，接收端确认接收成功。TCP 属于端到端协议</p> <ul><li>优点：链路建立后，发送端知道接收设备一定能收到，而且经过中间交换设备时不需要进行存储转发，因此传输延迟小</li> <li>缺点
<ul><li>直到接收端收到数据为止，发送端的设备一直要参与传输。如果整个传输的延迟很长，那么对发送端的设备造成很大的浪费</li> <li>如果接收设备关机或故障，那么端到端传输不可能实现</li></ul></li></ul> <p>point to point：指的是发送端把数据传给与它直接相连的设备，这台设备在合适的时候又把数据传给与之直接相连的下一台设备，通过一台一台直接相连的设备，把数据传到接收端</p> <ul><li>优点
<ul><li>发送端设备送出数据后，它的任务已经完成，不需要参与整个传输过程，这样不会浪费发送端设备的资源</li> <li>即使接收端设备关机或故障，点到点传输也可以采用存储转发技术进行缓冲</li></ul></li> <li>缺点：发送端发出数据后，不知道接收端能否收到或何时能收到数据，比如 UDP</li></ul> <h3 id="udp-客户"><a href="#udp-客户" class="header-anchor">#</a> UDP 客户</h3> <p>UDPEchoClient.c</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../util/Practical.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXSTRINGLENGTH</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">||</span> argc <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;&lt;Server Address/Name&gt; &lt;Echo Word&gt; [&lt;Server Port/Service&gt;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>server <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>echoString <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> echoStringLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>echoString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>echoStringLen <span class="token operator">&gt;</span> MAXSTRINGLENGTH<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;echoString&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string too long&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>serverPort<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        serverPort <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        serverPort <span class="token operator">=</span> <span class="token string">&quot;echo&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> addrCriteria<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrCriteria<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// 任意IP地址</span>
    addrCriteria<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span> <span class="token comment">// datagram 报文套接字，并非流式</span>
    addrCriteria<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> IPPROTO_UDP<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servAddr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> serverPort<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;getaddrinfo() failed&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rtnVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>servAddr<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// UDP</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ssize_t</span> numBytes <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> echoString<span class="token punctuation">,</span> echoStringLen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        servAddr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;sendto() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;sendto() error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sent unexpected number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> fromAddr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> fromAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fromAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>MAXSTRINGLENGTH<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    numBytes <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> MAXSTRINGLENGTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>fromAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fromAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytes <span class="token operator">!=</span> echoStringLen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom() error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;received unexpected number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SockAddrsEqual</span><span class="token punctuation">(</span>servAddr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>fromAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom()&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recvived a packet from unknown source&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    buffer<span class="token punctuation">[</span>echoStringLen<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Recvived: %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="udp-服务器"><a href="#udp-服务器" class="header-anchor">#</a> UDP 服务器</h3> <p>UDPEchoServer.c</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;../util/Practical.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXSTRINGLENGTH</span> <span class="token expression"><span class="token number">1024</span></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter(s)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;Server Port&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>service <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> servSock<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>servSock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> addrCriteria<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrCriteria<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// 任意地址族</span>
    addrCriteria<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span> <span class="token comment">// datagram 报文套接字，并非流式</span>
    addrCriteria<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> IPPROTO_UDP<span class="token punctuation">;</span>
    addrCriteria<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servAddr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rtnVal <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrCriteria<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rtnVal <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;getaddrinfo() failed&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rtnVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>servAddr<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;socket() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> servAddr<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;bing() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// while(1)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> clntAddr<span class="token punctuation">;</span>
        <span class="token class-name">socklen_t</span> clntAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>MAXSTRINGLENGTH<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">ssize_t</span> numBytesRcvd <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> MAXSTRINGLENGTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clntAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesRcvd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">&quot;Handling client &quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PrintSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">ssize_t</span> numBytesSent <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> numBytesRcvd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>clntAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clntAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesSent <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithSystemMessage</span><span class="token punctuation">(</span><span class="token string">&quot;sendto() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>numBytesRcvd <span class="token operator">!=</span> numBytesSent<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">DieWithUserMessage</span><span class="token punctuation">(</span><span class="token string">&quot;sendto() &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sent unexpected number of bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="发送、接收数据封装"><a href="#发送、接收数据封装" class="header-anchor">#</a> 发送、接收数据封装</h2> <p>协议：关于在通信信道上交换的信息（数据）的形式和含义的协定</p> <p>TCP/IP 协议在传输用户数据的字节时，将不会检查或修改它们，但信息必须以块的形式发送和接收，这些块的长度是 8 的倍数，因此我们将消息视作字节（byte）的序列</p> <h3 id="整数编码"><a href="#整数编码" class="header-anchor">#</a> 整数编码</h3> <p>在某种意义上，所有类型的信息最终都将被编码乘固定大小的整数</p> <p>整数大小：Sizing.c</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;limits.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;CHAR_BIT is %d\n\n&quot;</span><span class="token punctuation">,</span> CHAR_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//char数据字节大小</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof char is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof short is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof int is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof long is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof long long is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof int8_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int8_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof int16_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof int32_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof int64_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof uint8_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof uint16_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof uint32_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sizeof uint64_t is %d\n\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>CHAR_BIT is <span class="token number">8</span>
sizeof char is <span class="token number">1</span>
sizeof short is <span class="token number">2</span>
sizeof int is <span class="token number">4</span>
sizeof long is <span class="token number">8</span>
sizeof long long is <span class="token number">8</span>

sizeof int8_t is <span class="token number">1</span>
sizeof int16_t is <span class="token number">2</span>
sizeof int32_t is <span class="token number">4</span>
sizeof int64_t is <span class="token number">8</span>

sizeof uint8_t is <span class="token number">1</span>
sizeof uint16_t is <span class="token number">2</span>
sizeof uint32_t is <span class="token number">4</span>
sizeof uint64_t is <span class="token number">8</span>
</code></pre></div><p>字节排序：大端顺序和小端顺序</p> <p>例如对于字节序列 AB（十六进制）</p> <ul><li>大端顺序：1011</li> <li>小端顺序：1110</li></ul> <p>Internet 中大多数都使用大端顺序，于是大端顺序也被称为<strong>网络字节顺序</strong>；由硬件使用的字节顺序（可能大端可能小端），被称为<strong>本机字节顺序</strong>。在进行信息传递时，必须保证客户和服务器采用同种字节顺序，这里就涉及到了字节顺序的转换</p> <p>在 Socket API 中提供了类似与 htons()/htonl() 的字节顺序转换函数，并且总是统一使用网络字节顺序，即大端顺序</p> <ul><li>hton() 意为 host to network short，htonl() 意为 host to network long</li> <li>相对应有 ntohs()/ntohl()，network to host</li></ul> <p>更多</p> <ul><li>符号性和符号扩展</li> <li>构造、成帧和解析消息</li></ul> <h2 id="超越基本的套接字编程"><a href="#超越基本的套接字编程" class="header-anchor">#</a> 超越基本的套接字编程</h2> <ul><li>套接字选项</li> <li>信号</li> <li>非阻塞 I/O</li> <li>多任务处理</li> <li>多路复用</li> <li>多个接收者</li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/07/18, 20:18:15</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/9470a3/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">传输层和应用层</div></a> <a href="/pages/6cdab9/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">操作系统绪论</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/9470a3/" class="prev">传输层和应用层</a></span> <span class="next"><a href="/pages/6cdab9/">操作系统绪论</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/49af8b/"><div>
            H2 和 PostgreSQL
            <!----></div></a> <span class="date">07-19</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/3e5274/"><div>
            Java 白盒测试和安全编码
            <!----></div></a> <span class="date">7-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/aecc6a/"><div>
            基于 MCP 的审计 Agent 实现
            <!----></div></a> <span class="date">6-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:northboat@163.com" title="邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/northboat" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/my/m/music/playlist?id=5123040741" title="音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2025
    <span>Northboat | <a href="https://github.com/Northboat/Northboat.github.io/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="/song/The Sun Also Rises.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:10px;z-index:999999;background-color:blackcadetblue;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="/img/logo.png" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(/img/logo.png);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>太阳照常升起</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>久石譲</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/assets/js/app.7c57c868.js" defer></script><script src="/assets/js/3.e0c187c4.js" defer></script><script src="/assets/js/40.f0fb9086.js" defer></script><script src="/assets/js/84.9cf896f3.js" defer></script>
  </body>
</html>
