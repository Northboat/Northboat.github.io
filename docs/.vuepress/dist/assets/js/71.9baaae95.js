(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{1548:function(t,s,a){"use strict";a.r(s);var n=a(5),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"消息队列模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#消息队列模型"}},[t._v("#")]),t._v(" 消息队列模型")]),t._v(" "),s("h3",{attrs:{id:"点对点模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#点对点模型"}},[t._v("#")]),t._v(" 点对点模型")]),t._v(" "),s("p",[t._v("队列模型，又叫点对点模型，每个生产者对应一个消费者（一对一）")]),t._v(" "),s("p",[t._v("比如 OJ 中 MQ 的使用，后端收到判题请求后，先将判题记录写入数据库，而后作为生产者将判题记录 ID 写入消息队列，此时真正的判题模块由于订阅了该判题队列，于是自动从 MQ 中读出判题请求 ID，从 DB 中拿取数据执行判题业务，最后通过 WebSocket 返回")]),t._v(" "),s("h3",{attrs:{id:"订阅发布模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#订阅发布模型"}},[t._v("#")]),t._v(" 订阅发布模型")]),t._v(" "),s("p",[t._v("订阅发布模型，一个生产者将把消息广播到每一个订阅者，即一对多")]),t._v(" "),s("p",[t._v("订阅发布能够将串行执行的任务变成“并行”，例如以下串行场景，他是一步步执行")]),t._v(" "),s("img",{attrs:{src:a(952)}}),t._v(" "),s("p",[t._v("若引入 MQ，它可以变成这样的形式，这是合理的，实际上，更新积分、通知商家、更新用户标签这三个事件并没有直接的逻辑联系或是执行顺序问题，他们都是由“更新订单状态触发”")]),t._v(" "),s("img",{attrs:{src:a(953)}}),t._v(" "),s("p",[t._v("从而大幅提高效率")]),t._v(" "),s("p",[t._v("上述订阅发布模式的举例是 MQ 一大应用场景，"),s("strong",[t._v("异步处理")]),t._v("，而队列模式的举例是"),s("strong",[t._v("应用解耦")]),t._v("，消息队列的常用场景如下")]),t._v(" "),s("ul",[s("li",[t._v("异步处理：就是将一些非核心的业务流程以异步并行的方式执行，从而减少请求响应时间，提高系统吞吐量")]),t._v(" "),s("li",[t._v("应用解耦：顾名思义就是解除应用系统之间的耦合依赖。通过消息队列，使得每个应用系统不必受其他系统影响，可以更独立自主运行")]),t._v(" "),s("li",[t._v("流量削峰：是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛")]),t._v(" "),s("li",[t._v("消息通讯：指应用间的数据通信，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等点对点通讯")])]),t._v(" "),s("h2",{attrs:{id:"rabbitmq"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq"}},[t._v("#")]),t._v(" RabbitMQ")]),t._v(" "),s("h3",{attrs:{id:"安装部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装部署"}},[t._v("#")]),t._v(" 安装部署")]),t._v(" "),s("p",[t._v("manjaro 安装")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("yay "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-S")]),t._v(" rabbitmq rabbitmqadmin\n")])])]),s("p",[t._v("启动")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" rabbitmq-plugins "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" rabbitmq-server\n")])])]),s("p",[t._v("默认端口")]),t._v(" "),s("ul",[s("li",[t._v("管理界面：15672")]),t._v(" "),s("li",[t._v("客户端：5672")])]),t._v(" "),s("p",[t._v("后台运行")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("rabbitmq-server "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-detached")]),t._v("\n")])])]),s("h3",{attrs:{id:"spring-集成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-集成"}},[t._v("#")]),t._v(" Spring 集成")]),t._v(" "),s("p",[t._v("引入 RabbitMQ 依赖")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-amqp"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("配置文件")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rabbitmq")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.2.1.231\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5672")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" northboat\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("password")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("virtualHost")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" order\n")])])]),s("p",[t._v('一个简单的消费者，订阅队列"'),s("code",[t._v('rabbitmq_queue"')])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Consumer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RabbitHandler")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RabbitListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queuesToDeclare "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Queue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rabbitmq_queue"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("process")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"消费者消费消息: "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("一个简单的生产者")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Producer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitTemplate")]),t._v(" rabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("produce")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" message "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Beijing"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"生产者产生消息: "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\trabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("convertAndSend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rabbitmq_queue"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("这里传输的是简单字符串，我们尝试传输一个实体对象 User，需要进行序列化，即继承"),s("code",[t._v("Serializable")]),t._v("类")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Serializable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 省略get和set方法")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("仍然通过"),s("code",[t._v("convertAndSend")]),t._v("方法进行传输")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Producer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitTemplate")]),t._v(" rabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("produce")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\t\n\t\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nmsl"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wdnmd"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"生产者生产消息: "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t\n\t\trabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("convertAndSend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rabbitmq_queue_object"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("convertAndSend() 方法支持 String、Integer、Object 等基础的数据类型")]),t._v(" "),s("h2",{attrs:{id:"确保可靠传输"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#确保可靠传输"}},[t._v("#")]),t._v(" 确保可靠传输")]),t._v(" "),s("p",[t._v("在使用消息队列时，因为生产者和消费者不直接交互，所以面临下面几个问题")]),t._v(" "),s("ol",[s("li",[t._v("要把消息添加到队列中，怎么保证消息成功添加？")]),t._v(" "),s("li",[t._v("如何保证消息发送出去时一定会被消费者正常消费？")]),t._v(" "),s("li",[t._v("消费者正常消费了，生产者或者队列如何知道消费者已经成功消费了消息？")])]),t._v(" "),s("p",[t._v("那么，如何保证消息 100% 可靠性发送？我们可以采用 ack 应答 + 日志记录 + 定时任务来实现")]),t._v(" "),s("p",[t._v("假设有一个创建订单业务，后端收到请求后，将该业务通过消息队列发送到具体的业务模块，我们这样保证消息的可靠传输")]),t._v(" "),s("ol",[s("li",[t._v("完成订单业务处理后，生产者发送一条消息到消息队列，同时记录这条操作日志（发送中）")]),t._v(" "),s("li",[t._v("消费者收到消息后处理进行")]),t._v(" "),s("li",[t._v("消费者处理成功后给消息队列发送 ack 应答")]),t._v(" "),s("li",[t._v("消息队列收到 ack 应答后，给生成者的 Confirm Listener 发送确认")]),t._v(" "),s("li",[t._v("生产者对消息日志表进行操作，修改之前的日志状态（发送成功）")]),t._v(" "),s("li",[t._v("在消费端返回应答的过程中，可能发生网络异常，导致生产者未收到应答消息，因此需要一个定时任务去提取其状态为“发送中”并已经超时的消息集合")]),t._v(" "),s("li",[t._v("使用定时任务判断为消息事先设置的最大重发次数，大于最大重发次数就判断消息发送失败，更新日志记录状态为发送失败")])]),t._v(" "),s("p",[t._v("流程图如下")]),t._v(" "),s("img",{attrs:{src:a(954)}}),t._v(" "),s("p",[t._v("具体实现")]),t._v(" "),s("p",[t._v("1️⃣ 创建生产者")]),t._v(" "),s("p",[t._v("定义应答方法"),s("code",[t._v("final RabbitTemplate.ConfirmCallback confirmCallback = new RabbitTemplate.ConfirmCallback() {}")]),t._v("，即定义收到消费者发回的 ack 应答后的处理：更新日志记录，修改订单状态为成功")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitOrderSender")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LoggerFactory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLogger")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitOrderSender")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitTemplate")]),t._v(" rabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageLogMapper")]),t._v(" messageLogMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * Broker应答后，会调用该方法区获取应答结果\n     */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ConfirmCallback")]),t._v(" confirmCallback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ConfirmCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("confirm")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CorrelationData")]),t._v(" correlationData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" cause"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"correlationData："')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("correlationData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" messageId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" correlationData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"消息确认返回值："')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//如果返回成功，则进行更新")]),t._v("\n                messageLogMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("changeMessageLogStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Constans")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ORDER_SEND_SUCCESS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//失败进行操作：根据具体失败原因选择重试或补偿等手段")]),t._v("\n                logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"异常处理,返回结果："')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("cause"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 发送消息方法调用: 构建自定义对象消息\n     * @param order\n     * @throws Exception\n     */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("synchronized")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderInfo")]),t._v(" order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过实现 ConfirmCallback 接口，消息发送到 Broker 后触发回调，确认消息是否到达 Broker 服务器，也就是只确认是否正确到达 Exchange 中")]),t._v("\n        rabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setConfirmCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("confirmCallback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//消息唯一ID")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CorrelationData")]),t._v(" correlationData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CorrelationData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessageId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        rabbitTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("convertAndSend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"order.exchange"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"order.message"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" correlationData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("当生产者调用"),s("code",[t._v("ConfirmCallback()")]),t._v("，说明当前请求已被消费者消费")]),t._v(" "),s("p",[t._v("2️⃣ 定义消息定时重发任务")]),t._v(" "),s("p",[t._v("定期去数据库中找状态为 0 的数据项，进行消息重发")]),t._v(" "),s("ul",[s("li",[t._v("通过"),s("code",[t._v("@Compoent")]),t._v("和"),s("code",[t._v("@Scheduled(initialDelay = 5000, fixedDelay = 10000)")]),t._v("注解将定时任务注入 Spring，初始 5 s 后开始执行，往后每 10s 执行一次")]),t._v(" "),s("li",[t._v("判断逻辑为：当重发大于两次，认为任务失败，不再执行，否则通过 RabbitOrderSender 进行重发")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RetryMessageTasker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LoggerFactory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLogger")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RetryMessageTasker")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RabbitOrderSender")]),t._v(" rabbitOrderSender"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageLogMapper")]),t._v(" messageLogMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 定时任务\n     */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Scheduled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initialDelay "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fixedDelay "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reSend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-----------定时任务开始-----------"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//抽取消息状态为0且已经超时的消息集合")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageLog")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" messageLogMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("query4StatusAndTimeoutMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageLog "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//投递三次以上的消息")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageLog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTryCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//更新失败的消息")]),t._v("\n                messageLogMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("changeMessageLogStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageLog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessageId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Constans")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ORDER_SEND_FAILURE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重试投递消息，将重试次数递增")]),t._v("\n                messageLogMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("update4ReSend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageLog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessageId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderInfo")]),t._v(" reSendOrder "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JsonUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("jsonToObject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageLog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    rabbitOrderSender"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reSendOrder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-----------异常处理-----------"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("3️⃣ 运行测试")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RunWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringRunner")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@SpringBootTest")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MqApplicationTests")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderService")]),t._v(" orderService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * 测试订单创建\n     */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderInfo")]),t._v(" order "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"201901236"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"测试订单6"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setMessageId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentTimeMillis")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"$"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UUID")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("randomUUID")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            orderService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"消息队列的选择"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#消息队列的选择"}},[t._v("#")]),t._v(" 消息队列的选择")]),t._v(" "),s("h3",{attrs:{id:"kafka-vs-rabbitmq"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kafka-vs-rabbitmq"}},[t._v("#")]),t._v(" Kafka VS RabbitMQ")]),t._v(" "),s("p",[t._v("Kafka 设计之初是用于处理大批量的日志，基于自定义的二进制协议，专注于高吞吐量，其特点如下")]),t._v(" "),s("p",[t._v("而 RabbitMQ 的设计目标是"),s("strong",[t._v("低延迟")]),t._v("和"),s("strong",[t._v("可靠传递")]),t._v("，它的消息确认机制和重试机制可以确保任务被正确处理，适合高并发的任务，常用于业务的解耦、异步处理")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("消息队列")]),t._v(" "),s("th",[t._v("协议")]),t._v(" "),s("th",[t._v("消息传输")]),t._v(" "),s("th",[t._v("实时性")]),t._v(" "),s("th",[t._v("扩展性")]),t._v(" "),s("th",[t._v("持久化")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("Kafka")]),t._v(" "),s("td",[t._v("基于自定义的二进制协议，专注于高吞吐量")]),t._v(" "),s("td",[t._v("消息以"),s("strong",[t._v("日志")]),t._v("的形式持久化存储，支持高吞吐量的消息流；不支持消息确认（ACK）和重试机制，但可以通过消费者偏移量（Offset）实现消息重放")]),t._v(" "),s("td",[t._v("延迟较高，适合批量处理")]),t._v(" "),s("td",[t._v("支持分布式集群，可以轻松扩展到数百个节点，处理海量数据")]),t._v(" "),s("td",[t._v("消息持久化到磁盘，支持长期存储和回溯")])]),t._v(" "),s("tr",[s("td",[t._v("RabbitMQ")]),t._v(" "),s("td",[t._v("基于 AMQP（Advanced Message Queuing Protocol），支持多种消息模式（如点对点、发布/订阅）")]),t._v(" "),s("td",[t._v("支持消息确认（ACK）和重试机制，确保消息可靠传递；支持消息优先级、延迟队列、死信队列等高级特性")]),t._v(" "),s("td",[t._v("适合低延迟的消息传递")]),t._v(" "),s("td",[t._v("支持复杂的路由规则（如 direct、topic、fanout 等交换器）")]),t._v(" "),s("td",[t._v("可以通过集群实现高可用性，但扩展性相对有限")])])])]),t._v(" "),s("p",[t._v("什么是 AMQP（Advanced Message Queuing Protocol）")]),t._v(" "),s("p",[t._v("RabbitMQ 的适用场景")]),t._v(" "),s("ul",[s("li",[t._v("任务队列：适合需要"),s("strong",[t._v("实时处理")]),t._v("的任务，例如 Web 应用中的异步任务（如发送邮件、处理订单）")]),t._v(" "),s("li",[t._v("低延迟场景：需要"),s("strong",[t._v("快速响应")]),t._v("的场景，例如实时通知、即时消息")]),t._v(" "),s("li",[t._v("复杂路由：需要根据消息内容或规则将消息路由到不同消费者的场景")]),t._v(" "),s("li",[t._v("可靠传递：需要确保"),s("strong",[t._v("每条消息都被正确处理")]),t._v("，适合对消息丢失敏感的场景")])]),t._v(" "),s("p",[t._v("Kafka 使用场景")]),t._v(" "),s("ul",[s("li",[t._v("日志收集：适合收集和存储大量日志数据，例如应用程序日志、系统日志")]),t._v(" "),s("li",[t._v("流处理：适合实时"),s("strong",[t._v("流处理场景")]),t._v("，例如用户行为分析、实时推荐系统")]),t._v(" "),s("li",[t._v("大数据管道：适合作为"),s("strong",[t._v("大数据")]),t._v("生态系统的数据传输管道，例如将数据从生产系统传输到 Hadoop 或 Spark")]),t._v(" "),s("li",[t._v("事件溯源：适合需要"),s("strong",[t._v("记录事件历史")]),t._v("的场景，例如金融交易记录、审计日志（因为数据会写入磁盘进行持久化）")])]),t._v(" "),s("p",[t._v("选择 RabbitMQ 的场景")]),t._v(" "),s("ul",[s("li",[t._v("你需要低延迟的消息传递")]),t._v(" "),s("li",[t._v("你需要复杂的路由规则（如根据消息内容路由到不同消费者）")]),t._v(" "),s("li",[t._v("你需要确保每条消息都被正确处理（如金融交易、订单处理）")]),t._v(" "),s("li",[t._v("你的系统规模较小或中等，不需要处理海量数据")])]),t._v(" "),s("p",[t._v("选择 Kafka 的场景")]),t._v(" "),s("ul",[s("li",[t._v("你需要高吞吐量的消息处理（如日志收集、用户行为分析）")]),t._v(" "),s("li",[t._v("你需要持久化存储消息，并且可能需要回溯历史消息")]),t._v(" "),s("li",[t._v("你需要流处理能力（如实时推荐、实时监控）")]),t._v(" "),s("li",[t._v("你的系统规模较大，需要处理海量数据。")])]),t._v(" "),s("p",[t._v("RabbitMQ 为什么 RabbitMQ 并发能力强于 Kafka 而 Kafka 吞吐量大于 RabbitMQ？")]),t._v(" "),s("p",[t._v("首先回答吞吐量的问题")]),t._v(" "),s("ol",[s("li",[t._v("Kafka 的吞吐量高很大原因来自于其"),s("strong",[t._v("批处理")]),t._v("设计，将多个消息打包成一个批次来减少网络和磁盘 I/O 的开销，相应的，这样处理的延迟会变大")]),t._v(" "),s("li",[t._v("另外，Kafka 不仅仅是一个消息队列，它还提供了 Kafka Streams 和 Kafka Connect 等工具，用于实现"),s("strong",[t._v("流处理")]),t._v("，从而大大提高数据处理速度")])]),t._v(" "),s("p",[t._v("什么是批处理，什么是流处理？")]),t._v(" "),s("ul",[s("li",[t._v("批处理是指对"),s("strong",[t._v("静态的、有限的数据集")]),t._v("进行处理。数据通常以文件或数据库表的形式存储，处理过程是周期性的（如每天、每小时）")]),t._v(" "),s("li",[t._v("流处理是指对"),s("strong",[t._v("连续的、无限的数据流")]),t._v("进行实时或近实时的处理。数据通常是动态生成的（如日志、传感器数据、用户行为数据）")])]),t._v(" "),s("p",[t._v("💤 PS：流处理让我想到 Java Stream 流，虽然都叫“流”，但 Java Stream 实际上是一个用于对集合（Collection）数据进行函数式操作（如过滤、映射、排序、聚合等）的 API，提供一种更简洁、更高效的方式来处理集合数据（所谓函数式编程）")]),t._v(" "),s("p",[t._v("而 RabbitMQ 的高并发显著强于 Kafka，首先我们要明确到底什么是并发能力强，并发能力强并不是只 QPS（Queries Per Second）高，1s 在计算机系统其实是一个比较大的时间跨度，以至于他反应的实际上是吞吐量而并非并发量")]),t._v(" "),s("p",[t._v("所以，这里说 RabbitMQ 的高并发能力其实指的是低延迟的处理，进行快速的实时反馈")]),t._v(" "),s("h3",{attrs:{id:"其他对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他对比"}},[t._v("#")]),t._v(" 其他对比")]),t._v(" "),s("p",[t._v("现有一些开源 MQ 的对比")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("特性\\消息队列")]),t._v(" "),s("th",[t._v("Kafka")]),t._v(" "),s("th",[t._v("RocketMQ")]),t._v(" "),s("th",[t._v("RabbitMQ")]),t._v(" "),s("th",[t._v("ActiveMQ")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("单机吞吐量")]),t._v(" "),s("td",[t._v("10万级")]),t._v(" "),s("td",[t._v("10万级")]),t._v(" "),s("td",[t._v("万级")]),t._v(" "),s("td",[t._v("10万级")])]),t._v(" "),s("tr",[s("td",[t._v("开发语言")]),t._v(" "),s("td",[t._v("Scala")]),t._v(" "),s("td",[t._v("Java")]),t._v(" "),s("td",[t._v("Erlang")]),t._v(" "),s("td",[t._v("Java")])]),t._v(" "),s("tr",[s("td",[t._v("高可用")]),t._v(" "),s("td",[t._v("分布式")]),t._v(" "),s("td",[t._v("分布式")]),t._v(" "),s("td",[t._v("主从")]),t._v(" "),s("td",[t._v("分布式")])]),t._v(" "),s("tr",[s("td",[t._v("消息延迟")]),t._v(" "),s("td",[t._v("ms级")]),t._v(" "),s("td",[t._v("ms级")]),t._v(" "),s("td",[t._v("us级")]),t._v(" "),s("td",[t._v("ms级")])]),t._v(" "),s("tr",[s("td",[t._v("消息丢失")]),t._v(" "),s("td",[t._v("理论上不会丢失")]),t._v(" "),s("td",[t._v("理论上不会丢失")]),t._v(" "),s("td",[t._v("低")]),t._v(" "),s("td",[t._v("低")])]),t._v(" "),s("tr",[s("td",[t._v("消费模式")]),t._v(" "),s("td",[t._v("拉取")]),t._v(" "),s("td",[t._v("推拉")]),t._v(" "),s("td",[t._v("推拉")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("持久化")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("文件")]),t._v(" "),s("td",[t._v("内存，文件")]),t._v(" "),s("td",[t._v("内存，文件，数据库")])]),t._v(" "),s("tr",[s("td",[t._v("支持协议")]),t._v(" "),s("td",[t._v("自定义协议")]),t._v(" "),s("td",[t._v("自定义协议")]),t._v(" "),s("td",[t._v("AMQP，XMPP, SMTP,STOMP")]),t._v(" "),s("td",[t._v("AMQP,MQTT,OpenWire,STOMP")])]),t._v(" "),s("tr",[s("td",[t._v("社区活跃度")]),t._v(" "),s("td",[t._v("高")]),t._v(" "),s("td",[t._v("中")]),t._v(" "),s("td",[t._v("高")]),t._v(" "),s("td",[t._v("高")])]),t._v(" "),s("tr",[s("td",[t._v("管理界面")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("web console")]),t._v(" "),s("td",[t._v("好")]),t._v(" "),s("td",[t._v("一般")])]),t._v(" "),s("tr",[s("td",[t._v("部署难度")]),t._v(" "),s("td",[t._v("中")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("低")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("部署方式")]),t._v(" "),s("td",[t._v("独立")]),t._v(" "),s("td",[t._v("独立")]),t._v(" "),s("td",[t._v("独立")]),t._v(" "),s("td",[t._v("独立，嵌入")])]),t._v(" "),s("tr",[s("td",[t._v("成熟度")]),t._v(" "),s("td",[t._v("成熟")]),t._v(" "),s("td",[t._v("比较成熟")]),t._v(" "),s("td",[t._v("成熟")]),t._v(" "),s("td",[t._v("成熟")])]),t._v(" "),s("tr",[s("td",[t._v("综合评价")]),t._v(" "),s("td",[t._v("优点：拥有强大的性能及吞吐量，兼容性很好。 缺点：由于支持消息堆积，导致延迟比较高")]),t._v(" "),s("td",[t._v("优点：性能好，稳定可靠，有活跃的中文社区，特点响应快。 缺点：兼容性较差，但随着影响力的扩大，该问题会有改善")]),t._v(" "),s("td",[t._v("优点：产品成熟，容易部署和使用，拥有灵活的路由配置。 缺点：性能和吞吐量较差，不易进行二次开发")]),t._v(" "),s("td",[t._v("优点：产品成熟，支持协议多，支持多种语言的客户端。 缺点：社区不活跃，存在消息丢失的可能")])])])])])}),[],!1,null,null,null);s.default=e.exports},952:function(t,s,a){t.exports=a.p+"assets/img/image-20250303143017426.77128625.png"},953:function(t,s,a){t.exports=a.p+"assets/img/image-20250303143143342.6d217d1f.png"},954:function(t,s){t.exports="data:image/png;base64,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"}}]);