---
date: 2024-9-13
permalink: /pages/a28d6d/
author: 
  name: Arkrypto
  link: https://github.com/Arkrypto
title: WebSocket æ·»åŠ  JWT è®¤è¯
---

å‚è€ƒï¼š[websocket ä¹‹å››ï¼šWebSocket çš„é‰´æƒæˆæƒæ–¹æ¡ˆ - duanxz - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/duanxz/p/5440716.html)

## åè®®ç›¸å…³

é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼ŒWebSocket æ˜¯åŸºäº HTTP çš„åè®®ï¼ˆè€Œ HTTP åŸºäº TCPï¼Œæœ‰æ—¶æˆ‘ä»¬ä¹Ÿè¯´ WebSocket åŸºäº TCP åè®®ï¼‰ï¼ŒHTTP æœ‰è¯¸å¤šç¼ºç‚¹ï¼Œå¦‚

1. é¦–å…ˆï¼Œä»–ä¸æ”¯æŒå¼‚æ­¥è¯·æ±‚ï¼Œè§£å†³æ–¹æ¡ˆå¦‚ Ajax
2. å…¶æ¬¡ï¼ŒæœåŠ¡ç«¯æ— æ³•è¿›è¡Œä¸»åŠ¨æ¨é€ï¼ˆéåŒå·¥é€šä¿¡ï¼‰ï¼Œå¯ä½¿ç”¨ Comet å¯¹è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œå»¶è¿Ÿæ¨é€ï¼Œè¿™æ ·å®¢æˆ·ç«¯ä¸éœ€è¦å¿™ç­‰ï¼ˆä½†å®é™…ä¸ŠæœåŠ¡ç«¯åšäº†å¿™ç­‰çš„å·¥ä½œï¼‰
3. å½“ç„¶ï¼ŒHTTP è¿˜æœ‰ç€å…¶ä»–çš„ç¼ºç‚¹ï¼Œå¦‚ä»–æœ¬èº«æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„åè®®ï¼Œå³æ¯ä¸ª HTTP è¿æ¥æ— æ³•å¯¹ç”¨æˆ·è¿›è¡Œè¯†åˆ«ï¼Œéœ€è¦æœåŠ¡ç«¯ç»´æŠ¤ç”¨æˆ· Sessionï¼ŒåŒæ—¶ç”¨æˆ·åœ¨æœ¬åœ° Cookie ä¸­å­˜å‚¨ SessionIDï¼Œè¿›è¡ŒçŠ¶æ€çš„ç»´æŠ¤
4. å¹¶ä¸”ï¼ŒHTTP å¹¶æ²¡æœ‰å®‰å…¨æ–¹é¢çš„è€ƒé‡ï¼Œå…¶æ˜æ–‡åœ¨é“¾è·¯ä¸­ç›´æ¥å°è£…åœ¨ TCP æŠ¥æ–‡ä¸­ä¼ è¾“ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ HTTPSï¼Œé€šè¿‡åœ¨ HTTP å¤–å±‚å†å¥—ä¸€å±‚ SSL åè®®ï¼Œå®ç°**æ•°æ®åŠ å¯†ã€èº«ä»½éªŒè¯ã€å®Œæ•´æ€§éªŒè¯**ï¼Œå…¶ä¸­èº«ä»½éªŒè¯é€šè¿‡è¯ä¹¦å®ç°ï¼Œå®Œæ•´æ€§éªŒè¯é€šè¿‡æ•°å­—ç­¾åå®ç°

å½“ç„¶äº†ï¼Œè¿™æ ·çš„ç¼ºç‚¹æ˜¯å®Œå…¨èƒ½æ¥å—çš„ï¼Œäººä»¬éœ€è¦ä¸€ä¸ªè½»é‡çš„ã€æ˜“æ‰©å±•çš„å¹¶ä¸”èƒ½å¤Ÿä¿è¯å¯é ä¼ è¾“çš„åº”ç”¨å±‚åè®®

ä¸ºäº†å®ç°å¼‚æ­¥è¯·æ±‚å’ŒæœåŠ¡ç«¯æ¨é€çš„åŠŸèƒ½ï¼Œæå‡ºäº† WebSocket è¿™æ ·çš„å…¨åŒå·¥å¼‚æ­¥é€šä¿¡çš„åè®®ï¼Œç›¸åº”çš„ï¼Œç”±äº WebSocket åŸºäº HTTPï¼Œä»–å¤©ç„¶çš„ç»§æ‰¿äº†è¿™äº›ä¸ª HTTP çš„éƒ¨åˆ†â€œç¼ºç‚¹â€ï¼ˆ3 å’Œ 4ï¼‰

> This protocol doesnâ€™t prescribe any particular way that servers can authenticate clients during the WebSocket handshake. The WebSocket server can use any client authentication mechanism available to a generic HTTP server, such as cookies, HTTP authentication, or TLS authentication.

WebSocket åè®®çš„ RFCï¼ˆRequest For Commentï¼‰ æåˆ°ï¼Œå¯ä»¥ä½¿ç”¨ä¾‹å¦‚ Cookiesã€HTTP auth æˆ– TLS auth æ¥è¿›è¡Œé‰´æƒï¼Œæœ¬æ–‡å…³æ³¨å…¶å®‰å…¨æ€§æ–¹é¢çš„è€ƒé‡ï¼Œåœ¨åŸºæœ¬çš„ WebSocket è¿æ¥ä¸Šæ·»åŠ ç®€å•çš„èº«ä»½éªŒè¯å’Œå®Œæ•´æ€§éªŒè¯çš„åŠŸèƒ½

## ä¸€èˆ¬çš„ WS æœåŠ¡

### Java åç«¯

å¼•å…¥ä¾èµ–

```xml
<!--WebSocket-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

åœ¨ä¸»ç±»ä¸Šå¯åŠ¨ WebSocket æœåŠ¡

```java
package com.northboat.bearchat;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.socket.config.annotation.EnableWebSocket;

@SpringBootApplication
@MapperScan("com.northboat.bearchat.mapper")
@EnableWebSocket
public class BearChatApplication {

	public static void main(String[] args) {
		SpringApplication.run(BearChatApplication.class, args);
	}

}
```

WebSocket æœåŠ¡å™¨

- `onlineCount`å˜é‡æ˜¯`static`çš„ï¼Œä¸€å¼€å§‹ä½¿ç”¨äº†`synchronized`æ¥ä¿®æ”¹è®¡æ•°ï¼Œè¿™åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä»ç„¶å­˜åœ¨ç«äº‰é—®é¢˜ï¼Œåä½¿ç”¨`AtomicInteger`ä»£æ›¿
- ä¸€å¼€å§‹é‡‡ç”¨`CopyOnWriteArraySet<WebSocketServer>`å»å­˜æ”¾ WS è¿æ¥ï¼Œåæ”¹æˆ`ConcurrentHashMap<String, WebSocketServer>`ï¼Œä¸€æ˜¯æé«˜äº†æŸ¥è¯¢æ•ˆç‡`O(1)`ï¼ŒäºŒæ˜¯é¿å…äº†`CopyOnWriteArraySet`åœ¨é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½ç“¶é¢ˆ

```java
package com.northboat.bearchat.websocket;

import jakarta.websocket.*;
import jakarta.websocket.server.PathParam;
import jakarta.websocket.server.ServerEndpoint;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.concurrent.CopyOnWriteArraySet;

@Component
@Slf4j
@Service
@ServerEndpoint("/chat/{sid}")
public class WebSocketServer {
    //é™æ€å˜é‡ï¼Œç”¨æ¥è®°å½•å½“å‰åœ¨çº¿è¿æ¥æ•°ã€‚åº”è¯¥æŠŠå®ƒè®¾è®¡æˆçº¿ç¨‹å®‰å…¨çš„ã€‚
    private static final AtomicInteger onlineCount = new AtomicInteger(0);
    //concurrentåŒ…çš„çº¿ç¨‹å®‰å…¨Setï¼Œç”¨æ¥å­˜æ”¾æ¯ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„MyWebSocketå¯¹è±¡ã€‚
    private static final ConcurrentHashMap<String, WebSocketServer> webSocketMap = new ConcurrentHashMap<>();

    //ä¸æŸä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦é€šè¿‡å®ƒæ¥ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®
    private Session session;

    //æ¥æ”¶sid
    private String sid = "";

    /**
     * è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨çš„æ–¹æ³•
     */
    @OnOpen
    public void onOpen(Session session, @PathParam("sid") String sid) {
        this.session = session;
        this.sid = sid;
        webSocketMap.put(sid, this);     //åŠ å…¥setä¸­
        addOnlineCount();           //åœ¨çº¿æ•°åŠ 1
        try {
            sendMessage("Connection Test Message");
            log.info("æœ‰æ–°çª—å£å¼€å§‹ç›‘å¬:" + sid + ", å½“å‰æ€»å…±åœ¨çº¿äººæ•°ä¸º:" + getOnlineCount());
        } catch (IOException e) {
            log.error("websocket IO Exception");
        }
    }

    /**
     * è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³•
     */
    @OnClose
    public void onClose() {
        webSocketMap.remove(this.sid);  //ä»setä¸­åˆ é™¤
        subOnlineCount();           //åœ¨çº¿æ•°å‡1
        //æ–­å¼€è¿æ¥æƒ…å†µä¸‹ï¼Œæ›´æ–°ä¸»æ¿å ç”¨æƒ…å†µä¸ºé‡Šæ”¾
        log.info("é‡Šæ”¾çš„sidä¸ºï¼š" + sid);
        //è¿™é‡Œå†™ä½  é‡Šæ”¾çš„æ—¶å€™ï¼Œè¦å¤„ç†çš„ä¸šåŠ¡
        log.info("æœ‰ä¸€è¿æ¥å…³é—­ï¼å½“å‰åœ¨çº¿äººæ•°ä¸º" + getOnlineCount());
    }

    /**
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•
     * @ Param message å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯
     */
    // å…¨åŒå·¥é€šä¿¡ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯åè¿›è¡Œå¤„ç†ï¼Œå¯ä»¥æ˜¯åˆ†å‘ï¼Œå¯ä»¥æ˜¯å…¶ä»–
    // è¿™é‡Œæ˜¯å°†ä¿¡æ¯å‘é€ç»™ sid ç›¸åŒçš„æ‰€æœ‰è¿æ¥
    @OnMessage
    public void onMessage(String message, Session session) {
        log.info("æ”¶åˆ°æ¥è‡ªçª—å£ " + sid + " çš„ä¿¡æ¯:" + message);
        //ç¾¤å‘æ¶ˆæ¯
        try {
        	webSocketMap.get(sid).sendMessage(message);
        } catch (IOException e) {
            e.printStackTrace();
		}
    }

    /**
     * @ Param session
     * @ Param error
     */
    @OnError
    public void onError(Session session, Throwable error) {
        log.error("å‘ç”Ÿé”™è¯¯");
        error.printStackTrace();
        try {
        	session.close();
    	} catch (IOException e) {
        	log.error("å…³é—­ WebSocket å¤±è´¥", e);
    	}
    }

    /**
     * å®ç°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€
     */
    public void sendMessage(String message) throws IOException {
        this.session.getBasicRemote().sendText(message);
    }

    /**
     * ç¾¤å‘è‡ªå®šä¹‰æ¶ˆæ¯
     */
    public static void sendInfo(String message, @PathParam("sid") String sid) throws IOException {
        log.info("æ¨é€æ¶ˆæ¯åˆ°çª—å£" + sid + "ï¼Œæ¨é€å†…å®¹:" + message);
		//è¿™é‡Œå¯ä»¥è®¾å®šåªæ¨é€ç»™è¿™ä¸ªsidçš„ï¼Œä¸ºnullåˆ™å…¨éƒ¨æ¨é€
        webSocketMap.values().forEach(item -> {
        	if (sid == null || item.sid.equals(sid)) {
            	try {
                	item.sendMessage(message);
            	} catch (IOException e) {
                	log.error("æ¶ˆæ¯æ¨é€å¤±è´¥: {}", e.getMessage());
            	}
        	}
    	});
    }

    public static synchronized int getOnlineCount() {
        return onlineCount;
    }

    public static synchronized void addOnlineCount() {
        onlineCount.incrementAndGet();
    }

    public static synchronized void subOnlineCount() {
        onlineCount.decrementAndGet();
    }

    public static CopyOnWriteArraySet<WebSocketServer> getWebSocketSet() {
        return webSocketMap.valueSet();
    }
}
```

### JS å‰ç«¯

ç®€å•çš„å‰ç«¯é¡µé¢å’Œæœ´å®æ— åçš„ JS

```html
<h2 class="major">å…±æœ‰<strong th:text="${count}"></strong>äººåœ¨å…¬å…±èŠå¤©å®¤</h2>

<p id="user" th:text="${name}" style="display: none"></p>
<p id="login" th:text="${login}" style="display: none"></p>
<p id="room" th:text="${room}" style="display: none"></p>
<script>
    let user = document.getElementById("user").innerText;
    let login = document.getElementById("login").innerText;
    console.log(name);

    // è¿æ¥ websocket æœåŠ¡å™¨
    let websocket = null;
    let room  = document.getElementById("room").innerText;
    //åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒWebSocket
    if(room === "null"){
        throw SyntaxError();
    } else if('WebSocket' in window) {
        //æ”¹æˆä½ çš„åœ°å€http
        websocket = new WebSocket("ws://fx35xt.natappfree.cc/chat/"+room);
    } else {
        alert('å½“å‰æµè§ˆå™¨ Not support websocket')
    }


    //è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
    websocket.onerror = function() {
        setMessageInnerHTML("WebSocket è¿æ¥å‘ç”Ÿé”™è¯¯");
    };

    //è¿æ¥æˆåŠŸå»ºç«‹çš„å›è°ƒæ–¹æ³•
    websocket.onopen = function() {
        setMessageInnerHTML("WebSocket è¿æ¥æˆåŠŸ");
    }
    
    //let U01data, Uidata, Usdata;
    //æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•
    websocket.onmessage = function(event) {
        console.log(event);
        setMessageInnerHTML(event.data);
        //setechart()
    }

    //è¿æ¥å…³é—­çš„å›è°ƒæ–¹æ³•
    websocket.onclose = function() {
        setMessageInnerHTML("WebSocket è¿æ¥å…³é—­");
    }

    //ç›‘å¬çª—å£å…³é—­äº‹ä»¶ï¼Œå½“çª—å£å…³é—­æ—¶ï¼Œä¸»åŠ¨å»å…³é—­websocketè¿æ¥ï¼Œé˜²æ­¢è¿æ¥è¿˜æ²¡æ–­å¼€å°±å…³é—­çª—å£ï¼Œserverç«¯ä¼šæŠ›å¼‚å¸¸ã€‚
    window.onbeforeunload = function() {
        closeWebSocket();
    }

    //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
    function setMessageInnerHTML(innerHTML) {
        while(innerHTML.length > 32){
            document.getElementById('message').innerHTML += innerHTML.substring(0, 32) + '<br/>';
            innerHTML = innerHTML.substring(32);
        }
        document.getElementById('message').innerHTML += innerHTML + '<br/><br/>';
    }

    //å…³é—­WebSocketè¿æ¥
    function closeWebSocket() {
        websocket.close();
    }

    //å‘é€æ¶ˆæ¯
    function send() {
        let message = document.getElementById('text').value;
    	if (message.length > 200) {
        	alert("æ¶ˆæ¯è¿‡é•¿ï¼Œè¯·é™åˆ¶åœ¨ 200 å­—ç¬¦ä»¥å†…ï¼");
        	return;
   	 	}
        websocket.send(message);
        document.getElementById("text").value = "";
    }
</script>
```

## JWT ä»¤ç‰Œè®¤è¯

### JWT

JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§åŸºäº **JSON** çš„**èº«ä»½è®¤è¯å’Œä¿¡æ¯ä¼ é€’**æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®‰å…¨åœ°ä¼ é€’è®¤è¯ä¿¡æ¯

JWT æ˜¯**æ— çŠ¶æ€çš„**ï¼Œå³æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼Œè€Œæ˜¯å°†æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯å°è£…åœ¨ Tokenï¼ˆä»¤ç‰Œï¼‰é‡Œï¼Œè®©å®¢æˆ·ç«¯åœ¨æ¯æ¬¡è¯·æ±‚æ—¶æºå¸¦ï¼Œä»è€Œå®ç°èº«ä»½è®¤è¯

**Why JWTï¼Ÿ**

- ğŸ”¹ æ— çŠ¶æ€è®¤è¯ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ Tokenï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å¯ä»¥ç‹¬ç«‹éªŒè¯ç”¨æˆ·èº«ä»½
- ğŸ”¹ è·¨å¹³å°ï¼šJWT é‡‡ç”¨ JSON æ ¼å¼ï¼Œé€‚ç”¨äºå„ç§ Webã€ç§»åŠ¨ç«¯å’Œå¾®æœåŠ¡æ¶æ„
- ğŸ”¹ å®‰å…¨æ€§é«˜ï¼šJWT å¯ä»¥åŠ å¯†ã€ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹å’Œä¼ªé€ 
- ğŸ”¹ é«˜æ•ˆæ€§ï¼šç›¸æ¯”ä¼ ç»Ÿçš„ Session è®¤è¯ï¼ŒJWT ç›´æ¥åœ¨è¯·æ±‚ä¸­æºå¸¦èº«ä»½ä¿¡æ¯ï¼Œå‡å°‘äº†æ•°æ®åº“æŸ¥è¯¢ï¼Œæé«˜äº†æ€§èƒ½

åœ¨ Spring é¡¹ç›®ä¸­ä½¿ç”¨

1ï¸âƒ£ å¼•å…¥ jjwt ä¾èµ–

```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.11.5</version>
</dependency>
```

2ï¸âƒ£ ç¼–å†™ JWT å·¥å…·ç±»

```java
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import java.util.Date;

public class JwtUtil {
    private static final String SECRET_KEY = "your_secret_key";  // ä½ çš„å¯†é’¥
    private static final long EXPIRATION_TIME = 3600000; // 1å°æ—¶

    // ç”Ÿæˆ JWT
    public static String generateToken(String sid) {
        return Jwts.builder()
                .setSubject(sid)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
                .compact();
    }

    // éªŒè¯ JWT
    public static boolean verifyToken(String token, String sid) {
        try {
            Claims claims = Jwts.parser()
                    .setSigningKey(SECRET_KEY)
                    .parseClaimsJws(token)
                    .getBody();
            return claims.getSubject().equals(sid) && claims.getExpiration().after(new Date());
        } catch (Exception e) {
            return false;
        }
    }
}
```

3ï¸âƒ£ åœ¨`/login or /register`æ¥å£æˆåŠŸé€šè¿‡æ—¶ï¼Œè°ƒç”¨`generateToken`å‡½æ•°è¿”å›ä¸€ä¸ª token ç»™å‰ç«¯ç”¨æˆ·ï¼Œç”¨äºåç»­çš„è®¤è¯

### WS æœåŠ¡ç«¯

ä¿®æ”¹è¯·æ±‚è·¯å¾„ï¼Œè¦æ±‚ä¼ å…¥ token å¹¶åœ¨ onOpen å‡½æ•°ä¸­è¿›è¡Œè®¤è¯

```java
@Component
@Slf4j
@Service
@ServerEndpoint("/chat/{sid}/{token}")  // URL é‡Œæ·»åŠ  token å‚æ•°
public class WebSocketServer {
    // å­˜æ”¾æ‰€æœ‰è¿æ¥çš„ WebSocket å®ä¾‹ï¼ˆkey = sidï¼‰
    private static final Map<String, WebSocketServer> webSocketMap = new ConcurrentHashMap<>();
    
    private Session session;
    private String sid = "";
    
    /**
     * æ ¡éªŒ token
     */
    private boolean isValidToken(String token, String sid) {
        // è‹¥ä¸ºç©ºç›´æ¥è¿”å› 0
        if (!StringUtils.hasText(token)) {
            return false;
        }
        // è¿™é‡Œè°ƒç”¨ä½ çš„ JWT è§£ææ–¹æ³•ï¼Œæ ¡éªŒ token æ˜¯å¦æ­£ç¡®
        return JwtUtil.verifyToken(token, sid);
    }

    /**
     * WebSocket è¿æ¥å»ºç«‹æ—¶è§¦å‘
     */
    @OnOpen
    public void onOpen(Session session, @PathParam("sid") String sid, @PathParam("token") String token) {
        log.info("å°è¯•å»ºç«‹ WebSocket è¿æ¥ï¼šsid={}ï¼Œtoken={}", sid, token);

        // è®¤è¯ token
        if (!isValidToken(token, sid)) {
            log.warn("è®¤è¯å¤±è´¥ï¼Œæ‹’ç»è¿æ¥ï¼šsid={}", sid);
            try {
                session.close(new CloseReason(CloseReason.CloseCodes.VIOLATED_POLICY, "è®¤è¯å¤±è´¥"));
            } catch (IOException e) {
                log.error("å…³é—­è¿æ¥å¤±è´¥", e);
            }
            return;
        }

        this.session = session;
        this.sid = sid;

        // ç»´æŠ¤è¿æ¥
        webSocketMap.put(sid, this);

        try {
            sendMessage("è¿æ¥æˆåŠŸï¼Œè®¤è¯é€šè¿‡ï¼");
            log.info("WebSocket è¿æ¥å»ºç«‹æˆåŠŸï¼šsid={}ï¼Œå½“å‰åœ¨çº¿äººæ•°={}", sid, webSocketMap.size());
        } catch (IOException e) {
            log.error("WebSocket å‘é€æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
```

### WS å®¢æˆ·ç«¯

åœ¨è¿æ¥ websocket çš„æ—¶å€™åšç®€å•ä¿®æ”¹å³å¯

```js
let token = localStorage.getItem("token");  // è¿™ä¸ª token ç™»å½•æ—¶è·å–å¹¶å­˜å…¥ localStorage
let room = document.getElementById("room").innerText;
let websocket = new WebSocket(`ws://localhost:8080/chat/${room}/${token}`);
```

