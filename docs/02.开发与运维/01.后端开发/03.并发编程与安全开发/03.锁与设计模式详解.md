---
title: é”ä¸è®¾è®¡æ¨¡å¼è¯¦è§£
date: 2021-8-17
permalink: /pages/699675/
author: 
  name: Arkrypto
  link: https://github.com/Arkrypto
---

## ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜

åªè¦æ˜¯å¹¶å‘ç¼–ç¨‹å¿…é¡»è¦åŠ é”

### ä¼ ç»Ÿçš„ç”Ÿäº§æ¶ˆè´¹å…³ç³»

çº¿ç¨‹é€šä¿¡æµç¨‹ä¸ºï¼šåˆ¤æ–­ç­‰å¾… â†’ æ‰§è¡Œä¸šåŠ¡ â†’ é€šçŸ¥è§£é”

è™šå‡å”¤é†’ï¼šåˆ¤æ–­ç­‰å¾…ä½¿ç”¨ if åˆ¤æ–­ï¼Œå”¤é†’åçº¿ç¨‹ä¼šä»waitä¹‹åçš„ä»£ç å¼€å§‹è¿è¡Œï¼Œä½†æ˜¯ä¸ä¼šé‡æ–°åˆ¤æ–­ if æ¡ä»¶ï¼Œç›´æ¥ç»§ç»­è¿è¡Œ if ä»£ç å—ä¹‹åçš„ä»£ç ï¼Œè€Œå¦‚æœä½¿ç”¨ while çš„è¯ï¼Œä¹Ÿä¼šä» wait ä¹‹åçš„ä»£ç è¿è¡Œï¼Œä½†æ˜¯å”¤é†’åä¼šé‡æ–°åˆ¤æ–­å¾ªç¯æ¡ä»¶ï¼Œå¦‚æœä¸æˆç«‹å†æ‰§è¡Œ while ä»£ç å—ä¹‹åçš„ä»£ç å—ï¼Œæˆç«‹çš„è¯ç»§ç»­ wait

ä¸€ä¸ªè™šå‡å”¤é†’æ¡ˆä¾‹ï¼Œé‡‡ç”¨ if åˆ¤æ–­è€Œé while

~~~java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class SaleTickets3 {
    public static void main(String[] args) {
        Tickets3 t = new Tickets3();

        new Thread(()->{
            try {
                for (int i = 0; i < 5; i++) {
                    t.increase();
                }
            }catch (Exception e){
                e.printStackTrace();
            }
        }, "A").start();
        
        new Thread(()->{
            try{
                for (int i = 0; i < 5; i++) {
                    t.decrease();
                }
            }catch (Exception e){
                e.printStackTrace();
            }
        }, "B").start();
        
        new Thread(()->{
            try{
                for (int i = 0; i < 5; i++) {
                    t.increase();
                }
            }catch (Exception e){
                e.printStackTrace();
            }
        }, "C").start();
        
        new Thread(()->{
            try{
                for (int i = 0; i < 5; i++) {
                    t.decrease();
                }
            }catch (Exception e){
                e.printStackTrace();
            }
        }, "D").start();
    }
}


class Tickets3{

    private int num = 0;

    private Lock l = new ReentrantLock();

    public synchronized void increase() throws InterruptedException{
        if(num!=0){
            this.wait();
        }
        System.out.println(Thread.currentThread().getName()+"=>"+(++num));
        this.notifyAll();
    }

    public synchronized void decrease() throws InterruptedException {
        if(num==0){
            this.wait();
        }
        System.out.println(Thread.currentThread().getName()+"=>"+--num);
        this.notifyAll();
    }
}
~~~

æ³¨æ„ wait() å’Œ notify() æ–¹æ³•è¦æ”¾åœ¨è¢« synchronized ä¿®é¥°çš„åŒæ­¥æ–¹æ³•çš„åŒæ­¥ä»£ç å—ä¸­

è¾“å‡ºç»“æœ

~~~bash
A=>1
B=>0
A=>1
B=>0
A=>1
B=>0
A=>1
B=>0
C=>1
A=>2
C=>3
B=>2
C=>3
D=>2
D=>1
D=>0
C=>1
D=>0
C=>1
D=>0

Process finished with exit code 0
~~~

æˆ‘ä»¬ä¼šå‘ç°ä¸æ˜¯é¢„æƒ³ä¸­çš„0/1äº¤æ›¿ï¼Œå‡ºç°äº†2ç”šè‡³3ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ decrease() åçš„ç¬é—´ï¼ŒnotifyAll() å°†æ‰€æœ‰çº¿ç¨‹å”¤é†’ï¼Œè§£é”ï¼Œæ‰§è¡Œ increase() ä¸­ wait() ä¹‹åçš„è¯­å¥ï¼Œif ä»…åšä¸€æ¬¡åˆ¤æ–­ï¼Œè¿™æ¬¡å”¤é†’åä¸ä¼šå¯¹å½“å‰ num è¿›è¡Œåˆ¤æ–­ï¼Œå°†ç›´æ¥æ‰§è¡Œåç»­è¯­å¥ï¼Œé€ æˆè™šå‡å”¤é†’ã€‚å¯ä»¥æƒ³è±¡ num å˜ä¸º 3 æ˜¯å› ä¸ºè¿ç»­ä¸¤æ¬¡ decrease() ä¸­çš„ notifyAll() éƒ½å”¤é†’äº†ä¸¤ä¸ª increase() å…±è¿›è¡Œå››æ¬¡åŠ æ³•æ“ä½œï¼Œå¤¹æ‚ä¸€æ¬¡å‡æ³•æ“ä½œï¼Œæ•…å¾— 3

è‹¥å°† if æ¢æˆ while å°†å¾ˆå®¹æ˜“è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ increase() è¢«å”¤é†’åï¼Œwhile å¾ªç¯å°†é‡æ–°å¯¹ num çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼ŒæˆåŠŸé˜²æ­¢è™šå‡å”¤é†’

è·Œè«ï¼Œè™½ç„¶æ¢æˆ while ä¸ä¼šæœ‰æ­£ç¡®æ€§ä¸Šçš„é—®é¢˜ï¼Œä½†æ˜¾ç„¶å­˜åœ¨è¿›ç¨‹çš„å¿™ç­‰

### Lock é”çš„ç”Ÿäº§æ¶ˆè´¹å…³ç³»

> Lock.newCondition

Condition ä¸º Lock çš„ç›‘å¬å™¨ï¼ŒåŒ…å« await()ã€signal()ã€signalAll() æ–¹æ³•ï¼ŒåŠŸèƒ½åˆ†åˆ«å¯¹åº” wait()ã€notify()ã€notifyAll()

å…·ä½“å®ç°ï¼š

~~~java
class Shoes{

    int num = 5;
    //ç”¨çŠ¶æ€ç å»åˆ¤æ–­æ˜¯å¦è®©çº¿ç¨‹ç­‰å¾…
    int status = 1;
    Lock l = new ReentrantLock();
    Condition c1 = l.newCondition();
    Condition c2 = l.newCondition();
    Condition c3 = l.newCondition();
    Condition c4 = l.newCondition();

    public void sale(){
        l.lock();
        try{
            while(num<=0 || status!=1){
                c1.await();
            }
            System.out.println(Thread.currentThread().getName()+":å½“å‰åº“å­˜" + num + "ï¼Œå”®å‡ºä¸€ä»¶ï¼Œå‰©ä½™" + (--num));
            status = 2;
            c2.signal();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            l.unlock();
        }
    }

    public void transfer(){
        l.lock();
        try{
            while(status!=2){
                c2.await();
            }
            System.out.print(Thread.currentThread().getName()+":å¼€å§‹è¿é€é‹å­ â€”â€”> ");
            TimeUnit.SECONDS.sleep(2);
            System.out.println("è¿é€åˆ°å®¶");
            status = 3;
            c3.signal();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            l.unlock();
        }
    }

    public void sign(){
        l.lock();
        try{
            while(status!=3){
                c3.await();
            }
            System.out.println(Thread.currentThread().getName() + ":ç”¨æˆ·å·²ç­¾æ”¶\n");
            status = 1;
            c1.signal();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            l.unlock();
        }
    }
}
~~~

å®ç°äº†å¯¹çº¿ç¨‹ï¼ˆæ–¹æ³•ï¼‰çš„ç²¾ç¡®å”¤é†’

## å…«é”ç°è±¡

é”æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•åˆ¤æ–­é”çš„æ˜¯è°ï¼Ÿå…³äºé”çš„å…«ä¸ªé—®é¢˜

### ä¸¤ä¸ªåŒæ­¥æ–¹æ³•

1ï¸âƒ£ ä¸¤ä¸ªåŒæ­¥æ–¹æ³• p.sendMs() å’Œ p.call() è°å…ˆæ‰§è¡Œï¼Ÿ

2ï¸âƒ£ è‹¥åœ¨ sendMs() ä¸­ä»¤å…¶ç¡çœ  2 ç§’ï¼Œè°å…ˆæ‰§è¡Œï¼Ÿ

æ“ä½œåŒä¸€å¯¹è±¡æ—¶ï¼Œä¸€ä¸ªå¯¹è±¡åªå¯¹åº”ä¸€æŠŠé”ï¼Œå¯¹äºåŒæ­¥æ–¹æ³•ï¼Œå“ªä¸ªå…ˆæ‹¿åˆ°é”å“ªä¸ªå…ˆæ‰§è¡Œï¼Œå¦ä¸€ä¸ªå¾—ç­‰é”è§£å¼€åæ‰èƒ½æ‰§è¡Œï¼Œè€Œè°å…ˆæ‹¿åˆ°ä¸ä»£ç çš„é¡ºåºæœ‰å…³ï¼Œåœ¨æ­¤å¤„ sendMs() å…ˆæ‹¿åˆ°é”ï¼Œå¿…ç„¶å…ˆæ‰§è¡ŒsendMs()ï¼ŒåŒæ—¶ call() è¢«é”ä¸Šä¸èƒ½æ‰§è¡Œ

~~~java
public class Test1 {
    public static void main(String[] args) throws InterruptedException {
        Phone1 p = new Phone1();
        new Thread(()->{p.sendMs();}, "A").start();

        TimeUnit.SECONDS.sleep(2);

        new Thread(()->{p.call();}, "B").start();
    }
}

class Phone1{
    public synchronized void sendMs(){
        TimeUnit.SECONDS.sleep(2);
        System.out.println(Thread.currentThread().getName() + " å‘é€ä¿¡æ¯");
    }

    public synchronized void call(){
        System.out.println(Thread.currentThread().getName() + " æ‹¨æ‰“ç”µè¯");
    }
}
~~~

### åŒæ­¥æ–¹æ³•å’Œæ™®é€šæ–¹æ³•

3ï¸âƒ£ å½“åŒæ­¥æ–¹æ³•ç¢°ä¸Šæ™®é€šæ–¹æ³• p.sendMs() å’Œ p.sayHello() è°å…ˆæ‰§è¡Œï¼Ÿ

sayHello() å¹¶ä¸æ˜¯åŒæ­¥æ–¹æ³•ï¼Œä¸å—é”çš„å½±å“ï¼Œç”±äº sendMs() ç¡çœ äº†2sï¼ŒsayHello() è‡ªç„¶å°†åœ¨å…¶ä¹‹å‰è¢«æ‰§è¡Œ

~~~java
import java.util.concurrent.TimeUnit;

public class Test2 {
    public static void main(String[] args){
        Phone2 p = new Phone2();
        new Thread(()->{
            try {
                p.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "B").start();
        new Thread(()->{p.sayHello();}, "A").start();

    }

}

class Phone2{
    public synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(2);
        System.out.println(Thread.currentThread().getName() + " å‘é€ä¿¡æ¯");
    }

    public void sayHello(){
        System.out.println(Thread.currentThread().getName() + " Hello");
    }
}
~~~

4ï¸âƒ£ å¯¹äºä¸¤ä¸ªä¸åŒå¯¹è±¡p1ã€p2ï¼Œé—®æ™®é€šåŒæ­¥æ–¹æ³• p1.sendMs() å’Œ p2.call() è°å…ˆæ‰§è¡Œï¼Ÿ

å½“å­˜åœ¨ä¸¤ä¸ªå¯¹è±¡æ—¶ï¼Œä¸€ä¸ªå¯¹è±¡ä¸€æŠŠé”ï¼Œå„è‡ªçš„åŒæ­¥æ–¹æ³•äº’ä¸å½±å“ï¼Œè‡ªç„¶ä½å»¶è¿Ÿçš„ call() æ–¹æ³•å…ˆæ‰§è¡Œ

~~~java
import java.util.concurrent.TimeUnit;

public class Test3 {
    public static void main(String[] args){
        Phone3 p1 = new Phone3();
        Phone3 p2 = new Phone3();

        new Thread(()->{
            try {
                p1.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();

        new Thread(()->{p2.call();}).start();
    }
}


class Phone3{
    public synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(2);
        System.out.println(Thread.currentThread().getName() + " å‘é€ä¿¡æ¯");
    }

    public synchronized void call() {
        System.out.println(Thread.currentThread().getName() + " æ‹¨æ‰“ç”µè¯");
    }
}
~~~

### é™æ€åŒæ­¥æ–¹æ³•

5ï¸âƒ£ å¯¹æ™®é€šåŒæ­¥æ–¹æ³•åŠ ä¸Š static è¿›è¡Œä¿®é¥°ï¼ˆé™æ€åŒæ­¥æ–¹æ³•ï¼‰ï¼Œ p.sendMs() å’Œ p.call() è°å…ˆæ‰§è¡Œï¼Ÿ

static synchronized æ–¹æ³•ï¼Œå¯¹æ•´ä¸ªç±»è¿›è¡ŒåŒæ­¥ï¼Œæ­¤æ—¶ sendMs() å’Œ call() ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œè‡ªç„¶åè€…ä¼šè¢«é”ä½ï¼ŒsendMs() å…ˆæ‰§è¡Œ

~~~java
import java.util.concurrent.TimeUnit;

public class Test4 {
    public static void main(String[] args){
        Phone4 p = new Phone4();

        new Thread(()->{
            try {
                p.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();

        new Thread(()->{p.call();}).start();
    }
}


class Phone4{
    public static synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(2);
        System.out.println(Thread.currentThread().getName() + " å‘é€ä¿¡æ¯");
    }

    public static synchronized void call() {
        System.out.println(Thread.currentThread().getName() + " æ‹¨æ‰“ç”µè¯");
    }
}
~~~

6ï¸âƒ£ ç¬¬ 5 ä¸ªé—®é¢˜çš„æ·±åŒ–ç†è§£ï¼Œå¯¹äºç±»çš„ä¸åŒçš„ä¸¤ä¸ªå¯¹è±¡ p1ã€p2ï¼Œå½“ synchronized æœ‰ static ä¿®é¥°ï¼Œp1.sendMs() å’Œ p2.call() è°å…ˆæ‰§è¡Œï¼Ÿ

å½“æœ‰ static ä¿®é¥° synchronized æ–¹æ³•æ—¶ï¼ŒåŒæ­¥é”é”çš„æ˜¯å½“å‰è¿™ä¸ªç±»ï¼ˆClasså¯¹è±¡ã€ç±»æ¨¡æ¿ï¼‰ï¼Œæ­¤æ—¶ p1.sendMs() å’Œ p2.call() ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œcall() è¢« sendMs() é”ä½ï¼Œè‡ªç„¶ sendMs() å…ˆæ‰§è¡Œ

~~~java
import java.util.concurrent.TimeUnit;

public class Test4 {
    public static void main(String[] args){
        Phone4 p1 = new Phone4();
        Phone4 p2 = new Phone4();

        new Thread(()->{
            try {
                p1.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();

        new Thread(()->{p2.call();}).start();
    }
}


class Phone4{
    public static synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(2);
        System.out.println(Thread.currentThread().getName() + " å‘é€ä¿¡æ¯");
    }

    public static synchronized void call() {
        System.out.println(Thread.currentThread().getName() + " æ‹¨æ‰“ç”µè¯");
    }
}
~~~

### é™æ€åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥æ–¹æ³•

7ï¸âƒ£ å½“é™æ€åŒæ­¥æ–¹æ³•ç¢°åˆ°æ™®é€šåŒæ­¥æ–¹æ³•ï¼Œç”¨åŒä¸€å¯¹è±¡è°ƒç”¨ï¼ŒsendMs å’Œ call è°å…ˆæ‰§è¡Œï¼Ÿ

å¾ˆæ˜æ˜¾æ­¤æ—¶ p.sendMs() å’Œ p.call() ç”¨çš„ä¸æ˜¯åŒä¸€æŠŠé”ï¼Œå‰è€…ç”¨çš„æ˜¯ç±»æ¨¡æ¿çš„é”ï¼Œåè€…ç”¨çš„æ˜¯å½“å‰å¯¹è±¡çš„é”ï¼Œå‰è€…å¹¶ä¸å¯¹åè€…äº§ç”Ÿçº¦æŸï¼ŒåŠ ä¸Šç¡çœ äº† 2sï¼Œè‡ªç„¶ call() å…ˆæ‰§è¡Œ

~~~java
import java.util.concurrent.TimeUnit;

public class Test5 {
    public static void main(String[] args) {
        Phone5 p = new Phone5();
        Phone5 p1 = new Phone5();
        Phone5 p2 = new Phone5();

        new Thread(()->{
            try {
                p.sendMs();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "p.sendMs").start();

        new Thread(()->{p.call();}, "p.call").start();
    }
}

class Phone5{
    public static synchronized void sendMs() throws InterruptedException {
        TimeUnit.SECONDS.sleep(2);
        System.out.println(Thread.currentThread().getName() + " å‘é€ä¿¡æ¯");
    }

    public synchronized void call() {
        System.out.println(Thread.currentThread().getName() + " æ‹¨æ‰“ç”µè¯");
    }
}
~~~

8ï¸âƒ£ å½“ 7 ä¸­ä¾‹å­æ¢ä¸ºä¸¤ä¸ªå¯¹è±¡ p1 å’Œ p2ï¼Œé—® p1.sendMs() å’Œ p2.call() è°å…ˆæ‰§è¡Œï¼Ÿ

ä¸ 7 åŒç†ï¼ŒäºŒè€…ç”¨çš„å¹¶ä¸æ˜¯åŒä¸€æŠŠé”ï¼Œä¹‹é—´äº’ä¸å½±å“ï¼Œä½å»¶è¿Ÿçš„ call å…ˆæ‰§è¡Œ

- static synchronizedï¼šé”çš„æ˜¯ Classï¼Œå”¯ä¸€çš„ä¸€ä¸ªæ¨¡æ¿
- synchronizedï¼šé”çš„æ˜¯ new thisï¼Œå…·ä½“çš„ä¸€ä¸ªå¯¹è±¡

## å„ç§é”çš„ç†è§£

### å…¬å¹³é”å’Œéå…¬å¹³é”

å…¬å¹³é”ï¼šå¾ˆå…¬å¹³çš„é”ï¼Œä¸å¯ä»¥æ’é˜Ÿï¼Œå¿…é¡»å…ˆæ¥ååˆ°

```java
Lock lock = new ReentrantLock();

public ReentrantLock() {
    sync = new NonfairSync();
}
```

éå…¬å¹³é”ï¼šä¸å…¬å¹³çš„é”ï¼Œå¯ä»¥æ’é˜Ÿï¼ˆé»˜è®¤éƒ½æ˜¯éå…¬å¹³ï¼‰

~~~java
Lock lock = new ReentrantLock(true);

public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
~~~

### å¯é‡å…¥é”

> ä¹Ÿå«é€’å½’é”ï¼Œæ‰€æœ‰çš„é”éƒ½æ˜¯å¯é‡å…¥é”ï¼Ÿ
>

åªè¦æ‹¿åˆ°äº†å¤–é¢çš„é”ï¼Œå°±è‡ªåŠ¨æ‹¿åˆ°äº†å†…éƒ¨çš„é”ï¼Œå¦‚ä¸€ä¸ªåŒæ­¥æ–¹æ³•ä¸­è°ƒç”¨äº†å¦ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œåœ¨å•ä¸ªçº¿ç¨‹æ‹¿åˆ°å¤–éƒ¨æ–¹æ³•çš„é”æ—¶ï¼Œä¹Ÿè‡ªåŠ¨åŒæ—¶æ‹¿åˆ°äº†å†…éƒ¨åŒæ­¥æ–¹æ³•çš„é”

synchronized

~~~java
public class Demo01 {
    public static void main(String[] args) {
        Phone01 phone = new Phone01();

        new Thread(()->{
            phone.sendMs();
        }, "A").start();

        new Thread(()->{
            phone.call();
        }, "B").start();
    }
}

class Phone01{
    public synchronized void sendMs(){
        call();
        System.out.println(Thread.currentThread().getName() + " å‘çŸ­ä¿¡");
    }

    public synchronized void call(){
        System.out.println(Thread.currentThread().getName() + " æ‰“ç”µè¯");
    }
}
~~~

Lock

~~~java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class Demo02 {
    public static void main(String[] args) {
        Phone02 phone02 = new Phone02();

        new Thread(()->{
            phone02.sendMs();
        }, "A").start();

        new Thread(()->{
            phone02.sendMs();
        }, "B").start();
    }
}

class Phone02{
    private Lock lock = new ReentrantLock();

    public void sendMs(){
        lock.lock();
        try{
            call();
            System.out.println(Thread.currentThread().getName() + " å‘çŸ­ä¿¡");
        }catch (Exception e){
            System.out.println(e.getMessage());
        }finally {
            lock.unlock();
        }
    }

    public void call(){
        lock.lock();
        try{
            System.out.println(Thread.currentThread().getName() + " æ‰“ç”µè¯");
        }catch (Exception e){
            System.out.println(e.getMessage());
        }finally {
            lock.unlock();
        }
    }
}
~~~

æ³¨æ„ï¼šLock é”çš„ lock å’Œ unlock å¿…é¡»é…å¯¹ï¼Œå¦åˆ™å°±ä¼šæ­»é”

### è‡ªæ—‹é”å’Œæ­»é”

- è‡ªæ—‹é”ï¼ˆSpin Lockï¼‰ï¼šåŸå­ç±» AtomicInteger çš„ getAndAddInt æ–¹æ³•æ­£æ˜¯ç”¨çš„è‡ªæ—‹é”ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª`do{} while()`å¾ªç¯
- æ­»é”ï¼ˆDead Lockï¼‰ï¼šæ¯”å¦‚`ReentrantLock l`é”`l.lock()`åå¿˜è®°`l.unlock()`äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰ç­‰å¾…é”`l`çš„çº¿ç¨‹éƒ½ä¼šå¡æ­»ï¼Œå³ä¸ºæ­»é”

## äºŒåä¸‰ç§è®¾è®¡æ¨¡å¼

â€œ23ç§è®¾è®¡æ¨¡å¼â€æ˜¯æŒ‡ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ï¼ˆDesign Patterns: Elements of Reusable Object-Oriented Softwareï¼‰ä¸€ä¹¦ä¸­æ€»ç»“çš„ 23 ç§ç»å…¸ GoF è®¾è®¡æ¨¡å¼ï¼ˆGang of Fourï¼Œå››äººå¸®ï¼‰ã€‚è¿™äº›æ¨¡å¼åˆ†ä¸ºä¸‰å¤§ç±»ï¼šåˆ›å»ºå‹ã€ç»“æ„å‹å’Œè¡Œä¸ºå‹

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¸®åŠ©è®°å¿†

- åˆ›å»ºå‹ï¼ˆ5ä¸ªï¼‰ â†’ "å•å·¥æŠ½å»ºåŸ"
- ç»“æ„å‹ï¼ˆ7ä¸ªï¼‰ â†’ "é€‚è£…ä»£å¤–æ¡¥ç»„äº«"
- è¡Œä¸ºå‹ï¼ˆ11ä¸ªï¼‰ â†’ "ç­–æ¨¡è§‚è¿­è´£å‘½çŠ¶å¤‡ä¸­è§£è®¿"

### åˆ›å»ºå‹æ¨¡å¼

ä¸»è¦è§£å†³â€œå¯¹è±¡çš„åˆ›å»ºâ€é—®é¢˜

| æ¨¡å¼                                | è¯´æ˜                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| 1. å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰            | ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹                     |
| 2. å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Methodï¼‰   | å®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»             |
| 3. æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factoryï¼‰ | æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£                   |
| 4. å»ºé€ è€…æ¨¡å¼ï¼ˆBuilderï¼‰            | å°†å¤æ‚å¯¹è±¡çš„æ„å»ºä¸å…¶è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒè¡¨ç¤º |
| 5. åŸå‹æ¨¡å¼ï¼ˆPrototypeï¼‰            | é€šè¿‡å¤åˆ¶å·²æœ‰å¯¹è±¡æ¥åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡ new                 |

### ç»“æ„å‹æ¨¡å¼

ä¸»è¦è§£å†³â€œç±»æˆ–å¯¹è±¡çš„ç»„åˆâ€é—®é¢˜

| æ¨¡å¼                       | è¯´æ˜                                               |
| -------------------------- | -------------------------------------------------- |
| 6. é€‚é…å™¨æ¨¡å¼ï¼ˆAdapterï¼‰   | å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·æœŸæœ›çš„æ¥å£ï¼ˆâ€œæ’å¤´è½¬æ¢å™¨â€ï¼‰ |
| 7. è£…é¥°å™¨æ¨¡å¼ï¼ˆDecoratorï¼‰ | åŠ¨æ€åœ°ä¸ºå¯¹è±¡æ·»åŠ é¢å¤–åŠŸèƒ½ï¼ˆâ€œåŒ…è£…â€ï¼‰                 |
| 8. ä»£ç†æ¨¡å¼ï¼ˆProxyï¼‰       | ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹å®ƒçš„è®¿é—®             |
| 9. å¤–è§‚æ¨¡å¼ï¼ˆFacadeï¼‰      | ä¸ºå­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªç»Ÿä¸€çš„é«˜å±‚æ¥å£         |
| 10. æ¡¥æ¥æ¨¡å¼ï¼ˆBridgeï¼‰     | å°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–               |
| 11. ç»„åˆæ¨¡å¼ï¼ˆCompositeï¼‰  | å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„æ¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„    |
| 12. äº«å…ƒæ¨¡å¼ï¼ˆFlyweightï¼‰  | è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆæ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡ï¼ˆèŠ‚çœå†…å­˜ï¼‰     |

### è¡Œä¸ºå‹æ¨¡å¼

ä¸»è¦è§£å†³â€œå¯¹è±¡ä¹‹é—´çš„äº¤äº’â€é—®é¢˜

| æ¨¡å¼                                      | è¯´æ˜                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| 13. ç­–ç•¥æ¨¡å¼ï¼ˆStrategyï¼‰                  | å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’æ¢                               |
| 14. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Methodï¼‰       | å®šä¹‰ä¸€ä¸ªæ“ä½œçš„æ¡†æ¶ï¼Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­å®ç°               |
| 15. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverï¼‰                | å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šä¾èµ–å…³ç³»ï¼ˆå‘å¸ƒ-è®¢é˜…ï¼‰                  |
| 16. è¿­ä»£å™¨æ¨¡å¼ï¼ˆIteratorï¼‰                | æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®èšåˆå¯¹è±¡ï¼Œè€Œä¸æš´éœ²å…¶å†…éƒ¨ç»“æ„             |
| 17. è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibilityï¼‰ | ä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼ˆé“¾å¼ä¼ é€’ï¼‰                       |
| 18. å‘½ä»¤æ¨¡å¼ï¼ˆCommandï¼‰                   | å°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œå¯ç”¨ä¸åŒè¯·æ±‚ã€é˜Ÿåˆ—æˆ–æ—¥å¿—æ¥å‚æ•°åŒ–å®¢æˆ·ç«¯ |
| 19. çŠ¶æ€æ¨¡å¼ï¼ˆStateï¼‰                     | å…è®¸å¯¹è±¡åœ¨å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸º                         |
| 20. å¤‡å¿˜å½•æ¨¡å¼ï¼ˆMementoï¼‰                 | åœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹æ•è·å¹¶æ¢å¤å¯¹è±¡çŠ¶æ€                     |
| 21. ä¸­ä»‹è€…æ¨¡å¼ï¼ˆMediatorï¼‰                | ç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡å°è£…ä¸€ç³»åˆ—å¯¹è±¡äº¤äº’                             |
| 22. è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreterï¼‰             | ç»™å®šè¯­è¨€å®šä¹‰æ–‡æ³•çš„ä¸€ç§è¡¨ç¤ºï¼Œå¹¶å®šä¹‰è§£é‡Šå™¨                     |
| 23. è®¿é—®è€…æ¨¡å¼ï¼ˆVisitorï¼‰                 | å°è£…æŸäº›ä½œç”¨äºæ•°æ®ç»“æ„ä¸­å…ƒç´ çš„æ“ä½œï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜ç»“æ„çš„æƒ…å†µä¸‹å®šä¹‰æ–°æ“ä½œ |

## å•ä¾‹æ¨¡å¼

åˆ›å»ºå‹æ¨¡å¼ï¼Œè§£å†³å¯¹è±¡çš„åˆ›å»ºé—®é¢˜

### å•ä¾‹æ¨¡å¼æ¦‚è¿°

å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰æ˜¯ Java ä¸­æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚

è¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œè¯¥ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚

æ³¨æ„

- å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹
- å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹
- å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹

æ„å›¾ï¼šä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹

- ä¸»è¦è§£å†³ï¼šä¸€ä¸ªå…¨å±€ä½¿ç”¨çš„ç±»é¢‘ç¹åœ°åˆ›å»ºä¸é”€æ¯
- ä½•æ—¶ä½¿ç”¨ï¼šå½“æ‚¨æƒ³æ§åˆ¶å®ä¾‹æ•°ç›®ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æºçš„æ—¶å€™
- å¦‚ä½•è§£å†³ï¼šåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
- å…³é”®ä»£ç ï¼šæ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„

ä¾‹å­

- ä¸€ä¸ªç­çº§åªæœ‰ä¸€ä¸ªç­ä¸»ä»»
- Windows æ˜¯å¤šè¿›ç¨‹å¤šçº¿ç¨‹çš„ï¼Œåœ¨æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå°±ä¸å¯é¿å…åœ°å‡ºç°å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„ç°è±¡ï¼Œæ‰€ä»¥æ‰€æœ‰æ–‡ä»¶çš„å¤„ç†å¿…é¡»é€šè¿‡å”¯ä¸€çš„å®ä¾‹æ¥è¿›è¡Œ
- ä¸€äº›è®¾å¤‡ç®¡ç†å™¨å¸¸å¸¸è®¾è®¡ä¸ºå•ä¾‹æ¨¡å¼ï¼Œæ¯”å¦‚ä¸€ä¸ªç”µè„‘æœ‰ä¸¤å°æ‰“å°æœºï¼Œåœ¨è¾“å‡ºçš„æ—¶å€™å°±è¦å¤„ç†ä¸èƒ½ä¸¤å°æ‰“å°æœºæ‰“å°åŒä¸€ä¸ªæ–‡ä»¶

ä¼˜ç‚¹

- åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯å®ä¾‹ï¼ˆæ¯”å¦‚ç®¡ç†å­¦é™¢é¦–é¡µé¡µé¢ç¼“å­˜ï¼‰
- é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼ˆæ¯”å¦‚å†™æ–‡ä»¶æ“ä½œï¼‰

ç¼ºç‚¹ï¼šæ²¡æœ‰æ¥å£ï¼Œä¸èƒ½ç»§æ‰¿ï¼Œä¸å•ä¸€èŒè´£åŸåˆ™å†²çªï¼Œä¸€ä¸ªç±»åº”è¯¥åªå…³å¿ƒå†…éƒ¨é€»è¾‘ï¼Œè€Œä¸å…³å¿ƒå¤–é¢æ€ä¹ˆæ ·æ¥å®ä¾‹åŒ–

ä½¿ç”¨åœºæ™¯

- è¦æ±‚ç”Ÿäº§å”¯ä¸€åºåˆ—å·
- WEB ä¸­çš„è®¡æ•°å™¨ï¼Œä¸ç”¨æ¯æ¬¡åˆ·æ–°éƒ½åœ¨æ•°æ®åº“é‡ŒåŠ ä¸€æ¬¡ï¼Œç”¨å•ä¾‹å…ˆç¼“å­˜èµ·æ¥
- åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡éœ€è¦æ¶ˆè€—çš„èµ„æºè¿‡å¤šï¼Œæ¯”å¦‚ I/O ä¸æ•°æ®åº“çš„è¿æ¥ç­‰

æ³¨æ„äº‹é¡¹ï¼šgetInstance() æ–¹æ³•ä¸­éœ€è¦ä½¿ç”¨åŒæ­¥é” synchronized (Singleton.class) é˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶è¿›å…¥é€ æˆ instance è¢«å¤šæ¬¡å®ä¾‹åŒ–

### é¥¿æ±‰å¼å•ä¾‹

çº¿ç¨‹å®‰å…¨ï¼Œä½†ä¼šé€ æˆèµ„æºæµªè´¹

~~~java
//é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼
public class Hungry {
    private Hungry() {}

    private static Hungry HUNGRY = new Hungry();

    private byte[] data1 = new byte[1024*1024];
    private byte[] data2 = new byte[1024*1024];
    private byte[] data3 = new byte[1024*1024];
    private byte[] data4 = new byte[1024*1024];

    public static Hungry getInstance(){
        return HUNGRY;
    }

    public static void main(String[] args) {
        Hungry hungry = Hungry.getInstance();
        Hungry hungry1 = Hungry.getInstance();
        System.out.println(hungry.hashCode());
        System.out.println(hungry1.hashCode());
    }
}
~~~

### æ‡’æ±‰å¼å•ä¾‹

çº¿ç¨‹ä¸å®‰å…¨ï¼Œå¤šçº¿ç¨‹è·‘æ—¶å°†å‘ç”Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è·‘ä¸€ä¸ª LazyMan() æ–¹æ³•ï¼Œå³ä½¿è¿”å›åŒä¸€ä¸ª LazyMan å¯¹è±¡ã€‚å¯¹ getInstance() æ–¹æ³•ç”¨ synchronized ä¿®é¥°å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œä½†ä¼šå¤§å¤§é™ä½æ•ˆç‡

~~~java
public class LazyMan {
    private LazyMan(){
        System.out.println(Thread.currentThread().getName() + " ok");
    }

    private static LazyMan LazyMan;

    public static LazyMan getInstance(){
        if(LazyMan==null){
            LazyMan = new LazyMan();
        }
        return LazyMan;
    }

    public static void main(String[] args) {
        for (int i = 0; i < 10; i++) {
            new Thread(()->{
                LazyMan.getInstance();
            }).start();
        }
    }
}
~~~

### DCL æ‡’æ±‰å¼

æ¨èä½¿ç”¨

Double Check Lockï¼Œä¸€èˆ¬æƒ…å†µä¸‹çº¿ç¨‹å®‰å…¨ï¼Œä½†ä¸ç»å¯¹å®‰å…¨

~~~java
DCLLAZYMAN = new DCLLayzMan();
~~~

è¿™è¡Œä»£ç å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œ

1. åˆ†é…å†…å­˜ç©ºé—´
2. æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–å¯¹è±¡
3. æŠŠè¿™ä¸ªå¯¹è±¡æŒ‡å‘è¿™å—ç©ºé—´

**éœ€è¦æ³¨æ„ä¸€å®šè¦ä»¤ DCLLAZYMAN é¿å…æŒ‡ä»¤é‡æ’**

æˆ‘ä»¬å¸Œæœ›çš„é¡ºåºä¸º123ï¼Œä½†ç»è¿‡æŒ‡ä»¤é‡æ’å¯èƒ½ä¸º132ï¼Œå¦‚æ­¤åœ¨è¿›è¡Œåˆ¤æ–­æ—¶ï¼Œæœ‰å¯èƒ½ A çº¿ç¨‹ç»è¿‡ï¼ˆ3ï¼‰æŠŠDACLLAZYMAN æŒ‡å‘äº†ä¸€å—ç©ºé—´ï¼ŒB çº¿ç¨‹æ­¤æ—¶åˆ¤å®š DCLLAZYMAN ä¸ä¸º null å¾€ä¸‹æ‰§è¡Œï¼Œç›´æ¥è¿”å› DCLLAZYMANï¼Œè€Œæ­¤æ—¶å¯¹è±¡æœªè¢«åˆå§‹åŒ–ï¼Œé€ æˆé”™è¯¯ï¼ˆå³ä½¿è¿™ç§æ¦‚ç‡éå¸¸éå¸¸å°ï¼‰

~~~java
public class DCLLazyMan {
    private DCLLazyMan(){
        System.out.println(Thread.currentThread().getName() + " ok");
    }

    private static DCLLazyMan DCLLAZYMAN;

    public static DCLLazyMan getInstance(){
        if(DCLLAZYMAN == null){
            synchronized (DCLLazyMan.class){
                if(DCLLAZYMAN == null){
                    DCLLAZYMAN = new DCLLazyMan();
                }
            }
        }
        return DCLLAZYMAN;
    }

    public static void main(String[] args) {
        for (int i = 0; i < 10; i++) {
            new Thread(()->{
                DCLLazyMan.getInstance();
            }).start();
        }
    }
}
~~~

ä¸ºäº†é˜²æ­¢æœ‰äººç”¨åå°„ç ´è§£è¯¥å•ä¾‹ï¼Œå³ setAccessable(true)ï¼Œå¯åœ¨æ„é€ æ–¹æ³•ä¸­åŠ ä¸€æŠŠé”ï¼ŒåŒæ—¶æŠ›å‡ºå¼‚å¸¸

~~~java
private DCLLazyMan(){
    synchronzed(DCLLazyMan.class){
        if(LAZYMAN != null){
            Throw new RuntimeException("ä¸è¦è¯•å›¾ç”¨åå°„ç ´åå•ä¾‹");
        }
    }
    System.out.println(Thread.currentThread().getName() + " ok");
}
~~~

### é™æ€å†…éƒ¨ç±»

ç§€æ“ä½œ

~~~java
public class Holder {

    private Holder(){
        System.out.println(Thread.currentThread().getName() + " ok");
    }

    public static Holder getInstance(){
        return Inner.HOLDER;
    }

    private static class Inner{
        private static Holder HOLDER = new Holder();
    }

    public static void main(String[] args) {
        for (int i = 0; i < 100; i++) {
            new Thread(()->{
                Holder.getInstance();
            }).start();
        }
    }
}
~~~

### æšä¸¾ç±» Enum

enum æ˜¯ä»€ä¹ˆï¼Ÿå…¶æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª Class ç±»

ç®€å•ï¼Œè¾ƒå®‰å…¨

~~~java
public enum EnumSingle {

    INSTANCE;

    public EnumSingle getInstance(){
        return INSTANCE;
    }

    public static void main(String[] args) {
        for (int i = 0; i < 1000; i++) {
            new Thread(()->{
                //æˆ–ç”¨ EnucSingle.getInstance()ï¼Œä¸€æ ·çš„
                System.out.println(EnumSingle.INSTANCE.hashCode());
            }).start();
        }
    }
}
~~~

## å·¥å‚æ¨¡å¼

åˆ›å»ºå‹æ¨¡å¼

### ç®€å•å·¥å‚æ¨¡å¼

â€œç®€å•å·¥å‚æ¨¡å¼â€ï¼ˆSimple Factoryï¼‰å¹¶ä¸åœ¨ GoF çš„ 23 ç§è®¾è®¡æ¨¡å¼ä¸­ï¼Œä½†å®ƒæ˜¯æœ€å¸¸ç”¨ã€æœ€ç›´è§‚ã€æœ€å®¹æ˜“ç†è§£å’Œè¢«å®é™…ç”¨åˆ°çš„ä¸€ç§å·¥å‚å®ç°ï¼Œåœ¨æ•™å­¦å’Œå·¥ç¨‹ä¸­å¸¸å¸¸ä½œä¸ºå¼•å…¥å·¥å‚æ¨¡å¼çš„èµ·ç‚¹

- ç®€å•å·¥å‚æ¨¡å¼æŒ‡çš„æ˜¯ï¼šæŠŠåˆ›å»ºå¯¹è±¡çš„é€»è¾‘é›†ä¸­æ”¾åˆ°**ä¸€ä¸ªå·¥å‚ç±»çš„é™æ€æ–¹æ³•ä¸­**ï¼Œæ ¹æ®ä¼ å…¥å‚æ•°å†³å®šåˆ›å»ºå“ªä¸ªç±»çš„å®ä¾‹

æ¯”å¦‚ AuthService ä¸­æˆ‘æ‰‹åŠ¨è¿”å›å¯¹åº”çš„å¯†ç ç³»ç»Ÿï¼Œåœ¨è¿™é‡Œæ¯ä¸ªå¯†ç ç³»ç»Ÿéƒ½æ˜¯ä¸€ä¸ªå•ä¾‹ï¼ˆåœ¨ Spring ä¸­ä½œä¸º Bean æ³¨å…¥ï¼‰

```java
@Service
public class AuthService {

    private final CipherSystem schnorr_rfid, rsa, schnorr, elgamal;
    @Autowired
    public AuthService(Schnorr schnorr_rfid, RSA rsa, cia.arkrypto.auth.crypto.impl.Schnorr schnorr, Elgamal elgamal){
        this.schnorr_rfid = schnorr_rfid;
        this.rsa = rsa;
        this.schnorr = schnorr;
        this.elgamal = elgamal;
    }


    public CipherSystem selectSystem(String algo){
        if (algo.equalsIgnoreCase("schnorr")){
            return schnorr;
        } else if (algo.equalsIgnoreCase("rsa")){
            return rsa;
        } else if (algo.equalsIgnoreCase("elgamal")){
            return elgamal;
        } else if (algo.equalsIgnoreCase("schnorr_rfid")){
            return schnorr_rfid;
        }
        return null;
    }


    public KeyPair keygen(String algo){
        CipherSystem cipherSystem = selectSystem(algo);
        if(cipherSystem == null){
            return null;
        }
        return cipherSystem.keygen();
    }


    public CryptoMap sign(String algo, String message, CryptoMap sk){
        CipherSystem cipherSystem = selectSystem(algo);
        if(cipherSystem == null){
            return null;
        }
        return cipherSystem.sign(message, sk);
    }

    public Boolean verify(String algo, String message, CryptoMap pk, CryptoMap signature){
        CipherSystem cipherSystem = selectSystem(algo);
        if(cipherSystem == null){
            return null;
        }
        return cipherSystem.verify(message, pk, signature);
    }
}
```

`selectSystem`æ–¹æ³•ä¾¿æä¾›äº†ä¸€ç§ç®€å•çš„å•ä¾‹å·¥å‚ï¼Œæ ¹æ®ä¼ å…¥çš„å­—ç¬¦ä¸²è¿”å›ç›¸å¯¹åº”çš„å¯¹è±¡

ä¸ºä»€ä¹ˆç®€å•å·¥å‚ä¸åœ¨ 23 ç§è®¾è®¡æ¨¡å¼ä¸­ï¼Ÿå› ä¸º GoF è®¾è®¡æ¨¡å¼å¼ºè°ƒ**é¢å‘å¯¹è±¡çš„â€œå¼€é—­åŸåˆ™â€**ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰

- ç®€å•å·¥å‚å°†æ‰€æœ‰åˆ›å»ºé€»è¾‘å†™æ­»åœ¨ä¸€ä¸ªé™æ€æ–¹æ³•é‡Œ
- å¦‚æœè¦æ–°å¢ä¸€ç§å¯†ç ï¼ˆæ¯”å¦‚`SBS`ï¼‰ï¼Œå¿…é¡»ä¿®æ”¹`selectSystem` æ–¹æ³•ï¼Œä¸åˆ©äºæ‰©å±•

ç®€å•æ¥è¯´ï¼šå®ƒè¿åäº†å¼€é—­åŸåˆ™ï¼Œä¸å…·å¤‡å¤šæ€çš„æ‰©å±•èƒ½åŠ›

å°½ç®¡å¦‚æ­¤ï¼Œå®ƒè¿˜æ˜¯æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼Œä½¿å¾—åœ¨å®é™…é¡¹ç›®ä¸­å¹¿æ³›åº”ç”¨

| ä¼˜ç‚¹     | è¯´æ˜                                           |
| -------- | ---------------------------------------------- |
| ç®€å•     | ç»“æ„æ¸…æ™°ã€ä»£ç é‡å°‘ï¼Œé€‚åˆåˆæœŸå¼€å‘               |
| æ˜“ç”¨     | ç”¨æˆ·åªéœ€è¦ä¸€ä¸ª`type`å­—ç¬¦ä¸²å°±èƒ½è·å¾—å®ä¾‹         |
| é›†ä¸­ç®¡ç† | æ‰€æœ‰å¯¹è±¡åˆ›å»ºé€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œä¾¿äºæ§åˆ¶å’Œç®¡ç† |

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  ç®€å•å·¥å‚   â”‚ â† ä¸åœ¨23ç§ä¸­
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ å·¥å‚æ–¹æ³•æ¨¡å¼â”‚ â† GoF 23ä¹‹ä¸€
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ æŠ½è±¡å·¥å‚æ¨¡å¼ â”‚ â† æ›´è¿›ä¸€æ­¥
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å‚æ–¹æ³•æ¨¡å¼

å·¥å‚æ–¹æ³•æ¨¡å¼çš„å®šä¹‰ï¼šå®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£**ï¼Œ**è®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»ï¼Œå·¥å‚æ–¹æ³•ä½¿ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å­ç±»

- ç®€å•æ¥è¯´ï¼šçˆ¶ç±»æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ï¼Œä½†ä¸å®ç°ï¼›äº¤ç»™å­ç±»å»å†³å®šåˆ›å»ºå“ªä¸ªå…·ä½“ç±»

æ¯”æ–¹è¯´ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ª Auth æ¥å£ï¼Œä½†å¹¶æ²¡æœ‰å®ç°

```java
public interface Auth {

    KeyPair keygen();

    CryptoMap sign(String message, CryptoMap sk);

    CryptoMap sanitize(String message, CryptoMap sk, CryptoMap signature);

    Boolean verify(String message, CryptoMap pk, CryptoMap signature);
}
```

è€Œåå®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡ç±» CipherSystemï¼Œå»ç»§æ‰¿ Auth æ¥å£ï¼ˆä½†ä»æ²¡æœ‰å®ç°ï¼‰

```java
@Getter
@Setter
@Data
public abstract class CipherSystem implements Auth {

    Pairing BP;
    Field G1, G2, GT, Zr;
    Boolean sanitizable, updatable;

    public CipherSystem(Pairing BP, Field G1, Field G2, Field GT, Field Zr, Boolean sanitizable, Boolean updatable){
        this.BP = BP;
        this.G1 = G1;
        this.G2 = G2;
        this.GT = GT;
        this.Zr = Zr;
        this.sanitizable = sanitizable;
        this.updatable = updatable;
    }
}
```

æœ€ç»ˆçš„å®ç°åœ¨ CipherSystem çš„å­ç±»ä¸­ï¼Œé€šè¿‡æ¯ä¸ªç±»çš„å·¥å‚è¿”å›å®ç°ç±»ï¼Œä¾‹å¦‚

```java
CipherSystem rsa = RSAFactory.creatSystem();
```

è€Œæœ€ç»ˆå¯¹è±¡çš„ä½¿ç”¨ç±»ä¼¼äº

```java
public static void test(CipherSystem cipherSystem){
    KeyPair key = cipherSystem.keygen();
    CryptoMap signature = cipherSystem.sign("null", key.sk);
    System.out.println(cipherSystem.verify("null1", key.pk, signature));

    if(cipherSystem.getSanitizable()){
        signature = cipherSystem.sanitize("null", key.sk, signature);
        System.out.println(cipherSystem.verify("null", key.pk, signature));
    }
}
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯

| ä¼˜ç‚¹     | è¯´æ˜                                 |
| -------- | ------------------------------------ |
| å¼€é—­åŸåˆ™ | æ–°å¢äº§å“æ—¶ä¸æ”¹å·¥å‚æ¥å£ï¼Œåªéœ€æ–°å¢å­ç±» |
| è§£è€¦     | åˆ›å»ºå’Œä½¿ç”¨å¯¹è±¡åˆ†ç¦»ï¼Œæé«˜ä»£ç çµæ´»æ€§   |
| å¤šæ€æ€§   | å®¢æˆ·ç«¯é€šè¿‡å·¥å‚æ¥å£ä½¿ç”¨ä¸åŒçš„äº§å“å­ç±» |

ç¼ºç‚¹ï¼šæ¯æ–°å¢ä¸€ä¸ªäº§å“ç±»ï¼Œéƒ½éœ€è¦å¯¹åº”ä¸€ä¸ªæ–°çš„å·¥å‚ç±»ï¼Œç±»æ•°é‡å¯èƒ½è¾ƒå¤šï¼Œç»“æ„ç¨æ˜¾è‡ƒè‚¿

### æŠ½è±¡å·¥å‚æ¨¡å¼

æŠ½è±¡å·¥å‚æ¨¡å¼ï¼šæä¾›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–çš„å¯¹è±¡ï¼Œè€Œæ— éœ€æŒ‡å®šå®ƒä»¬çš„å…·ä½“ç±»

é€šä¿—åœ°è¯´ï¼Œå°±æ˜¯

- å¦‚æœä¸€ç»„äº§å“éœ€è¦æˆå¥—å‡ºç°ï¼ˆäº§å“æ—ï¼‰ï¼Œå°±ç”¨æŠ½è±¡å·¥å‚
- å®¢æˆ·ç«¯ä»£ç åªé¢å‘â€œå·¥å‚æ¥å£â€ï¼Œæ— éœ€å…³å¿ƒå…·ä½“äº§å“ç±»
- æ¯”å·¥å‚æ–¹æ³•æ›´è¿›ä¸€æ­¥ï¼Œä¸æ˜¯é€ â€œä¸€ä¸ªäº§å“â€ï¼Œ**è€Œæ˜¯é€ â€œç›¸å…³çš„ä¸€ç»„äº§å“â€**

ä¸¾ä¸ª GUI çš„ä¾‹å­ï¼Œä½ æƒ³å†™ä¸€ä¸ª GUI æ¡†æ¶ï¼Œæ”¯æŒ Windows å’Œ Linuxï¼Œä½†ä¸å¸Œæœ›å®¢æˆ·ç«¯ä»£ç å†™æ­»æŸä¸ªå¹³å°ç±»

- ä»€ä¹ˆå«ä¸æƒ³å®¢æˆ·ç«¯ä»£ç å†™æ­»æŸä¸ªå¹³å°ç±»ï¼Ÿ

ä¾‹å¦‚ï¼ˆå†™æ­»äº†å…·ä½“ç±»ï¼‰

```java
// Windowså¹³å°ä¸‹ç›´æ¥ä½¿ç”¨WinButton
Button btn = new WinButton(); 
btn.click();
```

è¿™æ ·å†™æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

- âœ… èƒ½è¿è¡Œ
- âŒ **åªèƒ½è¿è¡Œåœ¨ Windows å¹³å°**ï¼Œæ¢æˆ Linux å°±å¾—æ‰‹åŠ¨æ”¹ä»£ç 

```java
Button btn = new LinuxButton();  // åˆè¦æ”¹ä»£ç 
```

æ‰€ä»¥è¯´ï¼Œè¿™æ ·çš„ä»£ç â€œå†™æ­»â€äº†æŸä¸ªå¹³å°ç±» â€”â€” ä½ æ¯æ¢ä¸€ä¸ªå¹³å°ï¼Œéƒ½è¦æ”¹ä¸šåŠ¡é€»è¾‘ä»£ç 

æ­£ç¡®åšæ³•

```java
// å®¢æˆ·ç«¯ä»£ç é¢å‘æŠ½è±¡å·¥å‚å’ŒæŠ½è±¡äº§å“
GUIFactory factory = new WindowsFactory(); // å¯åŠ¨æ€å†³å®š
Button btn = factory.createButton(); // å¾—åˆ°çš„å¯èƒ½æ˜¯ WinButton æˆ– MacButton
btn.click();
```

è¿™é‡Œï¼Œå®¢æˆ·ç«¯ä»£ç æ ¹æœ¬ä¸çŸ¥é“æœ‰`WinButton`ã€`LinuxButton`è¿™äº›ç±»çš„å­˜åœ¨ï¼ŒåªçŸ¥é“ï¼šâ€œæˆ‘æœ‰ä¸ª`Button`ï¼Œå®ƒèƒ½`click()`â€ï¼Œè‡³äºå®ƒæ˜¯å“ªæ¥çš„ï¼Œ**ç”±å·¥å‚å†³å®š**

- å³ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æ”¹åŠ¨ factory ç±»å‹å°±å¯ä»¥å®ç°å¹³å°çš„åˆ‡æ¢ï¼Œåç«¯ä¸éœ€è¦ä»»ä½•ä¿®æ”¹

## ä»£ç†æ¨¡å¼

ä»£ç†æ¨¡å¼ï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªæ›¿èº«ï¼ˆä»£ç†ï¼‰ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®

- ç®€å•æ¥è¯´ï¼šä½ ä¸ç›´æ¥è·Ÿâ€œçœŸå®å¯¹è±¡â€æ‰“äº¤é“ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªâ€œä»£ç†â€æ¥å®Œæˆå¯¹å®ƒçš„ä½¿ç”¨ã€å¢å¼ºæˆ–æ§åˆ¶

### ä¸€ä¸ªç®€å•çš„ä»£ç†

å®é™…ä¸Šï¼Œå°±æ˜¯å¯¹å®é™…å·¥ä½œçš„ä»£ç çš„ä¸€å±‚å°è£…

```java
// æŠ½è±¡æ¥å£
interface Service {
    void doWork();
}

// çœŸå®å¯¹è±¡
class RealService implements Service {
    public void doWork() {
        System.out.println("æ‰§è¡ŒçœŸå®ä¸šåŠ¡é€»è¾‘...");
    }
}

// ä»£ç†å¯¹è±¡
class ServiceProxy implements Service {
    private RealService realService = new RealService();

    public void doWork() {
        System.out.println("ä»£ç†ï¼šå‡†å¤‡å·¥ä½œ...");
        realService.doWork();
        System.out.println("ä»£ç†ï¼šæ”¶å°¾å·¥ä½œ...");
    }
}

// å®¢æˆ·ç«¯
public class Client {
    public static void main(String[] args) {
        Service service = new ServiceProxy(); // ä½¿ç”¨ä»£ç†ä»£æ›¿çœŸå®å¯¹è±¡
        service.doWork();
    }
}
```

### Spring ä¸­çš„ä»£ç†

Spring ç”¨ä»£ç†å®ç°äº†å¾ˆå¤šæ ¸å¿ƒåŠŸèƒ½

ğŸ’¼ AOPï¼ˆåˆ‡é¢ç¼–ç¨‹ï¼‰

æ ¸å¿ƒæ€æƒ³å°±æ˜¯**åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œæ’å…¥å¢å¼ºé€»è¾‘**ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€å®‰å…¨æ£€æŸ¥ç­‰ï¼‰ï¼š

```java
@Service
public class UserService {
    public void register() {
        System.out.println("æ‰§è¡Œæ³¨å†Œé€»è¾‘");
    }
}
```

å¦‚æœä½ åŠ äº†äº‹åŠ¡æˆ–æ—¥å¿—æ³¨è§£

```java
@Transactional
public void register() { ... }
```

Spring ä¼šè‡ªåŠ¨ç”¨ä¸€ä¸ªä»£ç†ç±»åŒ…ä½è¿™ä¸ª Beanï¼Œåœ¨è°ƒç”¨æ–¹æ³•å‰åæ’å…¥äº‹åŠ¡æ§åˆ¶é€»è¾‘

```java
// å®é™…ä¸Šä½ æ‹¿åˆ°çš„å¹¶ä¸æ˜¯ UserService æœ¬èº«ï¼Œè€Œæ˜¯å®ƒçš„ä»£ç†å¯¹è±¡
UserService proxy = (UserService) applicationContext.getBean("userService");
```

è¿™ä¸ªä»£ç†å¯èƒ½æ˜¯

- JDK åŠ¨æ€ä»£ç†ï¼ˆç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼‰
- CGLIB ä»£ç†ï¼ˆç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼‰

åœ¨ Spring ä¸­ï¼Œå¸¸è§çš„ Beanã€AOPã€äº‹åŠ¡ã€è¿œç¨‹è°ƒç”¨ï¼Œå‡ ä¹éƒ½ç”¨åˆ°äº†ä»£ç†
