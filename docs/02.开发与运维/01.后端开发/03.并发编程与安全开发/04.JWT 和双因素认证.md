---
date: 2024-6-22
permalink: /pages/ce21a8/
author: 
  name: Arkrypto
  link: https://github.com/Arkrypto
title: JWT å’ŒåŒå› ç´ è®¤è¯
---

## JWT ä»¤ç‰Œè®¤è¯

ç»™ WebSocket è¿æ¥æ·»åŠ  JWT è®¤è¯

### WS åè®®

é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼ŒWebSocket æ˜¯åŸºäº HTTP çš„åè®®ï¼ˆè€Œ HTTP åŸºäº TCPï¼Œæœ‰æ—¶æˆ‘ä»¬ä¹Ÿè¯´ WebSocket åŸºäº TCP åè®®ï¼‰ï¼ŒHTTP æœ‰è¯¸å¤šç¼ºç‚¹ï¼Œå¦‚

1. é¦–å…ˆï¼Œä»–ä¸æ”¯æŒå¼‚æ­¥è¯·æ±‚ï¼Œè§£å†³æ–¹æ¡ˆå¦‚ Ajax
2. å…¶æ¬¡ï¼ŒæœåŠ¡ç«¯æ— æ³•è¿›è¡Œä¸»åŠ¨æ¨é€ï¼ˆéåŒå·¥é€šä¿¡ï¼‰ï¼Œå¯ä½¿ç”¨ Comet å¯¹è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œå»¶è¿Ÿæ¨é€ï¼Œè¿™æ ·å®¢æˆ·ç«¯ä¸éœ€è¦å¿™ç­‰ï¼ˆä½†å®é™…ä¸ŠæœåŠ¡ç«¯åšäº†å¿™ç­‰çš„å·¥ä½œï¼‰
3. å½“ç„¶ï¼ŒHTTP è¿˜æœ‰ç€å…¶ä»–çš„ç¼ºç‚¹ï¼Œå¦‚ä»–æœ¬èº«æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„åè®®ï¼Œå³æ¯ä¸ª HTTP è¿æ¥æ— æ³•å¯¹ç”¨æˆ·è¿›è¡Œè¯†åˆ«ï¼Œéœ€è¦æœåŠ¡ç«¯ç»´æŠ¤ç”¨æˆ· Sessionï¼ŒåŒæ—¶ç”¨æˆ·åœ¨æœ¬åœ° Cookie ä¸­å­˜å‚¨ SessionIDï¼Œè¿›è¡ŒçŠ¶æ€çš„ç»´æŠ¤
4. å¹¶ä¸”ï¼ŒHTTP å¹¶æ²¡æœ‰å®‰å…¨æ–¹é¢çš„è€ƒé‡ï¼Œå…¶æ˜æ–‡åœ¨é“¾è·¯ä¸­ç›´æ¥å°è£…åœ¨ TCP æŠ¥æ–‡ä¸­ä¼ è¾“ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ HTTPSï¼Œé€šè¿‡åœ¨ HTTP å¤–å±‚å†å¥—ä¸€å±‚ SSL åè®®ï¼Œå®ç°**æ•°æ®åŠ å¯†ã€èº«ä»½éªŒè¯ã€å®Œæ•´æ€§éªŒè¯**ï¼Œå…¶ä¸­èº«ä»½éªŒè¯é€šè¿‡è¯ä¹¦å®ç°ï¼Œå®Œæ•´æ€§éªŒè¯é€šè¿‡æ•°å­—ç­¾åå®ç°

å½“ç„¶äº†ï¼Œè¿™æ ·çš„ç¼ºç‚¹æ˜¯å®Œå…¨èƒ½æ¥å—çš„ï¼Œäººä»¬éœ€è¦ä¸€ä¸ªè½»é‡çš„ã€æ˜“æ‰©å±•çš„å¹¶ä¸”èƒ½å¤Ÿä¿è¯å¯é ä¼ è¾“çš„åº”ç”¨å±‚åè®®

ä¸ºäº†å®ç°å¼‚æ­¥è¯·æ±‚å’ŒæœåŠ¡ç«¯æ¨é€çš„åŠŸèƒ½ï¼Œæå‡ºäº† WebSocket è¿™æ ·çš„å…¨åŒå·¥å¼‚æ­¥é€šä¿¡çš„åè®®ï¼Œç›¸åº”çš„ï¼Œç”±äº WebSocket åŸºäº HTTPï¼Œä»–å¤©ç„¶çš„ç»§æ‰¿äº†è¿™äº›ä¸ª HTTP çš„éƒ¨åˆ†â€œç¼ºç‚¹â€ï¼ˆ3 å’Œ 4ï¼‰

> This protocol doesnâ€™t prescribe any particular way that servers can authenticate clients during the WebSocket handshake. The WebSocket server can use any client authentication mechanism available to a generic HTTP server, such as cookies, HTTP authentication, or TLS authentication.

WebSocket åè®®çš„ RFCï¼ˆRequest For Commentï¼‰ æåˆ°ï¼Œå¯ä»¥ä½¿ç”¨ä¾‹å¦‚ Cookiesã€HTTP auth æˆ– TLS auth æ¥è¿›è¡Œé‰´æƒï¼Œæœ¬æ–‡å…³æ³¨å…¶å®‰å…¨æ€§æ–¹é¢çš„è€ƒé‡ï¼Œåœ¨åŸºæœ¬çš„ WebSocket è¿æ¥ä¸Šæ·»åŠ ç®€å•çš„èº«ä»½éªŒè¯å’Œå®Œæ•´æ€§éªŒè¯çš„åŠŸèƒ½

### ä¸€èˆ¬çš„ WS æœåŠ¡

1ï¸âƒ£ Java åç«¯

å¼•å…¥ä¾èµ–

```xml
<!--WebSocket-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

åœ¨ä¸»ç±»ä¸Šå¯åŠ¨ WebSocket æœåŠ¡

```java
package com.northboat.bearchat;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.socket.config.annotation.EnableWebSocket;

@SpringBootApplication
@MapperScan("com.northboat.bearchat.mapper")
@EnableWebSocket
public class BearChatApplication {

	public static void main(String[] args) {
		SpringApplication.run(BearChatApplication.class, args);
	}

}
```

WebSocket æœåŠ¡å™¨

- `onlineCount`å˜é‡æ˜¯`static`çš„ï¼Œä¸€å¼€å§‹ä½¿ç”¨äº†`synchronized`æ¥ä¿®æ”¹è®¡æ•°ï¼Œè¿™åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä»ç„¶å­˜åœ¨ç«äº‰é—®é¢˜ï¼Œåä½¿ç”¨`AtomicInteger`ä»£æ›¿
- ä¸€å¼€å§‹é‡‡ç”¨`CopyOnWriteArraySet<WebSocketServer>`å»å­˜æ”¾ WS è¿æ¥ï¼Œåæ”¹æˆ`ConcurrentHashMap<String, WebSocketServer>`ï¼Œä¸€æ˜¯æé«˜äº†æŸ¥è¯¢æ•ˆç‡`O(1)`ï¼ŒäºŒæ˜¯é¿å…äº†`CopyOnWriteArraySet`åœ¨é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½ç“¶é¢ˆ

```java
package com.northboat.bearchat.websocket;

import jakarta.websocket.*;
import jakarta.websocket.server.PathParam;
import jakarta.websocket.server.ServerEndpoint;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.concurrent.CopyOnWriteArraySet;

@Component
@Slf4j
@Service
@ServerEndpoint("/chat/{sid}")
public class WebSocketServer {
    //é™æ€å˜é‡ï¼Œç”¨æ¥è®°å½•å½“å‰åœ¨çº¿è¿æ¥æ•°ã€‚åº”è¯¥æŠŠå®ƒè®¾è®¡æˆçº¿ç¨‹å®‰å…¨çš„ã€‚
    private static final AtomicInteger onlineCount = new AtomicInteger(0);
    //concurrentåŒ…çš„çº¿ç¨‹å®‰å…¨Setï¼Œç”¨æ¥å­˜æ”¾æ¯ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„MyWebSocketå¯¹è±¡ã€‚
    private static final ConcurrentHashMap<String, WebSocketServer> webSocketMap = new ConcurrentHashMap<>();

    //ä¸æŸä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦é€šè¿‡å®ƒæ¥ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®
    private Session session;

    //æ¥æ”¶sid
    private String sid = "";

    /**
     * è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨çš„æ–¹æ³•
     */
    @OnOpen
    public void onOpen(Session session, @PathParam("sid") String sid) {
        this.session = session;
        this.sid = sid;
        webSocketMap.put(sid, this);     //åŠ å…¥setä¸­
        addOnlineCount();           //åœ¨çº¿æ•°åŠ 1
        try {
            sendMessage("Connection Test Message");
            log.info("æœ‰æ–°çª—å£å¼€å§‹ç›‘å¬:" + sid + ", å½“å‰æ€»å…±åœ¨çº¿äººæ•°ä¸º:" + getOnlineCount());
        } catch (IOException e) {
            log.error("websocket IO Exception");
        }
    }

    /**
     * è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³•
     */
    @OnClose
    public void onClose() {
        webSocketMap.remove(this.sid);  //ä»setä¸­åˆ é™¤
        subOnlineCount();           //åœ¨çº¿æ•°å‡1
        //æ–­å¼€è¿æ¥æƒ…å†µä¸‹ï¼Œæ›´æ–°ä¸»æ¿å ç”¨æƒ…å†µä¸ºé‡Šæ”¾
        log.info("é‡Šæ”¾çš„sidä¸ºï¼š" + sid);
        //è¿™é‡Œå†™ä½  é‡Šæ”¾çš„æ—¶å€™ï¼Œè¦å¤„ç†çš„ä¸šåŠ¡
        log.info("æœ‰ä¸€è¿æ¥å…³é—­ï¼å½“å‰åœ¨çº¿äººæ•°ä¸º" + getOnlineCount());
    }

    /**
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•
     * @ Param message å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯
     */
    // å…¨åŒå·¥é€šä¿¡ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯åè¿›è¡Œå¤„ç†ï¼Œå¯ä»¥æ˜¯åˆ†å‘ï¼Œå¯ä»¥æ˜¯å…¶ä»–
    // è¿™é‡Œæ˜¯å°†ä¿¡æ¯å‘é€ç»™ sid ç›¸åŒçš„æ‰€æœ‰è¿æ¥
    @OnMessage
    public void onMessage(String message, Session session) {
        log.info("æ”¶åˆ°æ¥è‡ªçª—å£ " + sid + " çš„ä¿¡æ¯:" + message);
        //ç¾¤å‘æ¶ˆæ¯
        try {
        	webSocketMap.get(sid).sendMessage(message);
        } catch (IOException e) {
            e.printStackTrace();
		}
    }

    /**
     * @ Param session
     * @ Param error
     */
    @OnError
    public void onError(Session session, Throwable error) {
        log.error("å‘ç”Ÿé”™è¯¯");
        error.printStackTrace();
        try {
        	session.close();
    	} catch (IOException e) {
        	log.error("å…³é—­ WebSocket å¤±è´¥", e);
    	}
    }

    /**
     * å®ç°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€
     */
    public void sendMessage(String message) throws IOException {
        this.session.getBasicRemote().sendText(message);
    }

    /**
     * ç¾¤å‘è‡ªå®šä¹‰æ¶ˆæ¯
     */
    public static void sendInfo(String message, @PathParam("sid") String sid) throws IOException {
        log.info("æ¨é€æ¶ˆæ¯åˆ°çª—å£" + sid + "ï¼Œæ¨é€å†…å®¹:" + message);
		//è¿™é‡Œå¯ä»¥è®¾å®šåªæ¨é€ç»™è¿™ä¸ªsidçš„ï¼Œä¸ºnullåˆ™å…¨éƒ¨æ¨é€
        webSocketMap.values().forEach(item -> {
        	if (sid == null || item.sid.equals(sid)) {
            	try {
                	item.sendMessage(message);
            	} catch (IOException e) {
                	log.error("æ¶ˆæ¯æ¨é€å¤±è´¥: {}", e.getMessage());
            	}
        	}
    	});
    }

    public static synchronized int getOnlineCount() {
        return onlineCount;
    }

    public static synchronized void addOnlineCount() {
        onlineCount.incrementAndGet();
    }

    public static synchronized void subOnlineCount() {
        onlineCount.decrementAndGet();
    }

    public static CopyOnWriteArraySet<WebSocketServer> getWebSocketSet() {
        return webSocketMap.valueSet();
    }
}
```

2ï¸âƒ£ JS å‰ç«¯ï¼šç®€å•çš„å‰ç«¯é¡µé¢å’Œæœ´å®æ— åçš„ JS

```html
<h2 class="major">å…±æœ‰<strong th:text="${count}"></strong>äººåœ¨å…¬å…±èŠå¤©å®¤</h2>

<p id="user" th:text="${name}" style="display: none"></p>
<p id="login" th:text="${login}" style="display: none"></p>
<p id="room" th:text="${room}" style="display: none"></p>
<script>
    let user = document.getElementById("user").innerText;
    let login = document.getElementById("login").innerText;
    console.log(name);

    // è¿æ¥ websocket æœåŠ¡å™¨
    let websocket = null;
    let room  = document.getElementById("room").innerText;
    //åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒWebSocket
    if(room === "null"){
        throw SyntaxError();
    } else if('WebSocket' in window) {
        //æ”¹æˆä½ çš„åœ°å€http
        websocket = new WebSocket("ws://fx35xt.natappfree.cc/chat/"+room);
    } else {
        alert('å½“å‰æµè§ˆå™¨ Not support websocket')
    }


    //è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
    websocket.onerror = function() {
        setMessageInnerHTML("WebSocket è¿æ¥å‘ç”Ÿé”™è¯¯");
    };

    //è¿æ¥æˆåŠŸå»ºç«‹çš„å›è°ƒæ–¹æ³•
    websocket.onopen = function() {
        setMessageInnerHTML("WebSocket è¿æ¥æˆåŠŸ");
    }
    
    //let U01data, Uidata, Usdata;
    //æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•
    websocket.onmessage = function(event) {
        console.log(event);
        setMessageInnerHTML(event.data);
        //setechart()
    }

    //è¿æ¥å…³é—­çš„å›è°ƒæ–¹æ³•
    websocket.onclose = function() {
        setMessageInnerHTML("WebSocket è¿æ¥å…³é—­");
    }

    //ç›‘å¬çª—å£å…³é—­äº‹ä»¶ï¼Œå½“çª—å£å…³é—­æ—¶ï¼Œä¸»åŠ¨å»å…³é—­websocketè¿æ¥ï¼Œé˜²æ­¢è¿æ¥è¿˜æ²¡æ–­å¼€å°±å…³é—­çª—å£ï¼Œserverç«¯ä¼šæŠ›å¼‚å¸¸ã€‚
    window.onbeforeunload = function() {
        closeWebSocket();
    }

    //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
    function setMessageInnerHTML(innerHTML) {
        while(innerHTML.length > 32){
            document.getElementById('message').innerHTML += innerHTML.substring(0, 32) + '<br/>';
            innerHTML = innerHTML.substring(32);
        }
        document.getElementById('message').innerHTML += innerHTML + '<br/><br/>';
    }

    //å…³é—­WebSocketè¿æ¥
    function closeWebSocket() {
        websocket.close();
    }

    //å‘é€æ¶ˆæ¯
    function send() {
        let message = document.getElementById('text').value;
    	if (message.length > 200) {
        	alert("æ¶ˆæ¯è¿‡é•¿ï¼Œè¯·é™åˆ¶åœ¨ 200 å­—ç¬¦ä»¥å†…ï¼");
        	return;
   	 	}
        websocket.send(message);
        document.getElementById("text").value = "";
    }
</script>
```

### JWT è®¤è¯

JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§åŸºäº **JSON** çš„**èº«ä»½è®¤è¯å’Œä¿¡æ¯ä¼ é€’**æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®‰å…¨åœ°ä¼ é€’è®¤è¯ä¿¡æ¯

JWT æ˜¯**æ— çŠ¶æ€çš„**ï¼Œå³æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼Œè€Œæ˜¯å°†æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯å°è£…åœ¨ Tokenï¼ˆä»¤ç‰Œï¼‰é‡Œï¼Œè®©å®¢æˆ·ç«¯åœ¨æ¯æ¬¡è¯·æ±‚æ—¶æºå¸¦ï¼Œä»è€Œå®ç°èº«ä»½è®¤è¯ï¼Œå…¶ç‰¹ç‚¹å¦‚ä¸‹

- æ— çŠ¶æ€è®¤è¯ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ Tokenï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å¯ä»¥ç‹¬ç«‹éªŒè¯ç”¨æˆ·èº«ä»½
- è·¨å¹³å°ï¼šJWT é‡‡ç”¨ JSON æ ¼å¼ï¼Œé€‚ç”¨äºå„ç§ Webã€ç§»åŠ¨ç«¯å’Œå¾®æœåŠ¡æ¶æ„
- å®‰å…¨æ€§é«˜ï¼šJWT å¯ä»¥åŠ å¯†ã€ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹å’Œä¼ªé€ 
- é«˜æ•ˆæ€§ï¼šç›¸æ¯”ä¼ ç»Ÿçš„ Session è®¤è¯ï¼ŒJWT ç›´æ¥åœ¨è¯·æ±‚ä¸­æºå¸¦èº«ä»½ä¿¡æ¯ï¼Œå‡å°‘äº†æ•°æ®åº“æŸ¥è¯¢ï¼Œæé«˜äº†æ€§èƒ½

åœ¨ Spring ä¸­ä½¿ç”¨

1ï¸âƒ£ å¼•å…¥ jjwt ä¾èµ–

```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.11.5</version>
</dependency>
```

2ï¸âƒ£ JWT å·¥å…·ç±»

```java
public class JwtUtil {
    private static final String SECRET_KEY = "your_secret_key";  // ä½ çš„å¯†é’¥
    private static final long EXPIRATION_TIME = 3600000; // 1å°æ—¶

    // ç”Ÿæˆ JWT
    public static String generateToken(String sid) {
        return Jwts.builder()
                .setSubject(sid)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
                .compact();
    }

    // éªŒè¯ JWT
    public static boolean verifyToken(String token, String sid) {
        try {
            Claims claims = Jwts.parser()
                    .setSigningKey(SECRET_KEY)
                    .parseClaimsJws(token)
                    .getBody();
            return claims.getSubject().equals(sid) && claims.getExpiration().after(new Date());
        } catch (Exception e) {
            return false;
        }
    }
}
```

3ï¸âƒ£ åœ¨`/login or /register`æ¥å£æˆåŠŸé€šè¿‡æ—¶ï¼Œè°ƒç”¨`generateToken`å‡½æ•°è¿”å›ä¸€ä¸ª token ç»™å‰ç«¯ç”¨æˆ·ï¼Œç”¨äºåç»­çš„è®¤è¯

5ï¸âƒ£ WS æœåŠ¡ç«¯æ·»åŠ  JWT Authï¼šä¿®æ”¹è¯·æ±‚è·¯å¾„ï¼Œè¦æ±‚ä¼ å…¥ token å¹¶åœ¨ onOpen å‡½æ•°ä¸­è¿›è¡Œè®¤è¯

```java
@Component
@Slf4j
@Service
@ServerEndpoint("/chat/{sid}/{token}")  // URL é‡Œæ·»åŠ  token å‚æ•°
public class WebSocketServer {
    // å­˜æ”¾æ‰€æœ‰è¿æ¥çš„ WebSocket å®ä¾‹ï¼ˆkey = sidï¼‰
    private static final Map<String, WebSocketServer> webSocketMap = new ConcurrentHashMap<>();
    
    private Session session;
    private String sid = "";
    
    /**
     * æ ¡éªŒ token
     */
    private boolean isValidToken(String token, String sid) {
        // è‹¥ä¸ºç©ºç›´æ¥è¿”å› 0
        if (!StringUtils.hasText(token)) {
            return false;
        }
        // è¿™é‡Œè°ƒç”¨ä½ çš„ JWT è§£ææ–¹æ³•ï¼Œæ ¡éªŒ token æ˜¯å¦æ­£ç¡®
        return JwtUtil.verifyToken(token, sid);
    }

    /**
     * WebSocket è¿æ¥å»ºç«‹æ—¶è§¦å‘
     */
    @OnOpen
    public void onOpen(Session session, @PathParam("sid") String sid, @PathParam("token") String token) {
        log.info("å°è¯•å»ºç«‹ WebSocket è¿æ¥ï¼šsid={}ï¼Œtoken={}", sid, token);

        // è®¤è¯ token
        if (!isValidToken(token, sid)) {
            log.warn("è®¤è¯å¤±è´¥ï¼Œæ‹’ç»è¿æ¥ï¼šsid={}", sid);
            try {
                session.close(new CloseReason(CloseReason.CloseCodes.VIOLATED_POLICY, "è®¤è¯å¤±è´¥"));
            } catch (IOException e) {
                log.error("å…³é—­è¿æ¥å¤±è´¥", e);
            }
            return;
        }

        this.session = session;
        this.sid = sid;

        // ç»´æŠ¤è¿æ¥
        webSocketMap.put(sid, this);

        try {
            sendMessage("è¿æ¥æˆåŠŸï¼Œè®¤è¯é€šè¿‡ï¼");
            log.info("WebSocket è¿æ¥å»ºç«‹æˆåŠŸï¼šsid={}ï¼Œå½“å‰åœ¨çº¿äººæ•°={}", sid, webSocketMap.size());
        } catch (IOException e) {
            log.error("WebSocket å‘é€æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
```

6ï¸âƒ£ WS å®¢æˆ·ç«¯æ‰“è¯·æ±‚æ—¶ä¼ å…¥ JWT å³å¯

```js
let token = localStorage.getItem("token");  // è¿™ä¸ª token ç™»å½•æ—¶è·å–å¹¶å­˜å…¥ localStorage
let room = document.getElementById("room").innerText;
let websocket = new WebSocket(`ws://localhost:8080/chat/${room}/${token}`);
```

## UKEY 2FA

é‡‡ç”¨å¥¥è”çš„ USBKEY ä»¥åŠå…¶ç›¸å¯¹åº”çš„å¯†ç æœºå®ç° U ç›¾çš„ 2FA è®¤è¯ï¼ŒçœŸçš„ä¸å¾—ä¸è¯´ï¼Œå¥¥è”ç»™çš„æ¥å£ç®€ç›´æ˜¯ä¸€å¨å¤§èŠ¬ğŸ¤®ï¼Œæ–‡æ¡£æ›´æ˜¯ç‰›å¤´ä¸å¯¹é©¬å˜´

ä¸€äº›å‰ç½®å·¥ä½œ

- ç”¨æˆ· UKEY ä¸­æ‰€ä½¿ç”¨çš„ç­¾åè¯ä¹¦éœ€è¦åœ¨åç«¯ç­¾åéªŒç­¾æœåŠ¡å™¨ä¸­æ³¨å†Œ
- ä¸‹è½½å®‰è£… UKEY çš„æ’ä»¶ç¯å¢ƒ
- éœ€è¦ä¸€ä¸ªå€’éœ‰è›‹å°† U ç›˜ä»è¥¿å®‰é‚®åˆ°ç§¦çš‡å²›

### ä»€ä¹ˆæ˜¯ 2FAï¼Ÿ

2FAï¼ŒTwo-Factor Authenticationï¼Œå³åŒå› ç´ è®¤è¯

- ä¼ ç»Ÿçš„è´¦å·å¯†ç ä¸ºå•é‡è®¤è¯ï¼Œå¦‚ QQ çš„ç™»å½•ï¼›Stream çš„ç™»å½•åˆ™ä¸ºåŒå› ç´ ï¼Œä¸€é‡ä¸ºè´¦å·å¯†ç ï¼ŒäºŒä¸ºæ‰‹æœºæ¥æ”¶çš„è®¤è¯ç çŸ­ä¿¡

å¯†ç  + æŸç§ä¸ªäººç‰©å“æ˜¯å¸¸è§çš„åŒå› ç´ ç»„åˆï¼Œå¦‚é“¶è¡Œä½¿ç”¨çš„ U ç›¾ï¼ˆä¸€ä¸ª U ç›˜ï¼‰ï¼Œåœ¨æ­¤å¤„ U ç›¾ å……å½“â€œæŸç§ä¸ªäººç‰©å“â€çš„ä½œç”¨ï¼Œæ¯ä½ç”¨æˆ·å°†é…å¤‡å„è‡ªçš„ U ç›¾ï¼Œå†…ç½®æœ‰ç”¨æˆ·çš„ç­¾åè¯ä¹¦ä¸åŠ å¯†è¯ä¹¦ï¼ŒåŒæ—¶ U ç›¾çš„è®¿é—®å— PIN ç ä¿æŠ¤

ä¸€ç§å…¸å‹å®ç°æ–¹æ¡ˆä¸º

- ç”¨æˆ·åœ¨å®Œæˆå£ä»¤ã€éªŒè¯ç çš„è¾“å…¥åï¼Œå‰ç«¯è°ƒç”¨ USBKEY çš„æ¥å£å¯¹ç™»å½•è¯·æ±‚æ•°æ®è¿›è¡Œç­¾åï¼Œå¹¶ä¸”å°†è¯¥ç­¾åä½œä¸ºä¸€ä¸ªå­—æ®µåŠ å…¥ HTTP è¯·æ±‚ä¸­
- åç«¯ç³»ç»Ÿä¼šéƒ¨ç½²ä¸€ä¸ªç­¾åéªŒç­¾æœåŠ¡å™¨ï¼Œæ¥æ”¶åˆ°å‰ç«¯ç™»å½•è¯·æ±‚åï¼Œåˆ©ç”¨ç­¾åéªŒç­¾æœåŠ¡å™¨å®ŒæˆéªŒç­¾ï¼ŒéªŒç­¾æ­£ç¡®åˆ™èº«ä»½é‰´åˆ«é€šè¿‡ï¼Œè€Œåå†è¿›è¡Œå¯†ç çš„è®¤è¯ï¼Œå®ç°åŒå› ç´ è®¤è¯

### å‰ç«¯ Vue JS ç­¾å

1ï¸âƒ£ UKEY ç¯å¢ƒæ£€æµ‹

é‡‡ç”¨ WebSocket å½¢å¼çš„æ¥å£ï¼ˆæ„å¼å¥¥è”æä¾›çš„ï¼‰å¯¹å‰ç«¯è¡¨å•æ•°æ®è¿›è¡Œ SGD_SM3_SM2 è¿›è¡Œç­¾åï¼Œè¯¥ UKEY æ¥å£å†…éƒ¨å†™æ­» SignerID ä¸º`"1234567812345678"`ï¼ˆé»˜è®¤ IDï¼‰ï¼Œè¿™åœ¨åç»­éªŒç­¾æ—¶éœ€ä¿æŒä¸€è‡´

æ£€æµ‹æ’ä»¶ç¯å¢ƒä»¥åŠæ˜¯å¦æ’å…¥ U ç›¾

```js
envCheck(){
    if(!ntlsUtil.wsObj){
        ntlsUtil.websocketInit(this.check_plugin_exist, null, this.check_plugin_exist);
    } else {
        this.check_plugin_exist();
    }
}
```

ntlsUtil æ˜¯ä»å¥¥è”æ¥å£ä¸­å¯¼å…¥çš„å…¨å±€å·¥å…·ç±»

```js
import { ntlsUtil } from '@/utils/ntls-plugin'
```

å¦‚æœ ntlsUtil.wsObj ä¸ä¸ºç©ºï¼Œå³ websocket è¿æ¥æ‰“å¼€ï¼Œåˆ™è®¤ä¸ºå·²ç»æ£€æŸ¥è¿‡ä¸è¿›è¡Œåç»­æ“ä½œï¼ˆå› ä¸ºæ£€æŸ¥è¿‡ç¨‹ä¼šä¸»åŠ¨æ‰“å¼€ websocketï¼Œè‹¥åœ¨å·²è¿æ¥çš„æƒ…å†µä¸‹å†æ‰“å¼€ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥è¿™é‡Œè¿™ä¹ˆå¤„ç†ï¼Œä½†åœ¨åç»­å¼•å‘äº†å…¶ä»–é—®é¢˜ï¼‰

æ’ä»¶æ£€æŸ¥

```js
//æ£€æŸ¥æ’ä»¶
check_plugin_exist(){
    if(ntlsUtil.pluginExist==false){
        //è¿æ¥ä¸æˆåŠŸ,æ’ä»¶æœªå®‰è£…æˆ–è€…æœåŠ¡æœªå¯åŠ¨
        alert("è¿æ¥ä¸æˆåŠŸ,æ’ä»¶æœªå®‰è£…æˆ–è€…æœåŠ¡æœªå¯åŠ¨")
        return false;
    }
    //step4 æ£€æµ‹æ˜¯å¦æ’å…¥ukey, æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å›è°ƒå‡½æ•°åç§°éƒ½ä¸ºå½“å‰å‘é€æ¶ˆæ¯çš„actionåç§° 
    ntlsUtil.func.enumerate_ukey_user(this.enumerate_ukey_user);
}
```

`ntlsUtil.func.enumerate_ukey_user()`æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œä¼ å‚ä¸ºå›è°ƒå‡½æ•°ï¼Œå¯¹å¼‚æ­¥è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œ`this.enumerate_ukey_user`å¦‚ä¸‹

```js
enumerate_ukey_user(message){
    if(message == null){
        alert("WebSocketæ£€æµ‹è¯·æ±‚å¤±è´¥")
        return false;
    }
    var ukey_exist = false;
    for(var i = 0; i < message.data.usbkey.length; i++){
        var key_data = message.data.usbkey[i];
        if(typeof key_data.keytype != 'undefined'){
            if(this.check_key_type == true &&  key_data.keytype != this.key_type ){ }
            else{
                //keytype=file åœ¨ç§é’¥æ ‡è¯†ä¸­æŸ¥æ‰¾ï¼Œä»æ¯ä¸ªidentity.0.type æŸ¥æ‰¾sm2/sm9/...
                var this_ukey_exist = false;
                var length = key_data.identity.length;
                for (var m = 0; m < length; m++){
                    //åªåŒ¹é…éœ€è¦çš„alg
                    if(key_data.identity[m].type.toUpperCase().indexOf(this.alg_type) != -1){
                        this_ukey_exist = true;//å±€éƒ¨
                    }
                }
                if(this_ukey_exist){
                    ukey_exist = true;//å…¨å±€
                }
            }
        } else {
            //key_type=usbkey  åœ¨äº§å•†ä¸­æŸ¥æ‰¾
            if(key_data.manufacturer.toUpperCase().indexOf(alg_type)!==-1 || key_data.alg.toUpperCase().indexOf(this.alg_type)!==-1 ){
                ukey_exist = true;
            }
        }
    }
    if(ukey_exist == false){
        alert('æœªæ£€æµ‹åˆ°'+this.alg_type+'ç§é’¥æ ‡è¯†'); //æŒ‰æ‰­åŠŸèƒ½ ï¼Œæ£€æµ‹sm2/sm9ç­‰ UKEYæ˜¯å¦æ’ä»¶
        return false;
    }else{
        console.log('æ£€æµ‹åˆ°'+this.alg_type+'ç§é’¥æ ‡è¯†',true,true);
        console.log(JSON.stringify(message));
        this.keyindex = message.data.usbkey[0].keyindex;
        this.container = message.data.usbkey[0].identity[0].container;
        console.log("keyindex: " + this.keyindex + "\ncontainer: " + this.container);
        this.ret = true;
    }
}
```

è¯·æ±‚å®Œæ¯•åï¼Œå°† UKEY ä¸­çš„`keyindex`å’Œ`container`å­˜åœ¨å‰ç«¯ç»´æŠ¤çš„ä¸¤ä¸ªå˜é‡ä¸­ï¼Œåœ¨åç»­ç™»é™†æ—¶ä½¿ç”¨

2ï¸âƒ£ ç”¨æˆ·æ³¨å†Œ

ç³»ç»Ÿè¦æ±‚ç”¨æˆ·æ³¨å†Œæ—¶å½•å…¥ç”¨æˆ·æ‰€ä½¿ç”¨ UKEY ä¸­çš„è¯ä¹¦ä¿¡æ¯ï¼ŒåŒæ ·é‡‡ç”¨å¼‚æ­¥å‡½æ•°è·å–

```js
handleRegister() {
    this.$refs.registerForm.validate(valid => {
        if (valid) {
            this.loading = true
            let ukey_val = this.keyindex;
            let identity_val = this.container;
            ntlsUtil.func.get_cert_content(ukey_val, identity_val, 1, this.doRegister);
        }
    })
},
// message ä¸­ä¸ºè¯ä¹¦ä¿¡æ¯
doRegister(message){
    if(!message || !message.data){
        alert("è·å–è¯ä¹¦å†…å®¹å¤±è´¥");
        return false;
    }
    console.log(message.data)
    // æˆªå–cert
    let cert = message.data.replace(/[\r\n]/g,"");
    cert = cert.substr(27, cert.length)
    cert = cert.substr(0, cert.indexOf("-"))
    console.log(cert)

    this.registerForm.certificate = cert;
    register(this.registerForm).then(() => {
        this.$message({
            message: 'æ³¨å†ŒæˆåŠŸï¼Œå³å°†è¿”å›ç™»å½•é¡µé¢ï¼',
            type: 'success',
            duration: 2000
        })
        this.loginForm.username = this.registerForm.username
        this.loginForm.password = this.registerForm.password
        setTimeout(() => {
            this.switchLogin = true
        }, 1500)
        this.$refs['registerForm'].resetFields()
    }).finally(() => {
        this.loading = false
    })
},
```

3ï¸âƒ£ ç­¾ååŠç™»å½•

è¡¨å•æ•°æ®åœ¨ç­¾åå‰éœ€è¦è¿›è¡Œ Base64 ç¼–ç å¤„ç†

```js
encodeBase64(str){
    return Buffer.from(str, 'utf8').toString('base64');
}
```

ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼Œå¹¶ä¸”åœ¨é¡µé¢æ­£å¸¸è·å¾— UKEY ä¿¡æ¯åï¼Œæ‰§è¡Œç™»é™†æ“ä½œï¼Œpass ä¸º UKEY çš„ PIN ç ï¼Œéœ€è¦ç”¨æˆ·åœ¨å‰ç«¯æ‰‹åŠ¨è¾“å…¥

```js
// ç™»å½•
handleLogin() {
    this.$refs.loginForm.validate(valid => {
        valid = valid && this.ret // this.ret åœ¨ç¯å¢ƒæ£€æµ‹é€šè¿‡åç½®ä¸º trueï¼Œvalid ä¸ºè¡¨å•æ•°æ®åˆæ³•æ€§
        if (valid) {
            this.loading = true
            this.loginForm.iniData = JSON.stringify(this.loginForm);
            console.log(this.loginForm.iniData);
            let inData = this.encodeBase64(this.loginForm.iniData);
            let ukey_val = this.keyindex;
            let identity_val = this.container;
            let pass = this.loginForm.key;
            let hashtype = "";
            let format = "asn.1";
            // æ³¨æ„è¿™é‡Œè¦æ ‡æ˜ format ä¸º asn.1
            ntlsUtil.func.data_sm2_signature(ukey_val, identity_val, pass, inData, hashtype, format, this.doLogin);
        } else {
            console.log('error submit!!');
            alert("error submit!")
            return false
        }
    })
}
```

æ ¸å¿ƒåœ¨äºè¿™æ¡åŠ å¯†å‡½æ•°

```js
ntlsUtil.func.data_sm2_signature(ukey_val, identity_val, pass, inData, hashtype, format, this.doLogin);
```

`ukey_val`å’Œ`identity_val`ä¸ºç¯å¢ƒæ£€æµ‹æ—¶è·å–çš„ UKEY ä¿¡æ¯`keyindex`å’Œ`container`ï¼Œ`pass`ä¸º UKEY çš„ PIN ç ï¼Œ`inData`ä¸ºç™»é™†çš„è¡¨å•åŸæ–‡ï¼ˆJson æ•°æ®ï¼‰ï¼Œå¦‚

```json
"{\"account\":\"wx\", \"password\":\"123456\", \"verify_code\":\"dQ3k\", \"PIN\":\"123456\"}"
```

`this.doLogin`ä¸ºå›è°ƒå‡½æ•°ï¼Œä¼ å…¥çš„`message`ä¸ºç­¾åæ•°æ®

```js
// æ‰“è¯·æ±‚
doLogin(message){
    if(!message || !message.data){
        alert("ç­¾åå¤±è´¥, è¯·æ£€æŸ¥UKeyæ˜¯å¦æ’å…¥æˆ–PINç æ˜¯å¦æ­£ç¡®, æˆ–PINç æ˜¯å¦è¢«é”å®š");
        this.loading = false;
        return false;
    }
    console.log("ç­¾åæ‰€ç”¨è¯ä¹¦ä¸º: " + this.cert  + "\nå‰ç«¯ç­¾ååŸæ–‡ä¸º" + this.encodeBase64(this.loginForm.iniData) + "\nå‰ç«¯ç­¾åæ‰€å¾—å¯†æ–‡ä¸º: " + message.data)
    this.loginForm.signature = message.data;

    this.$store.dispatch('user/login', this.loginForm).then(() => {
        localStorage.setItem("pin", this.loginForm.key);
        localStorage.setItem("keyindex", this.keyindex);
        localStorage.setItem("container", this.container);
        this.$router.push({ path: this.redirect || '/' })

        this.loading = false
    }).catch(() => {
        this.loading = false
    })
}
```

æ³¨æ„ä¼ å…¥çš„åŸæ–‡æ•°æ®éœ€è¦æ˜¯ Base64 ç¼–ç ï¼Œå¹¶ä¸”åœ¨ç­¾åæ—¶ï¼Œå¿…é¡»è¦è§„å®šä¼ å‚`format`ä¸º`asn.1`ï¼Œæ‰èƒ½ç­¾åå¾—åˆ° Base64 ç¼–ç çš„å¯†æ–‡ï¼Ÿå¥¥è”çœŸçš„æ˜¯ä¸€å¨æ„æ€

å¦å¤–è¿™é‡Œéå¸¸ä¸ä¼˜é›…çš„æŠŠä¸€ç³»åˆ—ä¿¡æ¯å­˜åˆ°äº† localStorageï¼Œå› ä¸ºåœ¨åç»­çš„è½¬è´¦æ“ä½œä¸­è¦ç”¨åˆ°ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Ÿï¼Ÿå”‰ï¼Œæ˜¯è¿™æ ·

1. ä¹‹å‰åœ¨æ£€æµ‹ç¯å¢ƒæ—¶è¯´è¿‡ï¼Œæ˜¯å¦æ£€æµ‹çš„æ¡ä»¶æ˜¯ websocket æ˜¯å¦è¿æ¥ï¼Œè¿™å°±é€ æˆç™»å½•æ—¶ç”¨çš„è¿™ä¸ªè¿æ¥ä¸€ç›´ä¿æŒï¼Œäºæ˜¯åœ¨åç»­å¹¶ä¸ä¼šè¿›è¡Œç¯å¢ƒæ£€æµ‹
2. æ‰€ä»¥å‘¢ï¼Œåœ¨è½¬è´¦é¡µé¢ï¼Œæ²¡æœ‰è¿›è¡Œç¯å¢ƒæ£€æµ‹ï¼Œè‡ªç„¶å°±ä¸ä¼šå»éå†é’¥åŒ™ï¼Œå°±ä¸ä¼šè·å¾—`keyindex`å’Œ`container`ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å·æ‡’ç›´æ¥å­˜äº†ï¼Œåˆ°æ—¶å€™ç›´æ¥å–äº†ç”¨

æ­£ç¡®çš„æµç¨‹åº”è¯¥æ˜¯ï¼šåœ¨ç™»é™†æˆåŠŸåï¼Œä¸»åŠ¨æ–­å¼€ websocket è¿æ¥ï¼Œåœ¨è½¬è´¦é¡µé¢é‡å¤ä¸Šè¿°æµç¨‹è·å–é’¥åŒ™ä¿¡æ¯å†è¿›è¡Œç­¾åæ“ä½œï¼Œä½†æ˜¯ä»–å°±ç»™äº†æˆ‘ 1kï¼Œæˆ‘æ‡’å¾—å†™äº†ï¼Œåæ­£ç”²æ–¹æ²¡æ‰¾æˆ‘éº»çƒ¦

### åç«¯ Spring éªŒç­¾

å‰ç«¯å°†åŸå§‹è¡¨å•æ•°æ®ï¼ˆåŸæ–‡ï¼‰å’Œç­¾åæ•°æ®ï¼ˆå¯†æ–‡ï¼‰ä¸€åŒæ‰“åœ¨åç«¯æ¥å£ä¸Šï¼Œåç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œé¦–å…ˆæ ¹æ®ç”¨æˆ·åä»æ•°æ®åº“ä¸­å–å‡ºç”¨æˆ·è¯ä¹¦ï¼Œå†å¯¹å‰ç«¯ä¼ æ¥çš„åŸæ–‡å’Œå¯†æ–‡é€šè¿‡è¯ä¹¦å’Œç­¾åéªŒç­¾æœåŠ¡å™¨è¿›è¡ŒéªŒè¯ï¼Œè¿”å›`true/false`ï¼Œå®ç°ä¸€é‡è®¤è¯

Controller å±‚

```java
@PostMapping("/login")
public Result doLogin(@RequestBody LoginInfoDTO user,HttpServletRequest req) throws CryptoException, UnsupportedEncodingException {
    System.out.println("signature: "+ user.getSignature());
    HttpSession session = req.getSession();
    String gencode = (String) session.getAttribute("index_code");
    if(StringUtils.isEmpty(user.getCode())){
        return Result.ERROR("éªŒè¯ç ä¸èƒ½ä¸ºç©º");
    }
    System.out.println("éªŒè¯ç ï¼š " + gencode);
    if (!gencode.toLowerCase().equals(user.getCode().toLowerCase())){
        return Result.ERROR("éªŒè¯ç é”™è¯¯");
    }

    //éªŒè¯ç”¨æˆ·ç™»å½•ç­¾åä¿¡æ¯
    if(StringUtils.isEmpty(user.getSignature())){
        return Result.ERROR("ç­¾åä¿¡æ¯ä¸èƒ½ä¸ºç©º");
    }

    String jwtToken = userService.doLogin(user);
    if (jwtToken == null) {
        return Result.ERROR("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯!!!!!!");
    }
    System.out.println("ç”¨æˆ·ç™»å½•");
    return Result.OK(jwtToken);
}
```

ä¸»è¦çš„éªŒè¯ä¸šåŠ¡å†`String jwtToken = userService.doLogin(user)`è¿™ä¸€è¡Œ

Service å±‚

```java
@Override
public String doLogin(LoginInfoDTO user) {
    User uu = userMapper.findByName(user.getUsername());
    String cert = uu.getCertificate();
    String iniData = user.getIniData();
    String signData = user.getSignature();
    System.out.println("iniData: " + iniData);
    System.out.println("signature: " + signData);
    boolean flag = OlymSignature.verifySignature(cert, iniData, signData);
    if(flag)
        return doLogin(user.getUsername(), user.getPassword());
    else
        return null;
}
```

ç¬¬ä¸€é‡è®¤è¯åœ¨`boolean flag = OlymSignature.verifySignature(cert, iniData, signData);`

```java
public static boolean verifySignature(String cert, String inData, String signed){
    boolean flag = false;
    try{
        flag = verify(cert, inData, signed);
    }catch (Exception e){
        System.out.println("---------->éªŒç­¾å‡ºé”™");
        e.printStackTrace();
    }
    return flag;
}
```

verify å‡½æ•°å°è£…ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œæ‰“å‘åç«¯å†…ç½‘ä¸­çš„å¯†ç æœºï¼Œè·å–éªŒç­¾ç»“æœï¼Œè¿™é‡Œçš„ cert æ˜¯æ³¨å†Œæ—¶ç”¨æˆ·å­˜å…¥æ•°æ®åº“çš„é‚£ä»½è¯ä¹¦ï¼ŒinData å’Œ signature åˆ†åˆ«æ˜¯ä»å‰ç«¯æ‰“æ¥çš„è¡¨å•åŸæ–‡ä¿¡æ¯å’Œå‰ç«¯çš„ç­¾åä¿¡æ¯

- æ‰€ä»¥è¿™é‡Œçš„éªŒç­¾å®é™…ä¸Šå°±æ˜¯ï¼Œæ ¹æ®ç”¨æˆ·åœ¨åç«¯å­˜çš„è¯ä¹¦ certï¼Œå¯¹ç”¨æˆ·çš„åŸæ–‡åŠ å¯†ï¼Œå¹¶å’Œç”¨æˆ·åœ¨å‰ç«¯çš„å¯†æ–‡è¿›è¡Œæ¯”å¯¹ï¼Œè‹¥ä¸€è‡´åˆ™è®¤è¯é€šè¿‡

```java
public static boolean verify(String cert, String inData, String signature) throws Exception {
    if(cert == null){
        cert = Cert;
    }
    byte[] signerIDBytes = SignerID.getBytes();
    Integer signerIDLen = signerIDBytes.length;
    String signerID = Base64.getEncoder().encodeToString(signerIDBytes);

    byte[] inDataBytes = inData.getBytes();
    Integer inDataLen = inDataBytes.length;
    System.out.println(inDataLen);
    inData = Base64.getEncoder().encodeToString(inDataBytes);

    System.out.println("éªŒç­¾æ‰€ä½¿ç”¨çš„è¯ä¹¦ä¸º: " + cert);
    System.out.println("éªŒç­¾æ‰€ä½¿ç”¨çš„åŸæ–‡ä¸º: " + inData);
    System.out.println("éªŒç­¾æ‰€ä½¿ç”¨çš„ç­¾åå¯†æ–‡ä¸º: " + signature);
    System.out.println("éªŒç­¾æ‰€ä½¿ç”¨çš„ç­¾åIDä¸º: " + signerID);

    VerifySignedDataReq verifySignedDataReq = new VerifySignedDataReq();
    verifySignedDataReq.setSignMethod(SGD_SM3_SM2);
    verifySignedDataReq.setType(Type);
    verifySignedDataReq.setCert(cert);
    // Typeä¸º1æ—¶certSNæ²¡ç”¨ï¼Œå°†ä½¿ç”¨cert
    verifySignedDataReq.setInData(inData);
    verifySignedDataReq.setInDataLen(inDataLen);
    // è¿™ä¸ªIDé»˜è®¤ä¸º"1234567812345678"
    verifySignedDataReq.setSignerID(signerID);
    verifySignedDataReq.setSignerIDLen(signerIDLen);
    verifySignedDataReq.setSignature(signature);
    verifySignedDataReq.setVerifyLevel(VerifyLevel);
    System.out.println(verifySignedDataReq);
    Integer verifySignedDataResult = SignVerifyUtil.verifySignedData(verifySignedDataReq);
    System.out.println(
        "å•åŒ…éªŒè¯æ•°å­—ç­¾åç»“æœï¼š" + Objects.equals(SVSRESPONSE_RESPVALUE_SUCCESS, verifySignedDataResult));
    return SignVerifyUtil.verifySignedData(verifySignedDataReq) == 0;
}
```

è€Œåçš„äºŒé‡è®¤è¯`doLogin(user.getUsername(), user.getPassword())`å°±æ˜¯æ•°æ®åº“å¯†ç è®¤è¯ï¼Œä¸å†èµ˜è¿°

### å¤–éƒ¨ Jar æ‰“åŒ…

IDEA éœ€è¦åœ¨`Project Structure`ä¸­æ·»åŠ `Modules`ï¼ŒåŒæ—¶åœ¨`pom.xml`ä¸­é…ç½®å¯¼å‡ºï¼Œå‚»å‘— olym

```xml
<dependencies>
<!--å¤–éƒ¨å¼•ç”¨ï¼Œæ‰“åŒ…æ—¶è¦åŒ…å«è¿›å»-->
    <dependency>
        <groupId>obymtect.ibc</groupId>
        <artifactId>sign</artifactId>
        <version>1.0.1</version>
        <scope>system</scope>
        <systemPath>${pom.basedir}/lib/olymibc.jar</systemPath>
    </dependency>
</dependencies>

<build>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <configuration>
                <!-- åœ¨æ‰“åŒ…æ—¶å°†å¼•ç”¨çš„å¤–éƒ¨jarå¼•å…¥åˆ°å½“å‰é¡¹ç›®åŒ…ä¸­	-->
                <includeSystemScope>true</includeSystemScope>
            </configuration>
        </plugin>
    </plugins>
</build>
```

## TOTP 2FA

GitHub çš„ 2FA æ–¹æ¡ˆ

### ä»€ä¹ˆæ˜¯ TOTPï¼Ÿ

> [åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com)](https://ruanyifeng.com/blog/2017/11/2fa-tutorial.html)

ä¸Šæ–‡ä¸­æœ‰æåˆ°ï¼šUSBKEY çš„èº«ä»½è®¤è¯ï¼Œå³å¯†ç  + æŸä»¶ä¸ªäººç‰©å“çš„æ–¹å¼ï¼Œå®‰å…¨ä½†ä¸æ–¹ä¾¿ï¼ˆç”¨æˆ·ä¸å¯èƒ½éšæ—¶æºå¸¦ UKEYï¼‰

ç›¸å¯¹è€Œè¨€ï¼Œæ‰‹æœºæ‰æ˜¯æœ€å¥½çš„æ›¿ä»£å“ã€‚å¯†ç  + æ‰‹æœºæ˜¯å½“ä¸‹æœ€ä½³çš„åŒå› ç´ è®¤è¯æ–¹æ¡ˆã€‚å›½å†…çš„å¾ˆå¤šç½‘ç«™è¦æ±‚ï¼Œç”¨æˆ·è¾“å…¥å¯†ç æ—¶ï¼Œè¿˜è¦æä¾›çŸ­æ¶ˆæ¯å‘é€çš„éªŒè¯ç ï¼Œä»¥è¯æ˜ç”¨æˆ·ç¡®å®æ‹¥æœ‰è¯¥æ‰‹æœºã€‚ä½†æ˜¯ï¼ŒçŸ­æ¶ˆæ¯æ˜¯ä¸å®‰å…¨çš„ï¼Œå®¹æ˜“è¢«æ‹¦æˆªå’Œä¼ªé€ ï¼ŒSIM å¡ä¹Ÿå¯ä»¥å…‹éš†ã€‚å·²ç»æœ‰[æ¡ˆä¾‹](http://media.people.com.cn/n/2014/0227/c40606-24477072.html)ï¼Œå…ˆä¼ªé€ èº«ä»½è¯ï¼Œå†ç”³è¯·ä¸€æ¨¡ä¸€æ ·çš„æ‰‹æœºå·ç ï¼ŒæŠŠé’±è½¬èµ°

å› æ­¤ï¼Œå®‰å…¨çš„åŒå› ç´ è®¤è¯ä¸æ˜¯å¯†ç  + çŸ­æ¶ˆæ¯ï¼Œè€Œæ˜¯ TOTPï¼ˆTime-based One-time Passwordï¼‰ï¼Œå®ƒæ˜¯å…¬è®¤çš„å¯é è§£å†³æ–¹æ¡ˆï¼Œå·²ç»å†™å…¥å›½é™…æ ‡å‡† [RFC6238](https://tools.ietf.org/html/rfc6238)

GitHub åœ¨ 23 å¹´å¯ç”¨äº† TOTP çš„ 2FA ç™»å½•ï¼ŒåŸç†å¦‚ä¸‹

1ï¸âƒ£ ç”¨æˆ·å’ŒæœåŠ¡å™¨åå•†å¥½ä¸€ä»½ç»Ÿä¸€çš„å¯†é’¥ key

2ï¸âƒ£ ç”¨æˆ·æœ¬åœ°é‡‡ç”¨ä¸€ä¸ªè®¡æ—¶ç¨‹åºï¼Œæ¯ t ç§’ç”Ÿæˆä¸€ä¸²å®šé•¿çš„çŸ­éªŒè¯ç ï¼ŒéªŒè¯ç çš„ç”Ÿæˆå…¬å¼å¦‚ä¸‹
$$
H_1 = Hash(time, key)
$$
å…¶ä¸­ï¼Œtime ä¸ºå½“å‰æ—¶é—´æˆ³ï¼Œkey ä¸ºåå•†å¥½çš„å¯†é’¥

3ï¸âƒ£ åœ¨ç™»é™†æ—¶ï¼Œç³»ç»Ÿè¦æ±‚ç”¨æˆ·è¾“å…¥å½“å‰çš„éªŒè¯ç  H1ï¼Œåç«¯æ¥æ”¶åˆ°è¯¥ç™»å½•è¯·æ±‚åï¼Œå°†åœ¨åç«¯æ ¹æ®å½“å‰æ—¶é—´å’Œç”¨æˆ·çš„å¯†é’¥ç”Ÿæˆä¸€ä»½éªŒè¯ç  H2

4ï¸âƒ£ å°†ç”¨æˆ·è¾“å…¥çš„ H1 å’Œåç«¯ç”Ÿæˆçš„ H2 ä½œæ¯”è¾ƒï¼Œè‹¥ä¸€è‡´åˆ™é€šè¿‡è®¤è¯ï¼Œå¦åˆ™æ‹’ç»

è€ƒè™‘åˆ°ç½‘ç»œå»¶è¿Ÿå’Œè®¡ç®—å»¶è¿Ÿï¼Œæ—¶é—´ time è¯¥å¦‚ä½•ç»Ÿä¸€å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œé€šè¿‡é™¤æ³•å‘ä¸‹å–æ•´çš„æ–¹å¼ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œ95 å’Œ 107 åœ¨é™¤ä»¥ 30 å¹¶ä¸”å‘ä¸‹å–æ•´æ—¶ï¼Œå¾—åˆ°çš„ç»“æœå‡ä¸º 3

åŒç†ï¼Œå¯¹äºæ¯ä¸ªæ—¶é—´æˆ³ï¼Œå‡å» 1970.1.1 æ—¥çš„åˆå§‹æ—¶é—´å¾—åˆ°çš„æ—¶é—´é—´éš”ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œè€Œåé™¤ä»¥ 30 å¹¶å–æ•´ï¼Œåˆ™åœ¨åŒä¸€ä¸ª 30s å†…èƒ½å¤Ÿå¾—åˆ°ç›¸åŒçš„ time

### è®¤è¯è¿‡ç¨‹

å…·ä½“è€Œè¨€

1ï¸âƒ£ æ¥å—ç”¨æˆ·ä¼ å‚ï¼ˆç”¨æˆ·åã€å¯†ç å“ˆå¸Œå’Œå“ˆå¸Œå€¼ï¼‰ï¼Œå…ˆä¸æ•°æ®åº“ä¸­å¯†ç  password è¿›è¡Œæ¯”å¯¹ï¼Œè‹¥ä¸ä¸€è‡´åˆ™è¿”å›çŠ¶æ€ 2ï¼ˆå¯†ç é”™è¯¯ï¼‰ï¼Œè‹¥ä¸€è‡´ç»§ç»­ç¬¬äºŒå› ç´ è®¤è¯

2ï¸âƒ£ é€šè¿‡ username è¯»æ•°æ®åº“å–å‡ºç§é’¥ Keyï¼Œå¯¹ä»¥ä¸‹æ•°æ®è¿›è¡Œç­¾å
$$
TC = (T_{now}-T_{1970})/30
$$
å…¶ä¸­ï¼ŒT æŒ‡æ—¶é—´æˆ³ï¼Œ30 æ˜¯ç™»å½•ç çš„åˆ·æ–°é¢‘ç‡ï¼Œé€šè¿‡è¯¥å…¬å¼å°†å¾—åˆ° Hash' = H(Key, TC) 

3ï¸âƒ£ å°†ä¼ å…¥çš„ Hash ä¸ Hash' æ¯”å¯¹ï¼Œè‹¥ä¸ä¸€æ ·ï¼Œåˆ™è¿”å›çŠ¶æ€ 3ï¼ˆå“ˆå¸Œé”™è¯¯ï¼‰ï¼Œè‹¥ä¸€æ ·ï¼Œåˆ™è¿”å›çŠ¶æ€ 1ï¼ˆè®¤è¯æˆåŠŸï¼‰

è¿™é‡Œçš„ TC è®¡ç®—æ˜¯ TOTP ç®—æ³•çš„ç²¾é«“ï¼šæœ¬åœ°è®¡ç®— TC åï¼Œå°†è¯·æ±‚æ‰“åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ä¼šç«‹é©¬è®¡ç®—å½“å‰æ—¶é—´æˆ³å¯¹åº”çš„ TC'ï¼Œç”±äºå‘ä¸‹å–æ•´çš„å…³ç³»ï¼Œåœ¨ 30s å†…ï¼Œæœ¬åœ°ç”Ÿæˆçš„ TC å’ŒæœåŠ¡å™¨çš„ TC' å°†ä¼šä¿æŒä¸€è‡´ï¼Œäºæ˜¯æœ€åç”Ÿæˆçš„å“ˆå¸Œå€¼å°†ä¼šä¸€è‡´ï¼ˆåœ¨è¯ä¹¦ä¸€è‡´çš„å‰æä¸‹ï¼‰

å½“ç„¶æœ¬åœ°å’ŒæœåŠ¡å™¨çš„æ—¶é—´éœ€è¦æ˜¯åŒæ­¥çš„ï¼ŒåŒæ—¶ä¼šæœ‰å°‘è®¸çš„ç½‘ç»œå»¶è¿Ÿ

### Demo è®¾è®¡

1ï¸âƒ£ æ•°æ®åº“è®¾è®¡

~~æ•°æ®è¡¨è®¾è®¡ï¼š`user`~~

| å­—æ®µå                  | ç±»å‹    | è¯´æ˜     |
| ----------------------- | ------- | -------- |
| usernameï¼ˆprimary keyï¼‰ | varchar | ç”¨æˆ·å   |
| password                | varchar | ç”¨æˆ·å¯†ç  |
| key                     | varchar | ç”¨æˆ·ç§é’¥ |

èƒ½ç”¨ redis å­˜å—ï¼Œæˆ‘åœ¨æƒ³ï¼Œå°±ä¸ç”¨å»ºè¡¨äº†ï¼Œç”¨ä¸¤ä¸ª HMap å­˜

```
db:
	Password:
		username1: pwd1
		username2: pwd2
		...
	Key:
		username1: key1
		username2: key2
		...
```

2ï¸âƒ£ åç«¯æ¥å£è®¾è®¡

åç«¯éœ€è¦å®ç°ä¸¤ä¸ªæ¥å£ï¼šæ³¨å†Œå’Œç™»å½•ï¼Œé€»è¾‘è¾ƒä¸ºç®€å•

- æ³¨å†Œæ—¶åˆ›å»ºç”¨æˆ·ç§é’¥ï¼ŒæœåŠ¡å™¨æ•°æ®åº“éœ€è¦ä¸ç”¨æˆ·æœ¬åœ°ç»Ÿä¸€
- ç™»å½•æ—¶é€šè¿‡æ¯”å¯¹ç”¨æˆ·æœ¬åœ°å“ˆå¸Œå€¼ï¼ˆé€šè¿‡æœ¬åœ°æ—¶é—´æˆ³å’Œç§é’¥ç”Ÿæˆï¼‰ä¸æœåŠ¡å™¨å“ˆå¸Œå€¼ï¼ˆé€šè¿‡æœåŠ¡å™¨æ—¶é—´å’Œæ•°æ®åº“ä¸­ç”¨æˆ·ç§é’¥ç”Ÿæˆï¼‰è¿›è¡Œè®¤è¯

æ³¨å†Œæ¥å£ï¼šç”Ÿæˆç§é’¥è¿”å›ç»™ç”¨æˆ·ï¼ŒåŒæ—¶å°†ç”¨æˆ·åã€å¯†ç å’Œè¯ä¹¦ä¿¡æ¯å†™å…¥æ•°æ®åº“è¡¨

æ¥å£è¯´æ˜

- URLï¼š`/register`
- Methodï¼š`Post`

è¯·æ±‚å‚æ•°

| å‚æ•°     | ç±»å‹   | ç¤ºä¾‹        |
| -------- | ------ | ----------- |
| username | String | "northboat" |
| password | String | "123456"    |

è¿”å›ç»“æœï¼š`res`

| çŠ¶æ€ç ï¼ˆcodeï¼‰ | ä¿¡æ¯ï¼ˆmessageï¼‰ | æ•°æ®ï¼ˆdataï¼‰               |
| -------------- | --------------- | -------------------------- |
| `200`          | `"æˆåŠŸ"`        | `{"key":"ç§é’¥å­—ç¬¦ä¸²"}`     |
| `500`          | `"æœåŠ¡å™¨é”™è¯¯"`  | `{"error":"å…·ä½“é”™è¯¯ä¿¡æ¯"}` |

ç™»å½•æ¥å£ï¼šæ¥æ”¶ç”¨æˆ·çš„ç­¾åç»“æœï¼Œå†é€šè¿‡ç”¨æˆ· username å–å‡ºæ•°æ®åº“ä¸­è¯ä¹¦å¯¹å½“å‰æ—¶é—´æˆ³è¿›è¡Œç­¾åå¹¶ä¸å®¢æˆ·ç«¯ç»“æœæ¯”å¯¹ï¼Œè¿›è¡Œä¸€é‡è®¤è¯ï¼Œè€Œåå¯¹å¯†ç è¿›è¡ŒäºŒé‡è®¤è¯

æ¥å£è¯´æ˜

- URLï¼š`/login`
- Methodï¼š`Post`

è¯·æ±‚å‚æ•°

| å‚æ•°     | ç±»å‹   | ç¤ºä¾‹            |
| -------- | ------ | --------------- |
| username | String | "northboat"     |
| password | String | "123456"        |
| key      | String | "MII56DJKLA..." |
| hash     | String | "652156"        |

è¿”å›ç»“æœï¼š`res`

| çŠ¶æ€ç ï¼ˆcodeï¼‰ | ä¿¡æ¯ï¼ˆmessageï¼‰ | æ•°æ®ï¼ˆdataï¼‰               |
| -------------- | --------------- | -------------------------- |
| `200`          | `"æˆåŠŸ"`        | `null`                     |
| `200`          | `"å¤±è´¥"`        | `{"error":"å…·ä½“é”™è¯¯ä¿¡æ¯"}` |
| `500`          | `"æœåŠ¡å™¨é”™è¯¯"`  | `{"error":"å…·ä½“é”™è¯¯ä¿¡æ¯"}` |

3ï¸âƒ£ å‰ç«¯è®¾è®¡

æ³¨å†Œæ—¶

1. å‘é€è¡¨å•è¯·æ±‚æœåŠ¡å™¨`register`æ¥å£ï¼Œè·å–ç§é’¥
2. å°†è·å–åˆ°çš„ç§é’¥åœ¨å®¢æˆ·ç«¯è¿›è¡Œæœ¬åœ° I/Oï¼Œå†™ä½œæ–‡ä»¶`2fa.cer`

ç™»å½•æ—¶

1. æœ¬åœ°è¯»å–`2fa.cer`ï¼Œè·å¾—ç§é’¥å­—ç¬¦ä¸²
2. é€šè¿‡ç§é’¥å’Œå½“å‰æ—¶é—´æˆ³ï¼Œç”Ÿæˆå“ˆå¸Œå€¼
3. å°†ç™»å½•è¡¨å•è¿åŒå“ˆå¸Œå€¼è¯·æ±‚`/login`æ¥å£

å‚è€ƒï¼š[websocket ä¹‹å››ï¼šWebSocket çš„é‰´æƒæˆæƒæ–¹æ¡ˆ - duanxz - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/duanxz/p/5440716.html)
